<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Control Room â€” Adrem Model Academy</title>
<script src="supabase.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --amber:#fbbf24; --amber-deep:#d97706; --amber-light:#fde68a;
    --amber-bg:rgba(251,191,36,0.1); --amber-b:rgba(251,191,36,0.25);
    --purple:#7c52e8; --purple-deep:#5236c7; --purple-light:#b8a4f7;
    --purple-bg:rgba(124,82,232,0.1); --purple-b:rgba(124,82,232,0.25);
    --rose:#e8527a; --rose-deep:#c73660; --rose-light:#f7a8bf;
    --rose-bg:rgba(232,82,122,0.1); --rose-b:rgba(232,82,122,0.25);
    --charcoal:#1a1626; --charcoal-2:#231d33; --muted:#9c8fa3; --white:#ffffff;
    --glass:rgba(255,255,255,0.06); --glass-b:rgba(255,255,255,0.11);
    --green:#4ade80; --green-bg:rgba(74,222,128,0.1); --green-b:rgba(74,222,128,0.25);
    --red:#f87171; --red-bg:rgba(248,113,113,0.1); --red-b:rgba(248,113,113,0.25);
    --blue:#60a5fa; --blue-bg:rgba(96,165,250,0.1); --blue-b:rgba(96,165,250,0.25);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  html{scroll-behavior:smooth;}
  body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white);min-height:100vh;display:flex;}

  /* SIDEBAR */
  .sidebar{width:250px;min-width:250px;background:var(--charcoal-2);border-right:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;padding:24px 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform 0.3s;overflow-y:auto;}
  .sidebar-logo{display:flex;align-items:center;gap:12px;padding:0 20px 24px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:20px;}
  .s-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--amber),var(--amber-deep));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
  .s-logo-text{font-family:'Playfair Display',serif;font-size:0.82rem;font-weight:700;line-height:1.3;}
  .s-logo-text span{display:block;font-family:'DM Sans',sans-serif;font-size:0.62rem;color:var(--amber-light);letter-spacing:1.5px;text-transform:uppercase;font-weight:400;}
  .nav-section{padding:0 12px;margin-bottom:6px;}
  .nav-label{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;padding:0 10px;margin-bottom:5px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;font-weight:500;transition:all 0.2s;cursor:pointer;border:none;background:none;width:100%;text-align:left;}
  .nav-item:hover{background:rgba(255,255,255,0.05);color:var(--white);}
  .nav-item.active{background:rgba(251,191,36,0.15);color:var(--amber-light);}
  .nav-item .ni{font-size:0.95rem;width:18px;text-align:center;}
  .sidebar-bottom{margin-top:auto;padding:16px 12px 0;border-top:1px solid rgba(255,255,255,0.06);}
  .logout-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;text-decoration:none;transition:all 0.2s;cursor:pointer;}
  .logout-btn:hover{color:var(--red);background:var(--red-bg);}

  /* MAIN */
  .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-height:100vh;}
  .topbar{position:sticky;top:0;z-index:40;background:rgba(26,22,38,0.97);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06);padding:14px 32px;display:flex;align-items:center;justify-content:space-between;}
  .topbar-left h2{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;}
  .topbar-left p{font-size:0.75rem;color:var(--muted);margin-top:2px;}
  .topbar-right{display:flex;align-items:center;gap:10px;}
  .admin-badge{background:var(--amber-bg);border:1px solid var(--amber-b);border-radius:50px;padding:5px 14px;font-size:0.75rem;color:var(--amber-light);}
  .admin-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--amber),var(--amber-deep));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.82rem;font-weight:700;color:#1a1626;cursor:pointer;}
  .content{padding:28px 32px;flex:1;}

  /* REUSABLES */
  .stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
  .stat-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:16px;padding:18px;backdrop-filter:blur(8px);transition:all 0.3s;}
  .stat-card:hover{transform:translateY(-3px);}
  .stat-card .sc-icon{font-size:1.4rem;margin-bottom:10px;}
  .stat-card .sc-val{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:3px;}
  .stat-card .sc-lbl{font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
  .stat-card.amber{border-color:var(--amber-b);background:var(--amber-bg);} .stat-card.amber .sc-val{color:var(--amber);}
  .stat-card.green{border-color:var(--green-b);background:var(--green-bg);} .stat-card.green .sc-val{color:var(--green);}
  .stat-card.purple{border-color:var(--purple-b);background:var(--purple-bg);} .stat-card.purple .sc-val{color:var(--purple-light);}
  .stat-card.rose{border-color:var(--rose-b);background:var(--rose-bg);} .stat-card.rose .sc-val{color:var(--rose-light);}
  .stat-card.blue{border-color:var(--blue-b);background:var(--blue-bg);} .stat-card.blue .sc-val{color:var(--blue);}
  .stat-card.red{border-color:var(--red-b);background:var(--red-bg);} .stat-card.red .sc-val{color:var(--red);}

  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
  .three-col{display:grid;grid-template-columns:1fr 1fr 1fr;gap:18px;margin-bottom:20px;}
  .section-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;backdrop-filter:blur(8px);}
  .section-card-full{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;backdrop-filter:blur(8px);margin-bottom:20px;}
  .sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
  .sc-header h3{font-family:'Playfair Display',serif;font-size:0.95rem;font-weight:700;}
  .sc-header span{font-size:0.72rem;color:var(--muted);}

  .btn{padding:8px 18px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
  .btn:hover{transform:translateY(-2px);filter:brightness(1.1);}
  .btn-amber{background:linear-gradient(135deg,var(--amber),var(--amber-deep));color:#1a1626;box-shadow:0 4px 14px rgba(251,191,36,0.35);}
  .btn-purple{background:linear-gradient(135deg,var(--purple),var(--purple-deep));color:white;box-shadow:0 4px 14px rgba(124,82,232,0.35);}
  .btn-rose{background:linear-gradient(135deg,var(--rose),var(--rose-deep));color:white;box-shadow:0 4px 14px rgba(232,82,122,0.35);}
  .btn-green{background:linear-gradient(135deg,var(--green),#22c55e);color:#1a1626;box-shadow:0 4px 14px rgba(74,222,128,0.35);}
  .btn-red{background:linear-gradient(135deg,var(--red),#ef4444);color:white;box-shadow:0 4px 14px rgba(248,113,113,0.35);}
  .btn-sm{padding:5px 12px;font-size:0.75rem;border-radius:8px;}

  .data-table{width:100%;border-collapse:collapse;}
  .data-table th{font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:left;padding:0 12px 10px;font-weight:500;}
  .data-table td{padding:11px 12px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.83rem;vertical-align:middle;}
  .data-table tr:hover td{background:rgba(255,255,255,0.03);}
  .actions{display:flex;gap:6px;}

  .badge{display:inline-block;padding:3px 10px;border-radius:50px;font-size:0.7rem;font-weight:600;}
  .badge-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-b);}
  .badge-amber{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-b);}
  .badge-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-b);}
  .badge-purple{background:var(--purple-bg);color:var(--purple-light);border:1px solid var(--purple-b);}
  .badge-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-b);}

  .field{margin-bottom:14px;}
  .field label{display:block;font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
  .field input,.field select,.field textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.88rem;outline:none;transition:all 0.3s;}
  .field input:focus,.field select:focus,.field textarea:focus{border-color:var(--amber);background:rgba(251,191,36,0.06);}
  .field select option{background:var(--charcoal-2);}
  .field textarea{resize:vertical;min-height:80px;}
  .form-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px;}

  .perf-item{margin-bottom:12px;}
  .perf-top{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.8rem;}
  .perf-top strong{color:var(--amber-light);}
  .perf-track{width:100%;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;}
  .perf-fill{height:100%;border-radius:3px;}
  .perf-fill.amber{background:linear-gradient(90deg,var(--amber),var(--amber-deep));}
  .perf-fill.green{background:linear-gradient(90deg,#4ade80,#22c55e);}
  .perf-fill.purple{background:linear-gradient(90deg,var(--purple),var(--purple-deep));}
  .perf-fill.red{background:linear-gradient(90deg,var(--red),#ef4444);}
  .perf-fill.blue{background:linear-gradient(90deg,var(--blue),#3b82f6);}

  .activity-list{display:flex;flex-direction:column;gap:10px;}
  .activity-item{display:flex;gap:12px;padding:12px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;}
  .act-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px;}
  .act-text{flex:1;}
  .act-text strong{display:block;font-size:0.83rem;margin-bottom:2px;}
  .act-text span{font-size:0.75rem;color:var(--muted);}
  .act-time{font-size:0.7rem;color:var(--muted);white-space:nowrap;}

  .notice-list{display:flex;flex-direction:column;gap:10px;margin-bottom:16px;}
  .notice-item{display:flex;align-items:flex-start;gap:12px;padding:12px 14px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:12px;}
  .notice-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:6px;}
  .notice-dot.urgent{background:var(--red);}
  .notice-dot.normal{background:var(--amber-light);}
  .notice-dot.info{background:var(--blue);}
  .notice-text strong{display:block;font-size:0.83rem;margin-bottom:3px;}
  .notice-text span{font-size:0.75rem;color:var(--muted);line-height:1.5;}

  .class-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;}
  .class-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;padding:18px;transition:all 0.3s;cursor:pointer;}
  .class-card:hover{transform:translateY(-3px);border-color:var(--amber-b);background:var(--amber-bg);}
  .class-card h4{font-size:0.95rem;font-weight:700;margin-bottom:6px;}
  .class-card .cc-meta{font-size:0.75rem;color:var(--muted);margin-bottom:4px;}
  .class-card .cc-avg{font-family:'Playfair Display',serif;font-size:1.2rem;color:var(--amber);font-weight:700;}

  .score-input{width:55px;padding:5px 6px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:7px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;text-align:center;outline:none;transition:all 0.3s;}
  .score-input:focus{border-color:var(--amber);background:rgba(251,191,36,0.08);}

  /* â”€â”€ PLAIN BROADSHEET â”€â”€ */
  .broadsheet-table{width:100%;border-collapse:collapse;font-size:0.78rem;}
  .broadsheet-table th{background:rgba(251,191,36,0.12);color:var(--amber-light);font-size:0.65rem;text-transform:uppercase;letter-spacing:1px;padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,0.08);white-space:nowrap;}
  .broadsheet-table th.name-col{text-align:left;min-width:160px;}
  .broadsheet-table td{padding:9px 8px;border:1px solid rgba(255,255,255,0.05);text-align:center;vertical-align:middle;}
  .broadsheet-table td.name-col{text-align:left;font-weight:500;white-space:nowrap;}
  .broadsheet-table td.pos-col{font-weight:700;color:var(--amber-light);}
  .broadsheet-table tr:hover td{background:rgba(255,255,255,0.03);}
  .broadsheet-table tfoot td{background:rgba(251,191,36,0.08);color:var(--amber-light);font-weight:700;border-top:2px solid rgba(251,191,36,0.25);}

  /* Grade colours */
  .g-A{color:var(--green);font-weight:700;} .g-P{color:var(--amber);font-weight:700;} .g-F{color:var(--red);font-weight:700;}
  .g-A1{color:var(--green);font-weight:700;} .g-B2{color:#34d399;font-weight:700;} .g-B3{color:#6ee7b7;font-weight:700;}
  .g-C4{color:var(--blue);font-weight:700;} .g-C5{color:#93c5fd;font-weight:700;} .g-C6{color:var(--amber);font-weight:700;}
  .g-D7{color:var(--amber-light);font-weight:700;} .g-E8{color:var(--rose-light);font-weight:700;} .g-F9{color:var(--red);font-weight:700;}

  /* Grade key pills */
  .grade-key{display:flex;flex-wrap:wrap;gap:8px;margin-bottom:14px;}
  .gk-item{display:flex;align-items:center;gap:6px;background:var(--glass);border:1px solid var(--glass-b);border-radius:8px;padding:5px 10px;font-size:0.72rem;}

  /* â”€â”€ ANALYSIS CHARTS â”€â”€ */
  .bar-chart{display:flex;align-items:flex-end;gap:8px;height:160px;padding-bottom:24px;position:relative;}
  .bar-chart::before{content:'';position:absolute;left:0;right:0;bottom:24px;top:0;background:repeating-linear-gradient(to top,rgba(255,255,255,0.03) 0px,rgba(255,255,255,0.03) 1px,transparent 1px,transparent 20%);}
  .bar-group{flex:1;display:flex;gap:3px;align-items:flex-end;position:relative;}
  .bar{border-radius:4px 4px 0 0;min-height:4px;transition:height 1s ease;position:relative;cursor:pointer;}
  .bar:hover::after{content:attr(data-val);position:absolute;top:-22px;left:50%;transform:translateX(-50%);background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.15);padding:2px 6px;border-radius:6px;font-size:0.68rem;white-space:nowrap;}
  .bar.ca{background:linear-gradient(to top,var(--purple),rgba(124,82,232,0.5));flex:1;}
  .bar.exam{background:linear-gradient(to top,var(--rose),rgba(232,82,122,0.5));flex:1;}
  .bar-label{position:absolute;bottom:-20px;left:50%;transform:translateX(-50%);font-size:0.6rem;color:var(--muted);white-space:nowrap;text-align:center;width:60px;}
  .chart-legend{display:flex;gap:16px;justify-content:center;margin-top:8px;}
  .legend-item{display:flex;align-items:center;gap:6px;font-size:0.75rem;color:var(--muted);}
  .legend-dot{width:10px;height:10px;border-radius:3px;}

  .donut-wrap{display:flex;align-items:center;gap:24px;}
  .donut-labels{display:flex;flex-direction:column;gap:8px;flex:1;}
  .donut-label{display:flex;align-items:center;gap:8px;font-size:0.78rem;}
  .donut-dot{width:10px;height:10px;border-radius:50%;flex-shrink:0;}
  .donut-label span{color:var(--muted);}
  .donut-label strong{margin-left:auto;}

  .h-bar-item{margin-bottom:12px;}
  .h-bar-top{display:flex;justify-content:space-between;font-size:0.8rem;margin-bottom:5px;}
  .h-bar-top strong{color:var(--white);}
  .h-bar-top span{color:var(--muted);}
  .h-bar-track{width:100%;height:10px;background:rgba(255,255,255,0.06);border-radius:5px;overflow:hidden;position:relative;}
  .h-bar-ca{position:absolute;top:0;left:0;height:100%;border-radius:5px 0 0 5px;background:linear-gradient(90deg,var(--purple),rgba(124,82,232,0.7));}
  .h-bar-exam{position:absolute;top:0;height:100%;background:linear-gradient(90deg,var(--rose),rgba(232,82,122,0.7));}

  /* â”€â”€ PSYCHOMOTOR â”€â”€ */
  .psycho-table{width:100%;border-collapse:collapse;}
  .psycho-table th{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:0 10px 10px;text-align:center;font-weight:500;}
  .psycho-table th:first-child{text-align:left;}
  .psycho-table td{padding:10px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.82rem;text-align:center;}
  .psycho-table td:first-child{text-align:left;font-weight:500;}
  .psycho-select{padding:5px 8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.78rem;outline:none;cursor:pointer;}
  .psycho-select option{background:var(--charcoal-2);}

  /* Psychomotor status card */
  .psycho-status-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px;margin-bottom:20px;}
  .psycho-status-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:14px;padding:16px;}
  .psycho-status-card h4{font-size:0.88rem;font-weight:600;margin-bottom:4px;}
  .psycho-status-card p{font-size:0.75rem;color:var(--muted);margin-bottom:10px;}
  .psycho-status-card .status-row{display:flex;align-items:center;justify-content:space-between;}

  /* MODAL */
  .modal{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);padding:20px;}
  .modal.show{display:flex;}
  .modal-card{background:#231d33;border:1px solid rgba(255,255,255,0.12);border-radius:22px;padding:36px;width:100%;max-width:520px;position:relative;animation:popIn 0.3s ease both;max-height:90vh;overflow-y:auto;}
  @keyframes popIn{from{opacity:0;transform:scale(0.92)}to{opacity:1;transform:scale(1)}}
  .modal-close{position:absolute;top:14px;right:18px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;}
  .modal-close:hover{color:var(--white);}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.2rem;margin-bottom:6px;}
  .modal-sub{font-size:0.82rem;color:var(--muted);margin-bottom:22px;}

  .menu-toggle{display:none;position:fixed;top:14px;left:14px;z-index:100;background:var(--amber);border:none;border-radius:10px;padding:7px 11px;cursor:pointer;font-size:1rem;color:#1a1626;}
  .dash-footer{padding:18px 32px;border-top:1px solid rgba(255,255,255,0.06);font-size:0.72rem;color:var(--muted);text-align:center;}

  /* PRINT */
  @media print {
    body{background:white!important;color:#1a1626!important;display:block;}
    .sidebar,.topbar,.menu-toggle,.btn,select,input,.no-print{display:none!important;}
    .main{margin-left:0!important;}
    .content{padding:0!important;}
    .print-header{display:block!important;}
    .section-card-full,.section-card{background:white!important;border:1px solid #ddd!important;color:#1a1626!important;}
    .broadsheet-table th{background:#fff3cd!important;color:#92400e!important;-webkit-print-color-adjust:exact;print-color-adjust:exact;}
    .broadsheet-table td{color:#1a1626!important;border-color:#eee!important;}
    .broadsheet-table tfoot td{background:#fffbeb!important;}
    .g-A{color:#16a34a!important;} .g-P{color:#d97706!important;} .g-F{color:#dc2626!important;}
    .g-A1{color:#16a34a!important;} .g-B2{color:#059669!important;} .g-C4{color:#2563eb!important;}
    .g-D7{color:#d97706!important;} .g-F9{color:#dc2626!important;}
    *{box-shadow:none!important;}
  }

  @media(max-width:1200px){.three-col{grid-template-columns:1fr 1fr}}
  @media(max-width:1000px){.stat-row{grid-template-columns:repeat(2,1fr)}.two-col,.three-col{grid-template-columns:1fr}}
  @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.menu-toggle{display:block}.topbar{padding:12px 16px 12px 56px}.content{padding:18px}.form-grid{grid-template-columns:1fr}}
  @media(max-width:480px){.stat-row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>

<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="s-logo-icon">ğŸ”</div>
    <div class="s-logo-text">Adrem Model Academy<span>Admin Control Room</span></div>
  </div>
  <div class="nav-section">
    <div class="nav-label">Overview</div>
    <button class="nav-item active" onclick="showSection('dashboard',this)"><span class="ni">ğŸ“Š</span> Dashboard</button>
    <button class="nav-item" onclick="showSection('activity',this)"><span class="ni">ğŸ•</span> Activity Log</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">People</div>
    <button class="nav-item" onclick="showSection('students',this)"><span class="ni">ğŸ’</span> Manage Students</button>
    <button class="nav-item" onclick="showSection('staff',this)"><span class="ni">ğŸ‘©â€ğŸ«</span> Manage Staff</button>
    <button class="nav-item" onclick="showSection('classes',this)"><span class="ni">ğŸ«</span> Classes & Arms</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">Academics</div>
    <button class="nav-item" onclick="showSection('scores',this)"><span class="ni">âœï¸</span> Scores & Results</button>
    <button class="nav-item" onclick="showSection('publish',this)"><span class="ni">ğŸ“¤</span> Publish Results</button>
    <button class="nav-item" onclick="showSection('subjects',this)"><span class="ni">ğŸ“š</span> Subjects</button>
    <button class="nav-item" onclick="showSection('broadsheet',this)"><span class="ni">ğŸ“‹</span> Broadsheet</button>
    <button class="nav-item" onclick="showSection('analysis',this)"><span class="ni">ğŸ“ˆ</span> Student Analysis</button>
    <button class="nav-item" onclick="showSection('psychomotor',this)"><span class="ni">ğŸ§ </span> Psychomotor</button>
    <button class="nav-item" onclick="showSection('grading',this)"><span class="ni">ğŸ…</span> Grading System</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">Communication</div>
    <button class="nav-item" onclick="showSection('notices',this)"><span class="ni">ğŸ“¢</span> Notice Board</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">Settings</div>
    <button class="nav-item" onclick="showSection('settings',this)"><span class="ni">âš™ï¸</span> Portal Settings</button>
    <button class="nav-item" onclick="showSection('reset',this)"><span class="ni">ğŸ”‘</span> Reset Passwords</button>
  </div>
  <div class="sidebar-bottom">
    <button class="logout-btn" onclick="DB.logout()">ğŸšª Log Out</button>
  </div>
</aside>

<!-- MAIN -->
<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h2 id="page-title">Admin Control Room</h2>
      <p>2024/2025 Session â€” First Term</p>
    </div>
    <div class="topbar-right">
      <div class="admin-badge">ğŸ” Administrator</div>
      <div class="admin-avatar">AD</div>
    </div>
  </div>

  <div class="content">

    <!-- â•â• DASHBOARD â•â• -->
    <div id="section-dashboard">
      <div class="stat-row">
        <div class="stat-card amber"><div class="sc-icon">ğŸ’</div><div class="sc-val">247</div><div class="sc-lbl">Total Students</div></div>
        <div class="stat-card purple"><div class="sc-icon">ğŸ‘©â€ğŸ«</div><div class="sc-val">18</div><div class="sc-lbl">Total Staff</div></div>
        <div class="stat-card green"><div class="sc-icon">ğŸ«</div><div class="sc-val">12</div><div class="sc-lbl">Active Classes</div></div>
        <div class="stat-card blue"><div class="sc-icon">ğŸ“š</div><div class="sc-val">16</div><div class="sc-lbl">Subjects Offered</div></div>
      </div>
      <div class="stat-row">
        <div class="stat-card green"><div class="sc-icon">âœ…</div><div class="sc-val">68%</div><div class="sc-lbl">Scores Entered</div></div>
        <div class="stat-card amber"><div class="sc-icon">â³</div><div class="sc-val">32%</div><div class="sc-lbl">Scores Pending</div></div>
        <div class="stat-card rose"><div class="sc-icon">ğŸ“Š</div><div class="sc-val">72.4%</div><div class="sc-lbl">School Average</div></div>
        <div class="stat-card red"><div class="sc-icon">ğŸ“¤</div><div class="sc-val">0</div><div class="sc-lbl">Results Published</div></div>
      </div>
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ« Class Performance Overview</h3><span>Term average</span></div>
          <div class="perf-item"><div class="perf-top"><span>JSS 1A</span><strong>74%</strong></div><div class="perf-track"><div class="perf-fill green" style="width:74%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>JSS 1B</span><strong>68%</strong></div><div class="perf-track"><div class="perf-fill amber" style="width:68%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>JSS 2A</span><strong>72%</strong></div><div class="perf-track"><div class="perf-fill green" style="width:72%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>JSS 2B</span><strong>65%</strong></div><div class="perf-track"><div class="perf-fill amber" style="width:65%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>JSS 3A</span><strong>70%</strong></div><div class="perf-track"><div class="perf-fill amber" style="width:70%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>SS 1A</span><strong>69%</strong></div><div class="perf-track"><div class="perf-fill purple" style="width:69%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>SS 2A</span><strong>66%</strong></div><div class="perf-track"><div class="perf-fill purple" style="width:66%"></div></div></div>
          <div class="perf-item"><div class="perf-top"><span>SS 3A</span><strong>71%</strong></div><div class="perf-track"><div class="perf-fill green" style="width:71%"></div></div></div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ• Recent Activity</h3><span>Portal-wide</span></div>
          <div class="activity-list">
            <div class="activity-item"><div class="act-icon">âœï¸</div><div class="act-text"><strong>Mrs. Okonkwo entered Maths scores for JSS 2A</strong><span>32 students Â· All submitted</span></div><div class="act-time">2h ago</div></div>
            <div class="activity-item"><div class="act-icon">ğŸ’</div><div class="act-text"><strong>New student registered â€” Taiwo Emmanuel</strong><span>JSS 1A Â· AMA/2025/248</span></div><div class="act-time">5h ago</div></div>
            <div class="activity-item"><div class="act-icon">ğŸ”‘</div><div class="act-text"><strong>Password reset â€” Adeyemi Aisha</strong><span>SMS sent to registered number</span></div><div class="act-time">Yesterday</div></div>
            <div class="activity-item"><div class="act-icon">ğŸ§ </div><div class="act-text"><strong>Psychomotor submitted â€” JSS 2A</strong><span>Mrs. Okonkwo Â· Awaiting Admin approval</span></div><div class="act-time">Yesterday</div></div>
            <div class="activity-item"><div class="act-icon">ğŸ“¢</div><div class="act-text"><strong>Notice sent to all staff</strong><span>Score entry deadline reminder</span></div><div class="act-time">2 days ago</div></div>
          </div>
        </div>
      </div>
      <div class="section-card-full">
        <div class="sc-header"><h3>âœï¸ Score Entry Status â€” All Staff</h3><span>First Term 2024/2025</span></div>
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead><tr><th>Staff Name</th><th>Subject(s)</th><th>Classes</th><th>CA Entered</th><th>Exam Entered</th><th>Psychomotor</th><th>Status</th><th>Action</th></tr></thead>
            <tbody>
              <tr><td>Mrs. Okonkwo</td><td>Maths, Further Maths</td><td>JSS2A, JSS2B</td><td style="color:var(--green)">âœ…</td><td style="color:var(--green)">âœ…</td><td><span class="badge badge-amber">â³ Awaiting Approval</span></td><td><span class="badge badge-green">Complete</span></td><td><button class="btn btn-sm btn-green" onclick="showToast('Psychomotor approved for JSS 2A!')">Approve</button></td></tr>
              <tr><td>Mr. Adeleke</td><td>English Language</td><td>JSS1A, JSS1B</td><td style="color:var(--green)">âœ…</td><td style="color:var(--amber)">â³</td><td><span class="badge badge-red">âŒ Not Submitted</span></td><td><span class="badge badge-amber">Partial</span></td><td><button class="btn btn-sm btn-amber" onclick="showToast('Reminder sent!')">Remind</button></td></tr>
              <tr><td>Mr. Ibrahim</td><td>Social Studies</td><td>JSS1A, JSS2B</td><td style="color:var(--red)">âŒ</td><td style="color:var(--red)">âŒ</td><td><span class="badge badge-red">âŒ Not Submitted</span></td><td><span class="badge badge-red">Not Started</span></td><td><button class="btn btn-sm btn-red" onclick="showToast('Reminder sent!')">Remind</button></td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• BROADSHEET â€” PLAIN CLEAN VERSION â•â• -->
    <div id="section-broadsheet" style="display:none;">
      <div class="print-header" style="display:none;text-align:center;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #d97706;">
        <h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;color:#1a1626;">Adrem Model Academy</h2>
        <p style="color:#6b7280;font-size:0.82rem;">Apomu, Osun State Â· Tel: +234 701 518 2166</p>
        <h3 id="bs-print-title" style="font-family:'Playfair Display',serif;margin-top:10px;color:#d97706;font-size:1rem;">CLASS BROADSHEET â€” FIRST TERM 2024/2025</h3>
      </div>
      <div class="section-card-full">
        <div class="sc-header">
          <h3>ğŸ“‹ Class Broadsheet</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;" class="no-print">
            <select id="bs-class" onchange="renderBroadsheet()" style="padding:7px 12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:9px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;">
              <option value="">Loading classes...</option>
            </select>
            <button class="btn btn-amber" onclick="printBroadsheet()">ğŸ–¨ï¸ Print Broadsheet</button>
          </div>
        </div>
        <div id="bs-grade-key" class="grade-key"></div>
        <div style="overflow-x:auto;">
          <table class="broadsheet-table" id="broadsheet-table"></table>
        </div>
        <div style="margin-top:12px;font-size:0.75rem;color:var(--muted);">
          Position is calculated based on total score across all subjects. Scores shown as raw totals (CA + Exam).
        </div>
      </div>
    </div>

    <!-- â•â• ANALYSIS â•â• -->
    <div id="section-analysis" style="display:none;">
      <div class="sc-header" style="margin-bottom:16px;">
        <h3>ğŸ“ˆ Student Performance Analysis</h3>
        <select id="an-class" style="padding:7px 12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:9px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;">
          <option>JSS 2A</option><option>JSS 1A</option><option>SS 1A</option>
        </select>
      </div>
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“Š CA vs Exam Score â€” Per Subject</h3><span>JSS 2A class average</span></div>
          <div style="position:relative;width:100%;">
            <div class="bar-chart" id="ca-exam-chart"></div>
          </div>
          <div class="chart-legend">
            <div class="legend-item"><div class="legend-dot" style="background:var(--purple);"></div>CA Score (avg %)</div>
            <div class="legend-item"><div class="legend-dot" style="background:var(--rose);"></div>Exam Score (avg %)</div>
          </div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ… Grade Distribution</h3><span>JSS 2A Â· All subjects</span></div>
          <div class="donut-wrap">
            <svg width="120" height="120" viewBox="0 0 120 120">
              <circle cx="60" cy="60" r="45" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="18"/>
              <circle cx="60" cy="60" r="45" fill="none" stroke="#4ade80" stroke-width="18" stroke-dasharray="98.96 184.04" stroke-dashoffset="0" transform="rotate(-90 60 60)"/>
              <circle cx="60" cy="60" r="45" fill="none" stroke="#fbbf24" stroke-width="18" stroke-dasharray="127.23 155.77" stroke-dashoffset="-98.96" transform="rotate(-90 60 60)"/>
              <circle cx="60" cy="60" r="45" fill="none" stroke="#f87171" stroke-width="18" stroke-dasharray="56.55 226.45" stroke-dashoffset="-226.19" transform="rotate(-90 60 60)"/>
              <text x="60" y="56" text-anchor="middle" fill="white" font-size="13" font-family="Playfair Display" font-weight="700">72%</text>
              <text x="60" y="70" text-anchor="middle" fill="#9c8fa3" font-size="8">Avg Score</text>
            </svg>
            <div class="donut-labels">
              <div class="donut-label"><div class="donut-dot" style="background:var(--green);"></div><span>Excellent (A)</span><strong style="color:var(--green);">35%</strong></div>
              <div class="donut-label"><div class="donut-dot" style="background:var(--amber);"></div><span>Pass (P)</span><strong style="color:var(--amber);">45%</strong></div>
              <div class="donut-label"><div class="donut-dot" style="background:var(--red);"></div><span>Fail (F)</span><strong style="color:var(--red);">20%</strong></div>
            </div>
          </div>
          <div style="margin-top:18px;padding-top:14px;border-top:1px solid rgba(255,255,255,0.06);">
            <div class="perf-item"><div class="perf-top"><span>80â€“100</span><strong style="color:var(--green);">8 students</strong></div><div class="perf-track"><div class="perf-fill green" style="width:25%"></div></div></div>
            <div class="perf-item"><div class="perf-top"><span>60â€“79</span><strong style="color:var(--amber);">14 students</strong></div><div class="perf-track"><div class="perf-fill amber" style="width:44%"></div></div></div>
            <div class="perf-item"><div class="perf-top"><span>40â€“59</span><strong style="color:var(--blue);">7 students</strong></div><div class="perf-track"><div class="perf-fill blue" style="width:22%"></div></div></div>
            <div class="perf-item"><div class="perf-top"><span>0â€“39</span><strong style="color:var(--red);">3 students</strong></div><div class="perf-track"><div class="perf-fill red" style="width:9%"></div></div></div>
          </div>
        </div>
      </div>
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ’ª Subjects Class Excels In</h3><span>Above 65% class average</span></div>
          <div id="strong-subjects"></div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>âš ï¸ Subjects Needing Attention</h3><span>Below 60% class average</span></div>
          <div id="weak-subjects"></div>
        </div>
      </div>
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ† Top 5 Performing Students</h3></div>
          <div id="top-students-analysis"></div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ¤ Students Needing Support</h3><span>Below 50% overall</span></div>
          <div id="low-students-analysis"></div>
        </div>
      </div>
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ“‰ CA vs Exam â€” Per Student</h3><span>Purple = CA Â· Pink = Exam</span></div>
        <div id="student-ca-exam-bars"></div>
      </div>
    </div>

    <!-- â•â• PSYCHOMOTOR â€” ADMIN APPROVAL â•â• -->
    <div id="section-psychomotor" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ§  Psychomotor Submission Status</h3><span>Admin approval required before results are published</span></div>
        <div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:12px;padding:14px 16px;margin-bottom:20px;font-size:0.82rem;color:var(--muted);line-height:1.7;">
          ğŸ“‹ <strong style="color:var(--amber-light);">Workflow:</strong> Each Class Teacher fills Psychomotor & Affective grades from their Staff Dashboard. Once submitted, Admin reviews and approves below. Approved grades are automatically included in the student's printed result sheet.
        </div>
        <div class="psycho-status-grid" id="psycho-status-grid">
          <div class="psycho-status-card" style="border-color:var(--amber-b);background:var(--amber-bg);">
            <h4>JSS 2A</h4>
            <p>Class Teacher: Mrs. Okonkwo</p>
            <div class="status-row">
              <span class="badge badge-amber">â³ Submitted â€” Pending Approval</span>
              <button class="btn btn-sm btn-green" onclick="approvePsycho('JSS 2A')">âœ… Approve</button>
            </div>
          </div>
          <div class="psycho-status-card" style="border-color:var(--red-b);background:var(--red-bg);">
            <h4>JSS 1A</h4>
            <p>Class Teacher: Mr. Adeleke</p>
            <div class="status-row">
              <span class="badge badge-red">âŒ Not Yet Submitted</span>
              <button class="btn btn-sm btn-amber" onclick="showToast('Reminder sent to Mr. Adeleke')">Remind</button>
            </div>
          </div>
          <div class="psycho-status-card" style="border-color:var(--red-b);background:var(--red-bg);">
            <h4>JSS 1B</h4>
            <p>Class Teacher: Mrs. Afolabi</p>
            <div class="status-row">
              <span class="badge badge-red">âŒ Not Yet Submitted</span>
              <button class="btn btn-sm btn-amber" onclick="showToast('Reminder sent to Mrs. Afolabi')">Remind</button>
            </div>
          </div>
          <div class="psycho-status-card" style="border-color:var(--green-b);background:var(--green-bg);">
            <h4>SS 1A</h4>
            <p>Class Teacher: Mrs. Fashola</p>
            <div class="status-row">
              <span class="badge badge-green">âœ… Approved</span>
              <button class="btn btn-sm btn-purple" onclick="showToast('Viewing SS 1A psychomotor...')">View</button>
            </div>
          </div>
        </div>
      </div>

      <div id="psycho-detail-section" class="section-card-full" style="display:none;">
        <div class="sc-header">
          <h3>ğŸ“‹ Psychomotor Grades â€” <span id="psycho-detail-class"></span></h3>
          <div style="display:flex;gap:8px;">
            <span class="badge badge-amber">â³ Awaiting Approval</span>
            <button class="btn btn-sm btn-green" onclick="approvePsycho('JSS 2A')">âœ… Approve All</button>
          </div>
        </div>
        <div style="background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.2);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:0.8rem;color:var(--muted);">
          Submitted by <strong style="color:var(--white);">Mrs. Funke Okonkwo</strong> Â· Class Teacher, JSS 2A Â· Yesterday at 3:42 PM
        </div>
        <div style="font-size:0.75rem;margin-bottom:12px;display:flex;gap:14px;flex-wrap:wrap;">
          <span style="color:var(--green);">5 = Excellent</span><span style="color:var(--blue);">4 = Very Good</span>
          <span style="color:var(--amber);">3 = Good</span><span style="color:var(--rose-light);">2 = Fair</span><span style="color:var(--red);">1 = Poor</span>
        </div>
        <div style="overflow-x:auto;">
          <table class="psycho-table">
            <thead>
              <tr>
                <th style="min-width:140px;">Student Name</th>
                <th>Punctuality</th><th>Attentiveness</th><th>Neatness</th>
                <th>Politeness</th><th>Honesty</th><th>Sports</th>
                <th>Clubs</th><th>Creativity</th><th>Leadership</th><th>Conduct</th>
              </tr>
            </thead>
            <tbody id="admin-psycho-view"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• GRADING SYSTEM â•â• -->
    <div id="section-grading" style="display:none;">
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ« Junior School Grading (JSS 1â€“3)</h3></div>
          <div style="background:var(--amber-bg);border:1px solid var(--amber-b);border-radius:10px;padding:12px;margin-bottom:16px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
            Simple, clear grading designed for junior secondary students.
          </div>
          <table class="data-table">
            <thead><tr><th>Score Range</th><th>Grade</th><th>Remark</th><th>Description</th></tr></thead>
            <tbody>
              <tr><td style="color:var(--green);font-weight:700;">70 â€“ 100</td><td><span class="badge badge-green" style="font-size:0.85rem;padding:4px 14px;">A</span></td><td style="color:var(--green);">Excellent</td><td style="color:var(--muted);font-size:0.78rem;">Student has mastered subject content</td></tr>
              <tr><td style="color:var(--amber);font-weight:700;">40 â€“ 69</td><td><span class="badge badge-amber" style="font-size:0.85rem;padding:4px 14px;">P</span></td><td style="color:var(--amber);">Pass</td><td style="color:var(--muted);font-size:0.78rem;">Student meets minimum requirement</td></tr>
              <tr><td style="color:var(--red);font-weight:700;">0 â€“ 39</td><td><span class="badge badge-red" style="font-size:0.85rem;padding:4px 14px;">F</span></td><td style="color:var(--red);">Fail</td><td style="color:var(--muted);font-size:0.78rem;">Student needs significant improvement</td></tr>
            </tbody>
          </table>
          <div style="margin-top:14px;padding:12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
            ğŸ“Œ CA = 30 marks Â· Exam = 70 marks Â· Total = 100 marks
          </div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“ Senior School â€” WAEC Standard (SS 1â€“3)</h3></div>
          <div style="background:var(--purple-bg);border:1px solid var(--purple-b);border-radius:10px;padding:12px;margin-bottom:16px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
            Official WAEC grading adopted for all senior secondary students.
          </div>
          <table class="data-table">
            <thead><tr><th>Score Range</th><th>Grade</th><th>Remark</th></tr></thead>
            <tbody>
              <tr><td style="color:var(--green);font-weight:700;">75 â€“ 100</td><td><span class="g-A1">A1</span></td><td style="color:var(--green);">Excellent</td></tr>
              <tr><td style="color:#34d399;font-weight:700;">70 â€“ 74</td><td><span class="g-B2">B2</span></td><td style="color:#34d399;">Very Good</td></tr>
              <tr><td style="color:#6ee7b7;font-weight:700;">65 â€“ 69</td><td><span class="g-B3">B3</span></td><td style="color:#6ee7b7;">Good</td></tr>
              <tr><td style="color:var(--blue);font-weight:700;">60 â€“ 64</td><td><span class="g-C4">C4</span></td><td style="color:var(--blue);">Credit</td></tr>
              <tr><td style="color:#93c5fd;font-weight:700;">55 â€“ 59</td><td><span class="g-C5">C5</span></td><td style="color:#93c5fd;">Credit</td></tr>
              <tr><td style="color:var(--amber);font-weight:700;">50 â€“ 54</td><td><span class="g-C6">C6</span></td><td style="color:var(--amber);">Credit</td></tr>
              <tr><td style="color:var(--amber-light);font-weight:700;">45 â€“ 49</td><td><span class="g-D7">D7</span></td><td style="color:var(--amber-light);">Pass</td></tr>
              <tr><td style="color:var(--rose-light);font-weight:700;">40 â€“ 44</td><td><span class="g-E8">E8</span></td><td style="color:var(--rose-light);">Pass</td></tr>
              <tr><td style="color:var(--red);font-weight:700;">0 â€“ 39</td><td><span class="g-F9">F9</span></td><td style="color:var(--red);">Fail</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• MANAGE STUDENTS â•â• -->
    <div id="section-students" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ’ Manage Students</h3><button class="btn btn-amber" onclick="openModal('add-student')">+ Add New Student</button></div>
        <div style="display:flex;gap:10px;margin-bottom:16px;flex-wrap:wrap;">
          <input type="text" id="student-search" placeholder="ğŸ” Search by name or reg number..." oninput="filterStudents()" style="flex:1;min-width:200px;padding:9px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.85rem;outline:none;">
          <select id="student-class-filter" onchange="filterStudents()" style="padding:9px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;"><option>All Classes</option></select>
        </div>
        <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Reg Number</th><th>Student Name</th><th>Class</th><th>Class Teacher</th><th>Status</th><th>Actions</th></tr></thead><tbody id="student-table-body"></tbody></table></div>
      </div>
    </div>

    <!-- â•â• MANAGE STAFF â•â• -->
    <div id="section-staff" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ‘©â€ğŸ« Manage Staff</h3><button class="btn btn-purple" onclick="openModal('add-staff')">+ Add New Staff</button></div>
        <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Staff Name</th><th>Phone</th><th>Subject(s)</th><th>Class Teacher</th><th>Status</th><th>Actions</th></tr></thead><tbody id="staff-table-body"></tbody></table></div>
      </div>
    </div>

    <!-- â•â• CLASSES â•â• -->
    <div id="section-classes" style="display:none;">
      <div class="sc-header" style="margin-bottom:16px;"><h3>ğŸ« Classes & Arms</h3><button class="btn btn-amber" onclick="openModal('add-class')">+ Add Class</button></div>
      <div class="class-grid" id="class-grid"></div>
    </div>

    <!-- â•â• SCORES â•â• -->
    <div id="section-scores" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header">
          <h3>âœï¸ View & Edit Scores</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <select id="admin-score-class" style="padding:7px 12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:9px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;"><option>Loading classes...</option></select>
            <input type="text" id="admin-score-subject" placeholder="Subject name..." style="padding:7px 12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:9px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;width:160px;">
            <button class="btn btn-amber" onclick="loadAdminScoreTable()">Load Scores</button>
          </div>
        </div>
        <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Student</th><th>Reg No</th><th>CA (30)</th><th>Exam (70)</th><th>Total</th><th>Grade</th><th>Save</th></tr></thead><tbody id="admin-score-body"><tr><td colspan="7" style="padding:16px;color:var(--muted);">Select a class and subject above, then click Load Scores.</td></tr></tbody></table></div>
        <div style="margin-top:14px;display:flex;gap:10px;">
          <button class="btn btn-green" onclick="saveAllAdminScores()">ğŸ’¾ Save All</button>
        </div>
      </div>
    </div>

    <!-- â•â• PUBLISH â•â• -->
    <div id="section-publish" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ“¤ Publish Results</h3><span>Make results visible to students</span></div>
        <div style="background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.2);border-radius:12px;padding:14px;margin-bottom:20px;font-size:0.82rem;color:var(--muted);">âš ï¸ Once published, students can view results on their dashboards immediately. Ensure all scores AND psychomotor grades are approved before publishing.</div>
        <div id="publish-status" style="font-size:0.92rem;font-weight:600;margin-bottom:20px;color:var(--amber);"></div>
        <button id="publish-toggle-btn" class="btn btn-green" style="min-width:280px;" onclick="togglePublishResults()">ğŸ“¤ Publish Results for All Students</button>
        <div style="margin-top:18px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
          ğŸ’¡ This is a global switch â€” it publishes or unpublishes results for <strong style="color:var(--white);">all classes and all terms</strong> at once. The student dashboard will show or hide results immediately after this toggle.
        </div>
      </div>
    </div>

    <!-- â•â• SUBJECTS â•â• -->
    <div id="section-subjects" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ“š Subjects Offered</h3><button class="btn btn-amber" onclick="openModal('add-subject')">+ Add Subject</button></div>
        <div style="overflow-x:auto;"><table class="data-table"><thead><tr><th>Subject</th><th>Level</th><th>Teacher</th><th>Classes</th><th>Actions</th></tr></thead><tbody>
          <tr><td>Mathematics</td><td><span class="badge badge-blue">JSS</span></td><td>Mrs. Okonkwo</td><td>JSS1Aâ€“JSS3A</td><td class="actions"><button class="btn btn-sm btn-amber" onclick="showToast('Edit')">Edit</button><button class="btn btn-sm btn-red" onclick="showToast('Removed')">Remove</button></td></tr>
          <tr><td>English Language</td><td><span class="badge badge-blue">JSS</span></td><td>Mr. Adeleke</td><td>JSS1Aâ€“JSS3A</td><td class="actions"><button class="btn btn-sm btn-amber" onclick="showToast('Edit')">Edit</button><button class="btn btn-sm btn-red" onclick="showToast('Removed')">Remove</button></td></tr>
          <tr><td>Further Mathematics</td><td><span class="badge badge-purple">SS</span></td><td>Mrs. Okonkwo</td><td>SS2A, SS2B</td><td class="actions"><button class="btn btn-sm btn-amber" onclick="showToast('Edit')">Edit</button><button class="btn btn-sm btn-red" onclick="showToast('Removed')">Remove</button></td></tr>
        </tbody></table></div>
      </div>
    </div>

    <!-- â•â• NOTICES â•â• -->
    <div id="section-notices" style="display:none;">
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“¢ Compose Notice</h3></div>
          <div class="field"><label>Title</label><input type="text" id="notice-title" placeholder="Notice title"></div>
          <div class="field"><label>Send To</label><select id="notice-audience"><option value="staff">All Staff</option><option value="students">All Students</option><option value="class_teachers">Class Teachers Only</option><option value="all">Everyone</option></select></div>
          <div class="field"><label>Priority</label><select id="notice-priority"><option value="normal">Normal</option><option value="urgent">Urgent</option><option value="info">Information</option></select></div>
          <div class="field"><label>Message</label><textarea id="notice-message" placeholder="Type your notice..."></textarea></div>
          <button id="send-notice-btn" class="btn btn-amber" style="width:100%;" onclick="sendNotice()">ğŸ“¢ Send Notice</button>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“‹ Sent Notices</h3></div>
          <div class="notice-list" id="sent-notices-list">
            <div style="color:var(--muted);font-size:0.83rem;">Loading...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• RESET â•â• -->
    <div id="section-reset" style="display:none;">
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ”‘ Reset Student Password</h3></div>
          <div class="field"><label>Search Student</label><input type="text" id="reset-student-search" placeholder="Name or reg number..." oninput="searchStudentForReset()"></div>
          <div id="reset-student-result" style="background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;padding:14px;margin-bottom:14px;display:none;">
            <div id="reset-student-name" style="font-size:0.82rem;font-weight:600;"></div>
            <div id="reset-student-meta" style="font-size:0.75rem;color:var(--muted);"></div>
            <input type="hidden" id="reset-student-id">
          </div>
          <div class="field"><label>New Password</label><input type="text" id="reset-student-pw" placeholder="Enter new password"></div>
          <div id="reset-student-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin-bottom:10px;display:none;"></div>
          <button id="reset-student-btn" class="btn btn-rose" style="width:100%;" onclick="resetStudentPassword()">ğŸ”‘ Reset Student Password</button>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ”‘ Reset Staff Password</h3></div>
          <div class="field"><label>Search Staff</label><input type="text" id="reset-staff-search" placeholder="Name or phone..." oninput="searchStaffForReset()"></div>
          <div id="reset-staff-result" style="background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;padding:14px;margin-bottom:14px;display:none;">
            <div id="reset-staff-name" style="font-size:0.82rem;font-weight:600;"></div>
            <div id="reset-staff-meta" style="font-size:0.75rem;color:var(--muted);"></div>
            <input type="hidden" id="reset-staff-id">
          </div>
          <div class="field"><label>New Password</label><input type="text" id="reset-staff-pw" placeholder="Enter new password"></div>
          <div id="reset-staff-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin-bottom:10px;display:none;"></div>
          <button id="reset-staff-btn" class="btn btn-purple" style="width:100%;" onclick="resetStaffPassword()">ğŸ”‘ Reset Staff Password</button>
        </div>
      </div>
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ« Assign / Change Class Teacher</h3><span>Reflects immediately on staff dashboards</span></div>
        <div class="form-grid">
          <div class="field"><label>Select Class</label><select id="assign-class"><option>â€” Select Class â€”</option></select></div>
          <div class="field"><label>Assign Class Teacher</label><select id="assign-staff"><option>â€” Select Staff â€”</option></select></div>
        </div>
        <div id="assign-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin-bottom:10px;display:none;"></div>
        <button id="assign-ct-btn" class="btn btn-amber" onclick="assignClassTeacher()">âœ… Assign Class Teacher</button>
      </div>
    </div>

    <!-- â•â• SETTINGS â•â• -->
    <div id="section-settings" style="display:none;">
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>âš™ï¸ Session & Term</h3></div>
          <div class="field"><label>Academic Session</label><input type="text" id="set-session" value="2024/2025"></div>
          <div class="field"><label>Current Term</label><select id="set-term"><option>First Term</option><option>Second Term</option><option>Third Term</option></select></div>
          <div class="field"><label>Term Start Date</label><input type="date" id="set-start" value="2025-01-06"></div>
          <div class="field"><label>Term End Date</label><input type="date" id="set-end" value="2025-03-28"></div>
          <button id="save-settings-btn" class="btn btn-amber" style="width:100%;" onclick="saveSettings()">ğŸ’¾ Save Settings</button>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ« School Information</h3></div>
          <div class="field"><label>School Name</label><input type="text" id="set-school-name" value="Adrem Model Academy"></div>
          <div class="field"><label>Address</label><input type="text" id="set-address" value="P.O Box 102, Adrem Avenue, Apomu, Osun State"></div>
          <div class="field"><label>Phone 1</label><input type="text" id="set-phone1" value="08034653513"></div>
          <div class="field"><label>Phone 2</label><input type="text" id="set-phone2" value="07015182166"></div>
          <div class="field"><label>Email</label><input type="text" id="set-email" value="adremacademy78@gmail.com"></div>
          <button class="btn btn-amber" style="width:100%;" onclick="showToast('Info saved â€” updates will reflect on print headers.')">ğŸ’¾ Save Info</button>
        </div>
      </div>
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ” Change Admin Password</h3></div>
        <div class="form-grid">
          <div class="field"><label>Current Password</label><input type="password" id="apw-current" placeholder="Current password"></div>
          <div class="field"><label>New Password</label><input type="password" id="apw-new" placeholder="New password"></div>
          <div class="field"><label>Confirm Password</label><input type="password" id="apw-confirm" placeholder="Repeat new password"></div>
          <div class="field"><label>Admin Email</label><input type="email" id="apw-email" value="adremacademy78@gmail.com"></div>
        </div>
        <div id="apw-msg" style="padding:10px 14px;border-radius:8px;font-size:0.78rem;margin-bottom:12px;display:none;"></div>
        <button class="btn btn-amber" onclick="changeAdminPassword()">ğŸ” Update Password</button>
      </div>
    </div>

    <!-- â•â• ACTIVITY â•â• -->
    <div id="section-activity" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ• Full Activity Log</h3></div>
        <div class="activity-list" id="full-activity"></div>
      </div>
    </div>

  </div>
  <div class="dash-footer">Â© 2026 Adrem Model Academy Admin Portal â€” Apomu, Osun State</div>
</div>

<!-- MODALS -->
<div class="modal" id="modal-add-student">
  <div class="modal-card">
    <button class="modal-close" onclick="closeModal('add-student')">âœ•</button>
    <div class="modal-title">ğŸ’ Add New Student</div>
    <div class="modal-sub">Reg number auto-generated. Default password = Surname.</div>
    <div class="form-grid">
      <div class="field"><label>Full Name</label><input type="text" id="ns-name" placeholder="e.g. Aisha Adeyemi"></div>
      <div class="field"><label>Reg Number</label><input type="text" id="ns-reg" placeholder="e.g. AMA/2025/050"></div>
      <div class="field"><label>Date of Birth</label><input type="date" id="ns-dob"></div>
      <div class="field"><label>Gender</label><select id="ns-gender"><option value="Female">Female</option><option value="Male">Male</option></select></div>
      <div class="field"><label>Class</label><select id="ns-class"><option value="">â€” Loading classes... â€”</option></select></div>
      <div class="field"><label>Parent Phone</label><input type="text" id="ns-phone" placeholder="08012345678"></div>
    </div>
    <div id="ns-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin:10px 0;display:none;"></div>
    <div style="display:flex;gap:10px;margin-top:14px;">
      <button id="ns-btn" class="btn btn-amber" style="flex:1;" onclick="addStudent()">âœ… Add Student</button>
      <button class="btn" style="background:var(--glass);border:1px solid var(--glass-b);color:var(--muted);" onclick="closeModal('add-student')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-add-staff">
  <div class="modal-card">
    <button class="modal-close" onclick="closeModal('add-staff')">âœ•</button>
    <div class="modal-title">ğŸ‘©â€ğŸ« Add New Staff</div>
    <div class="modal-sub">Staff login with phone number. Default password = Surname.</div>
    <div class="form-grid">
      <div class="field"><label>Full Name</label><input type="text" id="nst-name" placeholder="Mrs. Funke Okonkwo"></div>
      <div class="field"><label>Phone Number</label><input type="text" id="nst-phone" placeholder="08012345678"></div>
      <div class="field"><label>Qualification</label><input type="text" id="nst-qual" placeholder="B.Ed Mathematics"></div>
      <div class="field"><label>Subject(s)</label><input type="text" id="nst-subjects" placeholder="Mathematics, Further Maths"></div>
      <div class="field"><label>Role</label><select id="nst-role"><option value="staff">Teaching Staff</option><option value="admin">Administrator</option></select></div>
      <div class="field"><label>Join Date</label><input type="text" id="nst-join" placeholder="e.g. September 2024"></div>
    </div>
    <div id="nst-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin:10px 0;display:none;"></div>
    <div style="display:flex;gap:10px;margin-top:14px;">
      <button id="nst-btn" class="btn btn-purple" style="flex:1;" onclick="addStaff()">âœ… Add Staff</button>
      <button class="btn" style="background:var(--glass);border:1px solid var(--glass-b);color:var(--muted);" onclick="closeModal('add-staff')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-add-class">
  <div class="modal-card">
    <button class="modal-close" onclick="closeModal('add-class')">âœ•</button>
    <div class="modal-title">ğŸ« Add New Class / Arm</div>
    <div class="modal-sub">Enter the class name exactly as it should appear (e.g. JSS 3B, SS 2A).</div>
    <div class="field"><label>Class Name</label><input type="text" id="nc-name" placeholder="e.g. JSS 3B"></div>
    <div class="field"><label>Level</label><select id="nc-level"><option value="JSS">JSS (Junior)</option><option value="SS">SS (Senior)</option><option value="Primary">Primary</option></select></div>
    <div class="field"><label>Assign Class Teacher (optional)</label><select id="nc-teacher"><option value="">â€” Assign Later â€”</option></select></div>
    <div id="nc-msg" style="padding:8px 12px;border-radius:8px;font-size:0.78rem;margin:10px 0;display:none;"></div>
    <div style="display:flex;gap:10px;margin-top:14px;">
      <button id="nc-btn" class="btn btn-amber" style="flex:1;" onclick="addClass()">âœ… Add Class</button>
      <button class="btn" style="background:var(--glass);border:1px solid var(--glass-b);color:var(--muted);" onclick="closeModal('add-class')">Cancel</button>
    </div>
  </div>
</div>

<div class="modal" id="modal-add-subject">
  <div class="modal-card">
    <button class="modal-close" onclick="closeModal('add-subject')">âœ•</button>
    <div class="modal-title">ğŸ“š Add New Subject</div>
    <div class="field"><label>Subject Name</label><input type="text" placeholder="e.g. Agricultural Science"></div>
    <div class="field"><label>Level</label><select><option>JSS</option><option>SS</option><option>Both</option></select></div>
    <div class="field"><label>Assigned Teacher</label><select><option>Mrs. Okonkwo</option><option>Mr. Adeleke</option></select></div>
    <div class="field"><label>Classes</label><input type="text" placeholder="e.g. JSS1A, JSS1B"></div>
    <div style="display:flex;gap:10px;margin-top:14px;">
      <button class="btn btn-amber" style="flex:1;" onclick="showToast('Subject added!');closeModal('add-subject')">âœ… Add Subject</button>
      <button class="btn" style="background:var(--glass);border:1px solid var(--glass-b);color:var(--muted);" onclick="closeModal('add-subject')">Cancel</button>
    </div>
  </div>
</div>

<div id="toast" style="position:fixed;bottom:28px;right:28px;background:#231d33;border:1px solid rgba(251,191,36,0.3);border-radius:12px;padding:12px 18px;font-size:0.83rem;color:var(--white);z-index:500;opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;max-width:300px;"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADMIN DASHBOARD â€” Full Supabase Backend Integration
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let ADMIN = null;
let SETTINGS = {};
let ALL_STUDENTS = [];
let ALL_STAFF = [];

// Grade helpers
function jssGrade(t){return t>=70?'A':t>=40?'P':'F';}
function jssGradeClass(t){return t>=70?'g-A':t>=40?'g-P':'g-F';}
function waecGrade(t){return t>=75?'A1':t>=70?'B2':t>=65?'B3':t>=60?'C4':t>=55?'C5':t>=50?'C6':t>=45?'D7':t>=40?'E8':'F9';}
function waecGradeClass(t){return t>=75?'g-A1':t>=70?'g-B2':t>=65?'g-B3':t>=60?'g-C4':t>=55?'g-C5':t>=50?'g-C6':t>=45?'g-D7':t>=40?'g-E8':'g-F9';}

// Safe date formatter â€” handles cases where DB.formatDate may not exist
function formatDate(dateStr){
  if(!dateStr) return 'â€”';
  if(typeof DB !== 'undefined' && typeof DB.formatDate === 'function') return DB.formatDate(dateStr);
  try {
    const d = new Date(dateStr);
    return d.toLocaleDateString('en-GB', { day:'2-digit', month:'short', year:'numeric' });
  } catch(e){ return dateStr; }
}

function showToast(msg, ok){
  const t = document.getElementById('toast');
  t.textContent = (ok===false ? 'âŒ ' : 'âœ… ') + msg;
  t.style.opacity='1'; t.style.transform='translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; }, 3500);
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const allSections = ['dashboard','activity','students','staff','classes','scores','publish','subjects','broadsheet','analysis','psychomotor','grading','notices','reset','settings'];
const titles = {dashboard:'Admin Control Room',activity:'Activity Log',students:'Manage Students',staff:'Manage Staff',classes:'Classes & Arms',scores:'Scores & Results',publish:'Publish Results',subjects:'Subjects',broadsheet:'Class Broadsheet',analysis:'Student Performance Analysis',psychomotor:'Psychomotor Approval',grading:'Grading System',notices:'Notice Board',reset:'Reset Passwords',settings:'Portal Settings'};

function showSection(name, el){
  allSections.forEach(s=>{ const e=document.getElementById('section-'+s); if(e) e.style.display=s===name?'block':'none'; });
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('page-title').textContent = titles[name]||name;
  if(name==='students') loadStudentTable();
  if(name==='staff') loadStaffTable();
  if(name==='classes') loadClassGrid();
  if(name==='scores') loadAdminScores();
  if(name==='psychomotor') loadPsychomotorStatus();
  if(name==='activity') loadActivityLog();
  if(name==='publish') loadPublishStatus();
  if(name==='notices') loadSentNotices();
  if(name==='reset') populateAssignSelects();
  if(name==='broadsheet') renderBroadsheet();
  if(name==='analysis') renderAnalysis();
}

// â”€â”€ Modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function openModal(n){
  document.getElementById('modal-'+n).classList.add('show');
  // Populate dynamic selectors when modals open
  if(n==='add-class') populateAddClassTeacherSelect();
  if(n==='add-student') populateStudentClassSelect();
}
function closeModal(n){ document.getElementById('modal-'+n).classList.remove('show'); }

// Populate the class teacher dropdown in Add Class modal
function populateAddClassTeacherSelect(){
  const sel = document.getElementById('nc-teacher');
  if(!sel) return;
  const staffList = ALL_STAFF.length ? ALL_STAFF : [];
  sel.innerHTML = `<option value="">â€” Assign Later â€”</option>` +
    staffList.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
}

// Populate the class selector in Add Student modal from existing classes
function populateStudentClassSelect(){
  const sel = document.getElementById('ns-class');
  if(!sel) return;
  const classes = [...new Set(ALL_STUDENTS.map(s=>s.class).filter(Boolean))].sort();
  if(classes.length){
    sel.innerHTML = classes.map(c=>`<option value="${c}">${c}</option>`).join('');
  } else {
    // Fallback: show standard classes if no students yet
    sel.innerHTML = ['JSS 1A','JSS 1B','JSS 2A','JSS 2B','JSS 3A','JSS 3B','SS 1A','SS 1B','SS 2A','SS 2B','SS 3A','SS 3B']
      .map(c=>`<option value="${c}">${c}</option>`).join('');
  }
}
document.addEventListener('DOMContentLoaded', ()=>{
  document.querySelectorAll('.modal').forEach(m=>{
    m.addEventListener('click', function(e){ if(e.target===this) this.classList.remove('show'); });
  });
});

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  // Guard: if DB is not defined (supabase.js not loaded yet), retry shortly
  if(typeof DB === 'undefined'){
    console.warn('supabase.js not yet loaded â€” retrying in 300ms');
    setTimeout(init, 300);
    return;
  }

  ADMIN = DB.requireAuth('admin');
  if(!ADMIN) return;

  SETTINGS = await DB.getSettings();

  document.querySelector('.topbar-left p').textContent =
    (SETTINGS.session||'2024/2025') + ' Session â€” ' + (SETTINGS.term||'First Term');

  const ss = document.getElementById('set-session');
  const st = document.getElementById('set-term');
  if(ss) ss.value = SETTINGS.session||'2024/2025';
  if(st){ Array.from(st.options).forEach(o=>{ if(o.value===SETTINGS.term||o.text===SETTINGS.term) o.selected=true; }); }

  await loadDashboardStats();
  await loadRecentActivity();
  await loadScoreEntryStatus();

  populateClassSelectors();
}

// â”€â”€ Populate class selectors â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function populateClassSelectors(){
  try {
    const classes = [...new Set(ALL_STUDENTS.map(s=>s.class).filter(Boolean))].sort();
    if(!classes.length) return;

    const bsSel = document.getElementById('bs-class');
    if(bsSel) bsSel.innerHTML = classes.map(c=>`<option value="${c}">${c}</option>`).join('');

    const anSel = document.getElementById('an-class');
    if(anSel) anSel.innerHTML = classes.map(c=>`<option>${c}</option>`).join('');

    const sfSel = document.getElementById('student-class-filter');
    if(sfSel) sfSel.innerHTML = `<option>All Classes</option>`+classes.map(c=>`<option>${c}</option>`).join('');
  } catch(e){ /* non-critical */ }
}

async function loadDashboardStats(){
  try {
    ALL_STUDENTS = await DB.getAllStudents();
    ALL_STAFF    = await DB.getAllStaff();
    const classes = [...new Set(ALL_STUDENTS.map(s=>s.class).filter(Boolean))];

    document.querySelector('.stat-card.amber .sc-val').textContent  = ALL_STUDENTS.length;
    document.querySelector('.stat-card.purple .sc-val').textContent = ALL_STAFF.length;
    document.querySelector('.stat-card.green .sc-val').textContent  = classes.length;

    const pubEl = document.querySelector('.stat-card.red .sc-val');
    if(pubEl) pubEl.textContent = SETTINGS.results_published ? 'Yes' : 'No';

  } catch(e){ console.error('Dashboard stats error:', e); }
}

async function loadRecentActivity(){
  try {
    const logs = await DB.getActivityLog(5);
    const el = document.querySelector('#section-dashboard .activity-list');
    if(!el || !logs.length) return;
    const icons = { 'Scores saved':'âœï¸', 'Attendance saved':'âœ…', 'Psychomotor draft saved':'ğŸ§ ', 'Psychomotor submitted':'ğŸ“¤', 'Psychomotor approved':'âœ…', 'Notice sent':'ğŸ“¢' };
    el.innerHTML = logs.map(a=>{
      const icon = icons[a.action] || 'ğŸ•';
      const when = new Date(a.created_at);
      const diff = Math.round((Date.now()-when)/60000);
      const timeStr = diff<60?`${diff}m ago`:diff<1440?`${Math.round(diff/60)}h ago`:`${Math.round(diff/1440)}d ago`;
      return `<div class="activity-item"><div class="act-icon">${icon}</div><div class="act-text"><strong>${a.action}</strong><span>${a.detail||''}</span></div><div class="act-time">${timeStr}</div></div>`;
    }).join('');
  } catch(e){ /* non-critical */ }
}

async function loadScoreEntryStatus(){
  try {
    const staffList = ALL_STAFF.length ? ALL_STAFF : await DB.getAllStaff();
    const tbody = document.querySelector('#section-dashboard .data-table tbody');
    if(!tbody) return;
    tbody.innerHTML = staffList.map(s=>`
      <tr>
        <td>${s.name}</td>
        <td style="color:var(--muted);font-size:0.8rem;">${s.subjects||'â€”'}</td>
        <td style="color:var(--muted);font-size:0.8rem;">${s.assigned_class||'â€”'}</td>
        <td><span class="badge badge-amber">â³ Check portal</span></td>
        <td><span class="badge badge-amber">â³ Check portal</span></td>
        <td><span class="badge badge-amber">â³ Pending</span></td>
        <td><span class="badge badge-blue">Active</span></td>
        <td>â€”</td>
      </tr>`).join('');
  } catch(e){ /* non-critical */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANAGE STUDENTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStudentTable(){
  const tbody = document.getElementById('student-table-body');
  if(!tbody) return;
  tbody.innerHTML = `<tr><td colspan="6" style="padding:20px;color:var(--muted);text-align:center;">Loading students...</td></tr>`;
  try {
    ALL_STUDENTS = await DB.getAllStudents();
    renderStudentTable(ALL_STUDENTS);
  } catch(e){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:16px;color:var(--red);">Could not load students: ${e.message}</td></tr>`;
  }
}

function renderStudentTable(students){
  const tbody = document.getElementById('student-table-body');
  if(!students.length){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:20px;color:var(--muted);text-align:center;">No students found. Add your first student using the button above.</td></tr>`;
    return;
  }
  tbody.innerHTML = students.map(s=>`<tr>
    <td style="color:var(--amber-light);font-size:0.78rem;">${s.reg||'â€”'}</td>
    <td style="font-weight:500;">${s.name}</td>
    <td><span class="badge badge-blue">${s.class||'â€”'}</span></td>
    <td style="color:var(--muted);font-size:0.8rem;">${s.phone||'â€”'}</td>
    <td><span class="badge badge-green">Active</span></td>
    <td class="actions">
      <button class="btn btn-sm btn-red" onclick="removeStudent('${s.id}','${s.name.replace(/'/g,"\\'")}')">Remove</button>
    </td></tr>`).join('');
}

function filterStudents(){
  const q = document.getElementById('student-search').value.toLowerCase();
  const cls = document.getElementById('student-class-filter').value;
  let filtered = ALL_STUDENTS;
  if(q) filtered = filtered.filter(s=>(s.name||'').toLowerCase().includes(q)||(s.reg||'').toLowerCase().includes(q));
  if(cls && cls!=='All Classes') filtered = filtered.filter(s=>s.class===cls);
  renderStudentTable(filtered);
}

async function addStudent(){
  const name    = document.getElementById('ns-name').value.trim();
  const reg     = document.getElementById('ns-reg').value.trim();
  const dob     = document.getElementById('ns-dob').value;
  const gender  = document.getElementById('ns-gender').value;
  const cls     = document.getElementById('ns-class').value;
  const phone   = document.getElementById('ns-phone').value.trim();
  const msgEl   = document.getElementById('ns-msg');
  const btn     = document.getElementById('ns-btn');

  const showMsg = (msg, ok)=>{ msgEl.textContent=msg; msgEl.style.background=ok?'var(--green-bg)':'var(--red-bg)'; msgEl.style.color=ok?'var(--green)':'var(--red)'; msgEl.style.border='1px solid '+(ok?'var(--green-b)':'var(--red-b)'); msgEl.style.display='block'; };

  if(!name||!reg||!cls){ showMsg('Please fill in name, reg number, and class.', false); return; }

  btn.disabled=true; btn.textContent='Adding...';
  try {
    const surname = name.split(' ').pop().toLowerCase();
    await DB.addStudent({ name, reg, dob:dob||null, gender, class:cls, phone:phone||null, password:surname });
    showMsg('âœ… Student added successfully! Default password = '+surname, true);
    ['ns-name','ns-reg','ns-dob','ns-phone'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    await loadStudentTable();
    await DB.logActivity('Student added', name+' Â· '+reg+' Â· '+cls, ADMIN.id);
    setTimeout(()=>closeModal('add-student'), 1800);
  } catch(e){
    showMsg('Error: '+e.message, false);
  } finally {
    btn.disabled=false; btn.textContent='âœ… Add Student';
  }
}

async function removeStudent(id, name){
  if(!confirm(`Remove ${name}? This cannot be undone.`)) return;
  try {
    await DB.removeStudent(id);
    showToast(`${name} removed.`);
    await loadStudentTable();
    await DB.logActivity('Student removed', name, ADMIN.id);
  } catch(e){ showToast('Error removing student: '+e.message, false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MANAGE STAFF
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadStaffTable(){
  const tbody = document.getElementById('staff-table-body');
  if(!tbody) return;
  tbody.innerHTML = `<tr><td colspan="6" style="padding:20px;color:var(--muted);text-align:center;">Loading staff...</td></tr>`;
  try {
    ALL_STAFF = await DB.getAllStaff();
    renderStaffTable(ALL_STAFF);
  } catch(e){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:16px;color:var(--red);">Could not load staff: ${e.message}</td></tr>`;
  }
}

function renderStaffTable(staffList){
  const tbody = document.getElementById('staff-table-body');
  if(!staffList.length){
    tbody.innerHTML = `<tr><td colspan="6" style="padding:20px;color:var(--muted);text-align:center;">No staff found. Add your first staff member above.</td></tr>`;
    return;
  }
  tbody.innerHTML = staffList.map(s=>{
    const ct = s.is_class_teacher
      ? `<span class="badge badge-green">âœ… ${s.assigned_class||'?'}</span>`
      : `<span class="badge badge-amber">Not Assigned</span>`;
    const roleBadge = s.role==='admin' ? `<span class="badge badge-amber">Admin</span>` : `<span class="badge badge-blue">Staff</span>`;
    return `<tr>
      <td style="font-weight:500;">${s.name}</td>
      <td style="color:var(--muted);font-size:0.8rem;">${s.phone}</td>
      <td style="font-size:0.8rem;">${s.subjects||'â€”'}</td>
      <td>${ct}</td>
      <td>${roleBadge}</td>
      <td class="actions">
        <button class="btn btn-sm btn-rose" onclick="quickResetStaff('${s.id}','${s.name.replace(/'/g,"\\'")}')">Reset PW</button>
        <button class="btn btn-sm btn-red" onclick="removeStaff('${s.id}','${s.name.replace(/'/g,"\\'")}')">Remove</button>
      </td></tr>`;
  }).join('');
}

async function addStaff(){
  const name     = document.getElementById('nst-name').value.trim();
  const phone    = document.getElementById('nst-phone').value.trim();
  const qual     = document.getElementById('nst-qual').value.trim();
  const subjects = document.getElementById('nst-subjects').value.trim();
  const role     = document.getElementById('nst-role').value;
  const joinDate = document.getElementById('nst-join').value.trim();
  const msgEl    = document.getElementById('nst-msg');
  const btn      = document.getElementById('nst-btn');

  const showMsg = (msg, ok)=>{ msgEl.textContent=msg; msgEl.style.background=ok?'var(--green-bg)':'var(--red-bg)'; msgEl.style.color=ok?'var(--green)':'var(--red)'; msgEl.style.border='1px solid '+(ok?'var(--green-b)':'var(--red-b)'); msgEl.style.display='block'; };

  if(!name||!phone){ showMsg('Please fill in name and phone number.', false); return; }

  btn.disabled=true; btn.textContent='Adding...';
  try {
    const surname = name.split(' ').pop().toLowerCase();
    await DB.addStaff({ name, phone, qualification:qual||null, subjects:subjects||null, role, join_date:joinDate||null, password:surname });
    showMsg('âœ… Staff added! Default password = '+surname, true);
    ['nst-name','nst-phone','nst-qual','nst-subjects','nst-join'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; });
    await loadStaffTable();
    await DB.logActivity('Staff added', name+' Â· '+phone, ADMIN.id);
    setTimeout(()=>closeModal('add-staff'), 1800);
  } catch(e){
    showMsg('Error: '+e.message, false);
  } finally {
    btn.disabled=false; btn.textContent='âœ… Add Staff';
  }
}

async function removeStaff(id, name){
  if(!confirm(`Remove ${name}? This cannot be undone.`)) return;
  try {
    await DB.removeStaff(id);
    showToast(`${name} removed.`);
    await loadStaffTable();
    await DB.logActivity('Staff removed', name, ADMIN.id);
  } catch(e){ showToast('Error: '+e.message, false); }
}

async function quickResetStaff(id, name){
  const surname = name.split(' ').pop().toLowerCase();
  if(!confirm(`Reset ${name}'s password to "${surname}"?`)) return;
  try {
    await DB.resetPassword('staff', id, surname);
    showToast(`Password reset to "${surname}" for ${name}.`);
    await DB.logActivity('Staff password reset', name, ADMIN.id);
  } catch(e){ showToast('Error: '+e.message, false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ADD CLASS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addClass(){
  const name   = (document.getElementById('nc-name').value||'').trim();
  const level  = document.getElementById('nc-level').value;
  const teacher= document.getElementById('nc-teacher').value;
  const msgEl  = document.getElementById('nc-msg');
  const btn    = document.getElementById('nc-btn');

  const showMsg = (msg, ok)=>{ msgEl.textContent=msg; msgEl.style.background=ok?'var(--green-bg)':'var(--red-bg)'; msgEl.style.color=ok?'var(--green)':'var(--red)'; msgEl.style.border='1px solid '+(ok?'var(--green-b)':'var(--red-b)'); msgEl.style.display='block'; };

  if(!name){ showMsg('Please enter a class name (e.g. JSS 3B).', false); return; }

  btn.disabled=true; btn.textContent='Adding...';
  try {
    // Try DB.addClass if it exists, otherwise use DB.addStudent trick (insert a placeholder)
    if(typeof DB.addClass === 'function'){
      await DB.addClass({ name, level, created_at: new Date().toISOString() });
    } else {
      // Fallback: the "class" exists as long as students belong to it.
      // Record it by saving to a classes table via selectRaw or just notify the user.
      showMsg('âš ï¸ DB.addClass not found in supabase.js â€” class saved locally only. Add DB.addClass() to your supabase.js.', false);
      btn.disabled=false; btn.textContent='âœ… Add Class';
      return;
    }

    // If a teacher was selected, assign them
    if(teacher){
      const existing = ALL_STAFF.filter(s=>s.is_class_teacher && s.assigned_class===name);
      for(const s of existing){ await DB.setClassTeacher(s.id, false, null); }
      await DB.setClassTeacher(teacher, true, name);
      ALL_STAFF = await DB.getAllStaff();
    }

    showMsg('âœ… Class "'+name+'" added successfully!', true);
    document.getElementById('nc-name').value = '';
    await DB.logActivity('Class added', name+' Â· '+level, ADMIN.id);

    // Refresh class selectors across the portal
    ALL_STUDENTS = await DB.getAllStudents(); // refresh to pick up any existing students in this class
    populateClassSelectors();
    populateStudentClassSelect();

    setTimeout(()=>{ closeModal('add-class'); loadClassGrid(); }, 1800);
  } catch(e){
    showMsg('Error adding class: '+e.message, false);
    console.error('addClass error:', e);
  } finally {
    btn.disabled=false; btn.textContent='âœ… Add Class';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CLASSES GRID
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadClassGrid(){
  const grid = document.getElementById('class-grid');
  if(!grid) return;
  grid.innerHTML = `<div style="color:var(--muted);">Loading...</div>`;
  try {
    const students = ALL_STUDENTS.length ? ALL_STUDENTS : await DB.getAllStudents();
    const staff    = ALL_STAFF.length ? ALL_STAFF : await DB.getAllStaff();

    const classMap = {};
    students.forEach(s=>{ if(s.class){ if(!classMap[s.class]) classMap[s.class]=[]; classMap[s.class].push(s); } });

    const classList = Object.keys(classMap).sort();
    if(!classList.length){
      grid.innerHTML = `<div style="color:var(--muted);font-size:0.83rem;">No classes found. Add students to create classes.</div>`;
      return;
    }

    grid.innerHTML = classList.map(cls=>{
      const count = classMap[cls].length;
      const teacher = staff.find(s=>s.is_class_teacher && s.assigned_class===cls);
      return `<div class="class-card" onclick="showSection('students',null)">
        <h4>${cls}</h4>
        <div class="cc-meta">ğŸ‘¥ ${count} student${count!==1?'s':''}</div>
        <div class="cc-meta">ğŸ‘©â€ğŸ« ${teacher?teacher.name:'No Class Teacher'}</div>
        <div class="cc-avg" style="font-size:0.85rem;color:var(--amber);margin-top:8px;">View â†’</div>
      </div>`;
    }).join('');
  } catch(e){
    grid.innerHTML = `<div style="color:var(--red);font-size:0.83rem;">Could not load classes: ${e.message}</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORES (ADMIN VIEW)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadAdminScores(){
  try {
    const students = ALL_STUDENTS.length ? ALL_STUDENTS : await DB.getAllStudents();
    const classes = [...new Set(students.map(s=>s.class).filter(Boolean))].sort();
    const clsSel = document.getElementById('admin-score-class');
    if(clsSel){
      clsSel.innerHTML = classes.length
        ? classes.map(c=>`<option>${c}</option>`).join('')
        : `<option>No classes yet</option>`;
    }
  } catch(e){ /* non-critical */ }
}

async function loadAdminScoreTable(){
  const clsSel  = document.getElementById('admin-score-class');
  const subSel  = document.getElementById('admin-score-subject');
  const tbody   = document.getElementById('admin-score-body');
  if(!clsSel||!subSel||!tbody) return;

  const className = clsSel.value;
  const subject   = subSel.value.trim();
  if(!className||!subject){ showToast('Enter a class and subject name.', false); return; }

  tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;color:var(--muted);">Loading...</td></tr>`;
  try {
    const [students, scores] = await Promise.all([
      DB.getClassStudents(className),
      DB.getClassScores(className, subject, SETTINGS.term, SETTINGS.session)
    ]);
    if(!students.length){
      tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;color:var(--muted);">No students in ${className}.</td></tr>`;
      return;
    }
    tbody.innerHTML = students.map(s=>{
      const sc = scores.find(r=>r.student_id===s.id);
      const ca = sc ? sc.ca_score : '';
      const ex = sc ? sc.exam_score : '';
      const total = ca!==''&&ex!=='' ? Number(ca)+Number(ex) : 'â€”';
      const gClass = total!=='â€”' ? jssGradeClass(total) : '';
      const grade  = total!=='â€”' ? jssGrade(total) : 'â€”';
      return `<tr>
        <td style="font-weight:500;">${s.name}</td>
        <td style="color:var(--muted);font-size:0.78rem;">${s.reg}</td>
        <td><input class="score-input" type="number" min="0" max="30" value="${ca}" data-sid="${s.id}" data-type="ca" oninput="adminLiveTotal(this)"></td>
        <td><input class="score-input" type="number" min="0" max="70" value="${ex}" data-sid="${s.id}" data-type="exam" oninput="adminLiveTotal(this)"></td>
        <td id="atotal-${s.id}" style="font-weight:700;">${total}</td>
        <td><span id="agrade-${s.id}" class="${gClass}">${grade}</span></td>
        <td><button class="btn btn-sm btn-amber" onclick="saveOneAdminScore('${s.id}','${className}','${subject}',this)">Save</button></td>
      </tr>`;
    }).join('');
  } catch(e){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:16px;color:var(--red);">Error: ${e.message}</td></tr>`;
  }
}

function adminLiveTotal(input){
  const sid = input.dataset.sid;
  const row = input.closest('tr');
  const ca = Number(row.querySelector('[data-type="ca"]').value)||0;
  const ex = Number(row.querySelector('[data-type="exam"]').value)||0;
  const total = ca+ex;
  const totalEl = document.getElementById('atotal-'+sid);
  const gradeEl = document.getElementById('agrade-'+sid);
  if(totalEl) totalEl.textContent = total;
  if(gradeEl){ gradeEl.textContent = jssGrade(total); gradeEl.className = jssGradeClass(total); }
}

async function saveOneAdminScore(studentId, className, subject, btn){
  const row = btn.closest('tr');
  const ca  = Number(row.querySelector('[data-type="ca"]').value)||0;
  const ex  = Number(row.querySelector('[data-type="exam"]').value)||0;
  btn.disabled=true; btn.textContent='...';
  try {
    await DB.saveScore(studentId, subject, className, ca, ex, SETTINGS.term, SETTINGS.session);
    btn.textContent='âœ…'; btn.className='btn btn-sm btn-green';
    setTimeout(()=>{ btn.textContent='Save'; btn.className='btn btn-sm btn-amber'; btn.disabled=false; }, 2000);
  } catch(e){ showToast('Error saving: '+e.message, false); btn.disabled=false; btn.textContent='Save'; }
}

async function saveAllAdminScores(){
  const clsSel = document.getElementById('admin-score-class');
  const subSel = document.getElementById('admin-score-subject');
  if(!clsSel||!subSel) return;
  const className = clsSel.value;
  const subject   = subSel.value.trim();
  const rows = document.querySelectorAll('#admin-score-body tr');
  const scoreRows = [];
  rows.forEach(row=>{
    const caInput = row.querySelector('[data-type="ca"]');
    const exInput = row.querySelector('[data-type="exam"]');
    if(!caInput) return;
    scoreRows.push({ student_id:caInput.dataset.sid, subject, class_name:className, ca_score:Number(caInput.value)||0, exam_score:Number(exInput.value)||0, term:SETTINGS.term, session:SETTINGS.session });
  });
  if(!scoreRows.length){ showToast('Load scores first.', false); return; }
  try {
    await DB.saveScoresBulk(scoreRows);
    showToast('All scores saved!');
    await DB.logActivity('Admin saved scores', subject+' Â· '+className, ADMIN.id);
  } catch(e){ showToast('Error: '+e.message, false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PSYCHOMOTOR APPROVAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPsychomotorStatus(){
  const grid = document.getElementById('psycho-status-grid');
  if(!grid) return;

  // Only attempt live data if DB.selectRaw exists; otherwise keep static HTML
  if(typeof DB === 'undefined' || typeof DB.selectRaw !== 'function') return;

  grid.innerHTML = `<div style="color:var(--muted);font-size:0.83rem;">Loading psychomotor submissions...</div>`;

  try {
    const staff = ALL_STAFF.length ? ALL_STAFF : await DB.getAllStaff();
    const classTeachers = staff.filter(s=>s.is_class_teacher && s.assigned_class);

    if(!classTeachers.length){
      grid.innerHTML = `<div style="color:var(--muted);font-size:0.83rem;">No class teachers assigned yet.</div>`;
      return;
    }

    // Build query string safely without encodeURIComponent inside literals
    const termParam    = encodeURIComponent(SETTINGS.term    || 'First Term');
    const sessionParam = encodeURIComponent(SETTINGS.session || '2024/2025');
    const allPsycho = await DB.selectRaw('psychomotor', `term=eq.${termParam}&session=eq.${sessionParam}`);

    grid.innerHTML = classTeachers.map(ct=>{
      const classRows = allPsycho.filter(r=>r.class_name===ct.assigned_class);
      const status = classRows.length===0 ? 'none'
        : classRows[0].status==='approved' ? 'approved'
        : classRows[0].status==='submitted' ? 'submitted'
        : 'draft';

      let cardStyle, badge, actionBtn;
      if(status==='approved'){
        cardStyle='border-color:var(--green-b);background:var(--green-bg);';
        badge=`<span class="badge badge-green">âœ… Approved</span>`;
        actionBtn=`<button class="btn btn-sm btn-purple" onclick="viewPsychomotor('${ct.assigned_class}')">View</button>`;
      } else if(status==='submitted'){
        cardStyle='border-color:var(--amber-b);background:var(--amber-bg);';
        badge=`<span class="badge badge-amber">â³ Submitted</span>`;
        actionBtn=`<button class="btn btn-sm btn-green" onclick="approvePsycho('${ct.assigned_class}')">âœ… Approve</button>`;
      } else if(status==='draft'){
        cardStyle='border-color:var(--blue-b);background:var(--blue-bg);';
        badge=`<span class="badge badge-blue">ğŸ“ Draft</span>`;
        actionBtn=`<button class="btn btn-sm btn-amber" disabled>Awaiting Submit</button>`;
      } else {
        cardStyle='border-color:var(--red-b);background:var(--red-bg);';
        badge=`<span class="badge badge-red">âŒ Not Submitted</span>`;
        actionBtn=`<button class="btn btn-sm btn-amber" disabled>Not Yet</button>`;
      }

      return `<div class="psycho-status-card" style="${cardStyle}">
        <h4>${ct.assigned_class}</h4>
        <p>Class Teacher: ${ct.name}</p>
        <div class="status-row">${badge}${actionBtn}</div>
      </div>`;
    }).join('');

  } catch(e){
    grid.innerHTML = `<div style="color:var(--red);font-size:0.83rem;">Error loading psychomotor data: ${e.message}</div>`;
  }
}

async function approvePsycho(className){
  if(!confirm(`Approve all psychomotor grades for ${className}? This will make them visible on student result sheets.`)) return;
  try {
    await DB.approvePsychomotor(className, SETTINGS.term, SETTINGS.session);
    showToast(`Psychomotor grades for ${className} approved!`);
    await DB.logActivity('Psychomotor approved', className, ADMIN.id);
    await loadPsychomotorStatus();
  } catch(e){ showToast('Error approving: '+e.message, false); }
}

async function viewPsychomotor(className){
  const detailEl = document.getElementById('psycho-detail-section');
  if(!detailEl) return;
  detailEl.style.display = 'block';
  document.getElementById('psycho-detail-class').textContent = 'Viewing: '+className;

  const TRAITS = ['punctuality','attentiveness','neatness','politeness','honesty','sports','clubs','creativity','leadership','conduct'];
  const LABELS = ['Punctuality','Attentiveness','Neatness','Politeness','Honesty','Sports','Clubs','Creativity','Leadership','Conduct'];

  try {
    const rows = await DB.getClassPsychomotor(className, SETTINGS.term, SETTINGS.session);
    const students = await DB.getClassStudents(className);
    const tbody = document.getElementById('admin-psycho-view');
    const theadRow = document.querySelector('#admin-psycho-view').closest('table').querySelector('thead tr');

    tbody.innerHTML = rows.map(row=>{
      const s = students.find(st=>st.id===row.student_id);
      const name = s ? s.name : 'Unknown';
      return `<tr>
        <td style="white-space:nowrap;">${name}</td>
        ${TRAITS.map(t=>`<td style="color:var(--amber);font-weight:700;">${row[t]||'â€”'}</td>`).join('')}
      </tr>`;
    }).join('');

    if(theadRow){
      theadRow.innerHTML = `<th style="min-width:140px;">Student Name</th>${LABELS.map(l=>`<th>${l}</th>`).join('')}`;
    }
  } catch(e){
    document.getElementById('admin-psycho-view').innerHTML = `<tr><td colspan="11" style="color:var(--red);">Error: ${e.message}</td></tr>`;
  }
  detailEl.scrollIntoView({behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PUBLISH RESULTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadPublishStatus(){
  const publishBtn    = document.getElementById('publish-toggle-btn');
  const publishStatus = document.getElementById('publish-status');
  if(!publishBtn) return;

  const published = SETTINGS.results_published;
  publishBtn.textContent = published ? 'ğŸ”’ Unpublish Results' : 'ğŸ“¤ Publish Results for All Students';
  publishBtn.className   = 'btn ' + (published ? 'btn-red' : 'btn-green');
  publishBtn.style.minWidth = '280px';
  if(publishStatus){
    publishStatus.textContent = published
      ? 'âœ… Results are currently PUBLISHED â€” students can view them.'
      : 'ğŸ”’ Results are currently UNPUBLISHED â€” students cannot see them.';
    publishStatus.style.color = published ? 'var(--green)' : 'var(--amber)';
  }
}

async function togglePublishResults(){
  const btn     = document.getElementById('publish-toggle-btn');
  const current = SETTINGS.results_published;
  const action  = current ? 'unpublish' : 'publish';
  if(!confirm(`Are you sure you want to ${action} results? ${current?'Students will immediately lose access.':'Students will immediately see their results.'}`)) return;
  btn.disabled=true;
  try {
    await DB.setResultsPublished(!current);
    SETTINGS.results_published = !current;
    await loadPublishStatus();
    const pubEl = document.querySelector('.stat-card.red .sc-val');
    if(pubEl) pubEl.textContent = SETTINGS.results_published ? 'Yes' : 'No';
    showToast(`Results ${SETTINGS.results_published?'published':'unpublished'} successfully!`);
    await DB.logActivity(`Results ${action}ed`, `${SETTINGS.term} ${SETTINGS.session}`, ADMIN.id);
  } catch(e){ showToast('Error: '+e.message, false); }
  finally { btn.disabled=false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSentNotices(){
  const el = document.getElementById('sent-notices-list');
  if(!el) return;
  try {
    const notices = await DB.getNotices(8);
    if(!notices.length){ el.innerHTML=`<div style="color:var(--muted);font-size:0.83rem;">No notices sent yet.</div>`; return; }
    const priorityDot = { urgent:'urgent', normal:'normal', info:'info' };
    el.innerHTML = notices.map(n=>`
      <div class="notice-item">
        <div class="notice-dot ${priorityDot[n.priority||'normal']}"></div>
        <div class="notice-text" style="flex:1;">
          <strong>${n.title}</strong>
          <span>${n.audience||'all'} Â· ${formatDate(n.created_at)}</span>
        </div>
        <button class="btn btn-sm btn-red" style="margin-left:8px;" onclick="deleteNotice('${n.id}')">âœ•</button>
      </div>`).join('');
  } catch(e){
    el.innerHTML = `<div style="color:var(--red);font-size:0.83rem;">Could not load notices.</div>`;
  }
}

async function sendNotice(){
  const title    = document.getElementById('notice-title').value.trim();
  const audience = document.getElementById('notice-audience').value;
  const priority = document.getElementById('notice-priority').value;
  const message  = document.getElementById('notice-message').value.trim();
  const btn      = document.getElementById('send-notice-btn');
  if(!title||!message){ showToast('Please fill in title and message.', false); return; }
  btn.disabled=true; btn.textContent='Sending...';
  try {
    await DB.sendNotice(title, message, audience, priority);
    showToast('Notice sent to '+audience+'!');
    document.getElementById('notice-title').value='';
    document.getElementById('notice-message').value='';
    await loadSentNotices();
    await DB.logActivity('Notice sent', title+' Â· '+audience, ADMIN.id);
  } catch(e){ showToast('Error: '+e.message, false); }
  finally { btn.disabled=false; btn.textContent='ğŸ“¢ Send Notice'; }
}

async function deleteNotice(id){
  if(!confirm('Delete this notice?')) return;
  try {
    await DB.deleteNotice(id);
    showToast('Notice deleted.');
    await loadSentNotices();
  } catch(e){ showToast('Error: '+e.message, false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  RESET PASSWORDS & ASSIGN CLASS TEACHER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let resetStudentMatch = null;
let resetStaffMatch   = null;

async function searchStudentForReset(){
  const q = document.getElementById('reset-student-search').value.toLowerCase().trim();
  const resultEl = document.getElementById('reset-student-result');
  if(q.length<2){ resultEl.style.display='none'; resetStudentMatch=null; return; }
  const students = ALL_STUDENTS.length ? ALL_STUDENTS : await DB.getAllStudents();
  const match = students.find(s=>(s.name||'').toLowerCase().includes(q)||(s.reg||'').toLowerCase().includes(q));
  if(match){
    resetStudentMatch = match;
    document.getElementById('reset-student-name').textContent = match.name;
    document.getElementById('reset-student-meta').textContent = (match.reg||'')+ ' Â· '+(match.class||'')+ ' Â· Phone: '+(match.phone||'â€”');
    document.getElementById('reset-student-id').value = match.id;
    document.getElementById('reset-student-pw').value = (match.name||'').split(' ').pop().toLowerCase();
    resultEl.style.display='block';
  } else {
    resultEl.style.display='none'; resetStudentMatch=null;
  }
}

async function searchStaffForReset(){
  const q = document.getElementById('reset-staff-search').value.toLowerCase().trim();
  const resultEl = document.getElementById('reset-staff-result');
  if(q.length<2){ resultEl.style.display='none'; resetStaffMatch=null; return; }
  const staff = ALL_STAFF.length ? ALL_STAFF : await DB.getAllStaff();
  const match = staff.find(s=>(s.name||'').toLowerCase().includes(q)||(s.phone||'').includes(q));
  if(match){
    resetStaffMatch = match;
    document.getElementById('reset-staff-name').textContent = match.name;
    document.getElementById('reset-staff-meta').textContent = (match.phone||'')+ ' Â· '+(match.subjects||'')+ ' Â· '+(match.assigned_class||'No class');
    document.getElementById('reset-staff-id').value = match.id;
    document.getElementById('reset-staff-pw').value = (match.name||'').split(' ').pop().toLowerCase();
    resultEl.style.display='block';
  } else {
    resultEl.style.display='none'; resetStaffMatch=null;
  }
}

async function resetStudentPassword(){
  if(!resetStudentMatch){ showMsg('reset-student-msg','Search and select a student first.', false); return; }
  const newPw = document.getElementById('reset-student-pw').value.trim();
  if(!newPw){ showMsg('reset-student-msg','Enter a new password.', false); return; }
  const btn = document.getElementById('reset-student-btn');
  btn.disabled=true;
  try {
    await DB.resetPassword('students', resetStudentMatch.id, newPw);
    showMsg('reset-student-msg',`âœ… Password reset to "${newPw}" for ${resetStudentMatch.name}.`, true);
    await DB.logActivity('Student password reset', resetStudentMatch.name, ADMIN.id);
  } catch(e){ showMsg('reset-student-msg','Error: '+e.message, false); }
  finally { btn.disabled=false; }
}

async function resetStaffPassword(){
  if(!resetStaffMatch){ showMsg('reset-staff-msg','Search and select a staff member first.', false); return; }
  const newPw = document.getElementById('reset-staff-pw').value.trim();
  if(!newPw){ showMsg('reset-staff-msg','Enter a new password.', false); return; }
  const btn = document.getElementById('reset-staff-btn');
  btn.disabled=true;
  try {
    await DB.resetPassword('staff', resetStaffMatch.id, newPw);
    showMsg('reset-staff-msg',`âœ… Password reset to "${newPw}" for ${resetStaffMatch.name}.`, true);
    await DB.logActivity('Staff password reset', resetStaffMatch.name, ADMIN.id);
  } catch(e){ showMsg('reset-staff-msg','Error: '+e.message, false); }
  finally { btn.disabled=false; }
}

function showMsg(elId, msg, ok){
  const el = document.getElementById(elId);
  if(!el) return;
  el.textContent = msg;
  el.style.background = ok ? 'var(--green-bg)' : 'var(--red-bg)';
  el.style.color = ok ? 'var(--green)' : 'var(--red)';
  el.style.border = '1px solid '+(ok ? 'var(--green-b)' : 'var(--red-b)');
  el.style.display = 'block';
}

async function populateAssignSelects(){
  try {
    const students = ALL_STUDENTS.length ? ALL_STUDENTS : await DB.getAllStudents();
    const staff    = ALL_STAFF.length ? ALL_STAFF : await DB.getAllStaff();
    const classes  = [...new Set(students.map(s=>s.class).filter(Boolean))].sort();
    const clsSel   = document.getElementById('assign-class');
    const stSel    = document.getElementById('assign-staff');
    if(clsSel && clsSel.children.length<=1){
      clsSel.innerHTML = `<option>â€” Select Class â€”</option>` + classes.map(c=>`<option>${c}</option>`).join('');
    }
    if(stSel && stSel.children.length<=1){
      stSel.innerHTML = `<option>â€” Select Staff â€”</option>` + staff.map(s=>`<option value="${s.id}">${s.name}</option>`).join('');
    }
  } catch(e){ /* non-critical */ }
}

async function assignClassTeacher(){
  const clsSel   = document.getElementById('assign-class');
  const stSel    = document.getElementById('assign-staff');
  const btn      = document.getElementById('assign-ct-btn');
  const cls      = clsSel.value;
  const staffId  = stSel.value;
  const staffName= stSel.options[stSel.selectedIndex].text;
  if(!cls||cls.startsWith('â€”')||!staffId||staffId.startsWith('â€”')){ showMsg('assign-msg','Select both a class and a staff member.', false); return; }
  btn.disabled=true;
  try {
    const existing = ALL_STAFF.filter(s=>s.is_class_teacher && s.assigned_class===cls);
    for(const s of existing){ await DB.setClassTeacher(s.id, false, null); }
    await DB.setClassTeacher(staffId, true, cls);
    showMsg('assign-msg',`âœ… ${staffName} assigned as Class Teacher for ${cls}.`, true);
    ALL_STAFF = await DB.getAllStaff();
    await DB.logActivity('Class teacher assigned', staffName+' â†’ '+cls, ADMIN.id);
  } catch(e){ showMsg('assign-msg','Error: '+e.message, false); }
  finally { btn.disabled=false; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SETTINGS SAVE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function saveSettings(){
  const session  = document.getElementById('set-session').value.trim();
  const term     = document.getElementById('set-term').value;
  const termStart= document.getElementById('set-start').value;
  const termEnd  = document.getElementById('set-end').value;
  const btn      = document.getElementById('save-settings-btn');
  if(!session||!term){ showToast('Session and term are required.', false); return; }
  btn.disabled=true; btn.textContent='Saving...';
  try {
    await DB.saveSettings({ term, session, term_start:termStart||null, term_end:termEnd||null });
    SETTINGS = { ...SETTINGS, term, session, term_start:termStart, term_end:termEnd };
    document.querySelector('.topbar-left p').textContent = session + ' Session â€” ' + term;
    showToast('Settings saved! All dashboards will reflect the new term/session.');
    await DB.logActivity('Settings updated', term+' '+session, ADMIN.id);
  } catch(e){ showToast('Error saving settings: '+e.message, false); }
  finally { btn.disabled=false; btn.textContent='ğŸ’¾ Save Settings'; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHANGE ADMIN PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function changeAdminPassword(){
  const current  = document.getElementById('apw-current').value.trim();
  const newPw    = document.getElementById('apw-new').value.trim();
  const confirmed= document.getElementById('apw-confirm').value.trim();
  if(!current||!newPw||!confirmed){ showMsg('apw-msg','Fill in all fields.', false); return; }
  if(newPw!==confirmed){ showMsg('apw-msg','New passwords do not match.', false); return; }
  if(newPw.length<4){ showMsg('apw-msg','Password must be at least 4 characters.', false); return; }
  try {
    const check = await DB.select('staff', { id: ADMIN.id, password: current });
    if(!check.length){ showMsg('apw-msg','Current password is incorrect.', false); return; }
    await DB.update('staff', { password: newPw }, { id: ADMIN.id });
    showMsg('apw-msg','âœ… Password updated successfully!', true);
    ['apw-current','apw-new','apw-confirm'].forEach(id=>{ document.getElementById(id).value=''; });
  } catch(e){ showMsg('apw-msg','Error: '+e.message, false); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ACTIVITY LOG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadActivityLog(){
  const el = document.getElementById('full-activity');
  if(!el) return;
  el.innerHTML = `<div style="color:var(--muted);">Loading activity...</div>`;
  try {
    const logs = await DB.getActivityLog(50);
    if(!logs.length){ el.innerHTML=`<div style="color:var(--muted);">No activity recorded yet.</div>`; return; }
    const icons = { 'Scores saved':'âœï¸','Attendance saved':'âœ…','Psychomotor draft saved':'ğŸ§ ','Psychomotor submitted':'ğŸ“¤','Psychomotor approved':'âœ”ï¸','Notice sent':'ğŸ“¢','Student added':'ğŸ’','Staff added':'ğŸ‘©â€ğŸ«','Student removed':'ğŸ—‘ï¸','Staff removed':'ğŸ—‘ï¸','Settings updated':'âš™ï¸','Results published':'ğŸ“¤','Results unpublished':'ğŸ”’','Class teacher assigned':'ğŸ«','Student password reset':'ğŸ”‘','Staff password reset':'ğŸ”‘','Admin saved scores':'âœï¸' };
    el.innerHTML = logs.map(a=>{
      const icon = icons[a.action] || 'ğŸ•';
      const when = new Date(a.created_at);
      const diff = Math.round((Date.now()-when)/60000);
      const timeStr = diff<60?`${diff}m ago`:diff<1440?`${Math.round(diff/60)}h ago`:`${Math.round(diff/1440)}d ago`;
      return `<div class="activity-item"><div class="act-icon">${icon}</div><div class="act-text"><strong>${a.action}</strong><span>${a.detail||''}</span></div><div class="act-time">${timeStr}</div></div>`;
    }).join('');
  } catch(e){ el.innerHTML=`<div style="color:var(--red);">Error loading activity: ${e.message}</div>`; }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BROADSHEET
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderBroadsheet(){
  const clsSel = document.getElementById('bs-class');
  const table  = document.getElementById('broadsheet-table');
  const keyEl  = document.getElementById('bs-grade-key');
  if(!clsSel||!table) return;

  const className = clsSel.value;
  if(!className){ return; }
  table.innerHTML = `<tr><td style="padding:20px;color:var(--muted);">Loading broadsheet...</td></tr>`;

  try {
    const [students, allScores] = await Promise.all([
      DB.getClassStudents(className),
      DB.getAllClassScores(className, SETTINGS.term, SETTINGS.session)
    ]);

    if(!students.length){ table.innerHTML=`<tr><td style="padding:20px;color:var(--muted);">No students in ${className}.</td></tr>`; return; }
    if(!allScores.length){ table.innerHTML=`<tr><td style="padding:20px;color:var(--muted);">No scores entered for ${className} yet.</td></tr>`; return; }

    const subjects = [...new Set(allScores.map(s=>s.subject))].sort();
    const isJSS = className.toUpperCase().startsWith('JSS');
    const gFn  = isJSS ? jssGrade : waecGrade;
    const gcFn = isJSS ? jssGradeClass : waecGradeClass;

    if(keyEl){
      keyEl.innerHTML = isJSS
        ? `<div class="gk-item"><span class="g-A">A</span><span style="color:var(--muted)">= Excellent (70â€“100)</span></div><div class="gk-item"><span class="g-P">P</span><span style="color:var(--muted)">= Pass (40â€“69)</span></div><div class="gk-item"><span class="g-F">F</span><span style="color:var(--muted)">= Fail (0â€“39)</span></div>`
        : `<div class="gk-item"><span class="g-A1">A1</span><span style="color:var(--muted)">75â€“100</span></div><div class="gk-item"><span class="g-B2">B2</span><span style="color:var(--muted)">70â€“74</span></div><div class="gk-item"><span class="g-C4">C4</span><span style="color:var(--muted)">60â€“64</span></div><div class="gk-item"><span class="g-F9">F9</span><span style="color:var(--muted)">0â€“39</span></div>`;
    }

    const scoreMap = {};
    allScores.forEach(sc=>{ if(!scoreMap[sc.student_id]) scoreMap[sc.student_id]={}; scoreMap[sc.student_id][sc.subject]=(sc.ca_score||0)+(sc.exam_score||0); });

    const rows = students.map(s=>{
      const subTotals = subjects.map(sub=>scoreMap[s.id]?.[sub]??null);
      const entered   = subTotals.filter(t=>t!==null);
      const grandTotal= entered.reduce((a,b)=>a+b,0);
      const avg       = entered.length ? (grandTotal/entered.length).toFixed(1) : 'â€”';
      return { ...s, subTotals, grandTotal, avg: avg==='â€”'?-1:parseFloat(avg) };
    }).sort((a,b)=>b.grandTotal-a.grandTotal).map((s,i)=>({...s,position:i+1}));

    let html = `<thead><tr>
      <th class="name-col" style="width:36px;text-align:center;">Pos.</th>
      <th class="name-col">Student Name</th>
      <th>Reg No</th>
      ${subjects.map(s=>`<th>${s.substring(0,9)}<br><small style="font-size:0.6rem;opacity:0.7;">/100</small></th>`).join('')}
      <th>Total</th><th>Avg%</th><th>Grade</th>
    </tr></thead><tbody>`;

    const subAvgs = subjects.map((_,si)=>{
      const vals = rows.map(r=>r.subTotals[si]).filter(t=>t!==null);
      return vals.length ? (vals.reduce((a,b)=>a+b,0)/vals.length).toFixed(0) : 'â€”';
    });

    rows.forEach(s=>{
      const avgDisplay = s.avg===-1?'â€”':s.avg+'%';
      html+=`<tr>
        <td class="pos-col" style="text-align:center;">${s.position}</td>
        <td class="name-col">${s.name}</td>
        <td style="color:var(--muted);font-size:0.72rem;white-space:nowrap;">${s.reg||'â€”'}</td>
        ${s.subTotals.map(t=>t===null?`<td style="color:var(--muted);">â€”</td>`:`<td><span class="${gcFn(t)}">${gFn(t)}</span><br><small style="color:var(--muted);font-size:0.65rem;">${t}</small></td>`).join('')}
        <td style="font-weight:700;color:var(--amber-light);">${s.grandTotal||'â€”'}</td>
        <td style="color:var(--muted);">${avgDisplay}</td>
        <td>${s.avg>0?`<span class="${gcFn(s.avg)}">${gFn(s.avg)}</span>`:'â€”'}</td>
      </tr>`;
    });

    const grandClassAvg = rows.filter(r=>r.avg>0);
    const overallAvg = grandClassAvg.length ? (grandClassAvg.reduce((a,r)=>a+r.avg,0)/grandClassAvg.length).toFixed(1) : 'â€”';
    html+=`</tbody><tfoot><tr>
      <td colspan="3" style="text-align:left;">CLASS AVERAGE</td>
      ${subAvgs.map(a=>`<td>${a}</td>`).join('')}
      <td>â€”</td><td>${overallAvg}%</td><td></td>
    </tr></tfoot>`;

    table.innerHTML = html;
    const bsPrintTitle = document.getElementById('bs-print-title');
    if(bsPrintTitle){
      bsPrintTitle.textContent = `CLASS BROADSHEET â€” ${className.toUpperCase()} Â· ${(SETTINGS.term||'FIRST TERM').toUpperCase()} ${SETTINGS.session||'2024/2025'}`;
    }
  } catch(e){
    table.innerHTML = `<tr><td style="padding:16px;color:var(--red);">Error loading broadsheet: ${e.message}</td></tr>`;
  }
}

function printBroadsheet(){
  const ph = document.querySelector('.print-header');
  if(ph) ph.style.display='block';
  window.print();
  setTimeout(()=>{ if(ph) ph.style.display='none'; }, 1000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYSIS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function renderAnalysis(){
  const clsSel = document.getElementById('an-class');
  if(!clsSel) return;
  const className = clsSel.value;
  const chartEl = document.getElementById('ca-exam-chart');
  if(chartEl) chartEl.innerHTML=`<div style="color:var(--muted);font-size:0.83rem;padding:20px 0;">Loading analysis...</div>`;

  try {
    const [students, allScores] = await Promise.all([
      DB.getClassStudents(className),
      DB.getAllClassScores(className, SETTINGS.term, SETTINGS.session)
    ]);

    if(!allScores.length){
      if(chartEl) chartEl.innerHTML=`<div style="color:var(--muted);">No scores entered for ${className} yet.</div>`;
      return;
    }

    const subjects = [...new Set(allScores.map(s=>s.subject))].sort();

    const subjectCA   = {};
    const subjectExam = {};
    allScores.forEach(sc=>{
      if(!subjectCA[sc.subject])  subjectCA[sc.subject]=[];
      if(!subjectExam[sc.subject])subjectExam[sc.subject]=[];
      subjectCA[sc.subject].push(sc.ca_score||0);
      subjectExam[sc.subject].push(sc.exam_score||0);
    });
    const avgCA   = sub=>((subjectCA[sub]||[]).reduce((a,b)=>a+b,0)/((subjectCA[sub]||[1]).length)/30*100).toFixed(0);
    const avgExam = sub=>((subjectExam[sub]||[]).reduce((a,b)=>a+b,0)/((subjectExam[sub]||[1]).length)/70*100).toFixed(0);

    if(chartEl){
      chartEl.innerHTML = subjects.map(s=>`
        <div class="bar-group">
          <div class="bar ca" style="height:${avgCA(s)}%" data-val="CA: ${avgCA(s)}%"></div>
          <div class="bar exam" style="height:${avgExam(s)}%" data-val="Exam: ${avgExam(s)}%"></div>
          <div class="bar-label">${s.substring(0,7)}</div>
        </div>`).join('');
    }

    const scoreMap={};
    allScores.forEach(sc=>{
      if(!scoreMap[sc.student_id]) scoreMap[sc.student_id]={totals:[],ca:0,exam:0,count:0};
      const t=(sc.ca_score||0)+(sc.exam_score||0);
      scoreMap[sc.student_id].totals.push(t);
      scoreMap[sc.student_id].ca+=(sc.ca_score||0);
      scoreMap[sc.student_id].exam+=(sc.exam_score||0);
      scoreMap[sc.student_id].count++;
    });

    const ranked = students
      .filter(s=>scoreMap[s.id])
      .map(s=>({...s,
        avg:(scoreMap[s.id].totals.reduce((a,b)=>a+b,0)/scoreMap[s.id].totals.length).toFixed(1),
        caAvg:scoreMap[s.id].ca/scoreMap[s.id].count,
        examAvg:scoreMap[s.id].exam/scoreMap[s.id].count,
        count:scoreMap[s.id].count
      }))
      .sort((a,b)=>b.avg-a.avg);

    const topEl = document.getElementById('top-students-analysis');
    const lowEl = document.getElementById('low-students-analysis');
    if(topEl) topEl.innerHTML = ranked.slice(0,5).map((s,i)=>`
      <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(74,222,128,0.05);border:1px solid rgba(74,222,128,0.15);border-radius:12px;margin-bottom:8px;">
        <div style="width:22px;height:22px;border-radius:50%;background:var(--green-bg);border:1px solid var(--green-b);display:flex;align-items:center;justify-content:center;font-size:0.7rem;font-weight:700;color:var(--green);">${i+1}</div>
        <div style="flex:1;"><div style="font-size:0.85rem;font-weight:600;">${s.name}</div><div style="font-size:0.72rem;color:var(--muted);">${s.reg||'â€”'}</div></div>
        <div style="font-family:'Playfair Display',serif;color:var(--green);font-weight:700;">${s.avg}%</div>
      </div>`).join('');

    if(lowEl) lowEl.innerHTML = ranked.slice(-5).reverse().map(s=>`
      <div style="display:flex;align-items:center;gap:12px;padding:10px 12px;background:rgba(248,113,113,0.05);border:1px solid rgba(248,113,113,0.15);border-radius:12px;margin-bottom:8px;">
        <div style="font-size:1rem;">ğŸ¤</div>
        <div style="flex:1;"><div style="font-size:0.85rem;font-weight:600;">${s.name}</div><div style="font-size:0.72rem;color:var(--muted);">${s.reg||'â€”'}</div></div>
        <div style="font-family:'Playfair Display',serif;color:var(--red);font-weight:700;">${s.avg}%</div>
      </div>`).join('');

    const strongEl = document.getElementById('strong-subjects');
    const weakEl   = document.getElementById('weak-subjects');
    if(strongEl) strongEl.innerHTML='';
    if(weakEl) weakEl.innerHTML='';
    subjects.forEach(sub=>{
      const caP=Number(avgCA(sub)), exP=Number(avgExam(sub)), avg=((caP+exP)/2).toFixed(0);
      const bar=`<div class="h-bar-item"><div class="h-bar-top"><strong>${sub}</strong><span>${avg}% avg</span></div><div class="h-bar-track"><div class="h-bar-ca" style="width:${caP/2}%;"></div></div></div>`;
      if(avg>=65 && strongEl) strongEl.innerHTML+=bar;
      else if(avg<60 && weakEl) weakEl.innerHTML+=bar;
    });

  } catch(e){ if(chartEl) chartEl.innerHTML=`<div style="color:var(--red);">Error: ${e.message}</div>`; }
}

// â”€â”€ Bfcache logout fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('pageshow', function(e){
  if(e.persisted){
    if(!sessionStorage.getItem('adrem_user')) window.location.href='staff-login.html';
  }
});

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
