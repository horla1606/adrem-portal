<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Staff Dashboard â€” Adrem Model Academy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --purple:#7c52e8; --purple-deep:#5236c7; --purple-light:#b8a4f7;
    --purple-bg:rgba(124,82,232,0.1); --purple-b:rgba(124,82,232,0.25);
    --amber:#fbbf24; --amber-deep:#d97706; --amber-light:#fde68a;
    --amber-bg:rgba(251,191,36,0.1); --amber-b:rgba(251,191,36,0.25);
    --rose:#e8527a; --rose-deep:#c73660; --rose-light:#f7a8bf;
    --charcoal:#1a1626; --charcoal-2:#231d33; --muted:#9c8fa3; --white:#ffffff;
    --glass:rgba(255,255,255,0.06); --glass-b:rgba(255,255,255,0.11);
    --green:#4ade80; --green-bg:rgba(74,222,128,0.1); --green-b:rgba(74,222,128,0.25);
    --red:#f87171; --red-bg:rgba(248,113,113,0.1); --red-b:rgba(248,113,113,0.25);
    --blue:#60a5fa; --blue-bg:rgba(96,165,250,0.1); --blue-b:rgba(96,165,250,0.25);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white);min-height:100vh;display:flex;}

  /* SIDEBAR */
  .sidebar{width:250px;min-width:250px;background:var(--charcoal-2);border-right:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;padding:24px 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform 0.3s;overflow-y:auto;}
  .sidebar-logo{display:flex;align-items:center;gap:12px;padding:0 20px 24px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:20px;}
  .s-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--purple),var(--purple-deep));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
  .s-logo-text{font-family:'Playfair Display',serif;font-size:0.82rem;font-weight:700;line-height:1.3;}
  .s-logo-text span{display:block;font-family:'DM Sans',sans-serif;font-size:0.62rem;color:var(--purple-light);letter-spacing:1.5px;text-transform:uppercase;font-weight:400;}
  .nav-section{padding:0 12px;margin-bottom:6px;}
  .nav-label{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;padding:0 10px;margin-bottom:5px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;font-weight:500;transition:all 0.2s;cursor:pointer;border:none;background:none;width:100%;text-align:left;}
  .nav-item:hover{background:rgba(255,255,255,0.05);color:var(--white);}
  .nav-item.active{background:var(--purple-bg);color:var(--purple-light);}
  .nav-item.locked{opacity:0.5;cursor:not-allowed;}
  .nav-item .ni{font-size:0.95rem;width:18px;text-align:center;}
  .sidebar-bottom{margin-top:auto;padding:16px 12px 0;border-top:1px solid rgba(255,255,255,0.06);}
  .logout-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;text-decoration:none;transition:all 0.2s;cursor:pointer;}
  .logout-btn:hover{color:var(--red);background:var(--red-bg);}

  /* CLASS TEACHER BADGE in sidebar */
  .ct-badge{margin:0 12px 12px;padding:10px 14px;background:rgba(74,222,128,0.1);border:1px solid rgba(74,222,128,0.25);border-radius:12px;font-size:0.75rem;}
  .ct-badge strong{color:var(--green);display:block;font-size:0.82rem;margin-bottom:2px;}
  .ct-badge span{color:var(--muted);}

  /* MAIN */
  .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-height:100vh;}
  .topbar{position:sticky;top:0;z-index:40;background:rgba(26,22,38,0.97);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06);padding:14px 32px;display:flex;align-items:center;justify-content:space-between;}
  .topbar-left h2{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;}
  .topbar-left p{font-size:0.75rem;color:var(--muted);margin-top:2px;}
  .topbar-right{display:flex;align-items:center;gap:10px;}
  .staff-badge{background:var(--purple-bg);border:1px solid var(--purple-b);border-radius:50px;padding:5px 14px;font-size:0.75rem;color:var(--purple-light);}
  .staff-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--purple),var(--purple-deep));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.82rem;font-weight:700;color:white;cursor:pointer;}
  .content{padding:28px 32px;flex:1;}

  /* REUSABLES */
  .stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
  .stat-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:16px;padding:18px;transition:all 0.3s;}
  .stat-card:hover{transform:translateY(-3px);}
  .stat-card .sc-icon{font-size:1.4rem;margin-bottom:10px;}
  .stat-card .sc-val{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:3px;}
  .stat-card .sc-lbl{font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
  .stat-card.purple{border-color:var(--purple-b);background:var(--purple-bg);} .stat-card.purple .sc-val{color:var(--purple-light);}
  .stat-card.amber{border-color:var(--amber-b);background:var(--amber-bg);}   .stat-card.amber .sc-val{color:var(--amber);}
  .stat-card.green{border-color:var(--green-b);background:var(--green-bg);}   .stat-card.green .sc-val{color:var(--green);}
  .stat-card.red{border-color:var(--red-b);background:var(--red-bg);}         .stat-card.red .sc-val{color:var(--red);}
  .stat-card.blue{border-color:var(--blue-b);background:var(--blue-bg);}      .stat-card.blue .sc-val{color:var(--blue);}

  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
  .section-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;}
  .section-card-full{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;margin-bottom:20px;}
  .sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
  .sc-header h3{font-family:'Playfair Display',serif;font-size:0.95rem;font-weight:700;}

  .btn{padding:8px 18px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
  .btn:hover{transform:translateY(-2px);filter:brightness(1.1);}
  .btn-purple{background:linear-gradient(135deg,var(--purple),var(--purple-deep));color:white;box-shadow:0 4px 14px rgba(124,82,232,0.35);}
  .btn-amber{background:linear-gradient(135deg,var(--amber),var(--amber-deep));color:#1a1626;box-shadow:0 4px 14px rgba(251,191,36,0.35);}
  .btn-green{background:linear-gradient(135deg,var(--green),#22c55e);color:#1a1626;box-shadow:0 4px 14px rgba(74,222,128,0.35);}
  .btn-red{background:linear-gradient(135deg,var(--red),#ef4444);color:white;}
  .btn-sm{padding:5px 12px;font-size:0.75rem;border-radius:8px;}

  .data-table{width:100%;border-collapse:collapse;}
  .data-table th{font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:left;padding:0 12px 10px;font-weight:500;}
  .data-table td{padding:11px 12px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.83rem;vertical-align:middle;}
  .data-table tr:hover td{background:rgba(255,255,255,0.03);}

  .badge{display:inline-block;padding:3px 10px;border-radius:50px;font-size:0.7rem;font-weight:600;}
  .badge-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-b);}
  .badge-amber{background:var(--amber-bg);color:var(--amber);border:1px solid var(--amber-b);}
  .badge-red{background:var(--red-bg);color:var(--red);border:1px solid var(--red-b);}
  .badge-purple{background:var(--purple-bg);color:var(--purple-light);border:1px solid var(--purple-b);}
  .badge-blue{background:var(--blue-bg);color:var(--blue);border:1px solid var(--blue-b);}

  .perf-item{margin-bottom:12px;}
  .perf-top{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.8rem;}
  .perf-top strong{color:var(--purple-light);}
  .perf-track{width:100%;height:6px;background:rgba(255,255,255,0.06);border-radius:3px;overflow:hidden;}
  .perf-fill{height:100%;border-radius:3px;}
  .perf-fill.purple{background:linear-gradient(90deg,var(--purple),var(--purple-deep));}
  .perf-fill.amber{background:linear-gradient(90deg,var(--amber),var(--amber-deep));}
  .perf-fill.green{background:linear-gradient(90deg,#4ade80,#22c55e);}
  .perf-fill.red{background:linear-gradient(90deg,var(--red),#ef4444);}

  /* SCORE INPUTS */
  .score-input{width:60px;padding:6px 8px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:8px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;text-align:center;outline:none;transition:all 0.3s;}
  .score-input:focus{border-color:var(--purple);background:rgba(124,82,232,0.08);}

  /* ATTENDANCE TOGGLE */
  .att-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(160px,1fr));gap:10px;}
  .att-card{padding:12px 14px;border-radius:12px;cursor:pointer;transition:all 0.2s;border:1px solid rgba(255,255,255,0.08);background:rgba(74,222,128,0.08);}
  .att-card.absent{background:rgba(248,113,113,0.08);border-color:rgba(248,113,113,0.25);}
  .att-card h4{font-size:0.82rem;font-weight:600;margin-bottom:3px;}
  .att-card span{font-size:0.72rem;color:var(--muted);}
  .att-card .att-status{font-size:0.7rem;font-weight:600;margin-top:6px;}
  .att-card:not(.absent) .att-status{color:var(--green);}
  .att-card.absent .att-status{color:var(--red);}

  /* TIMETABLE */
  .tt-table{width:100%;border-collapse:collapse;font-size:0.78rem;}
  .tt-table th{padding:10px;text-align:center;font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;border-bottom:1px solid rgba(255,255,255,0.06);}
  .tt-table td{padding:10px 8px;text-align:center;border:1px solid rgba(255,255,255,0.04);vertical-align:middle;}
  .tt-period{padding:8px 6px;border-radius:8px;font-size:0.75rem;}
  .tt-period.active{background:var(--purple-bg);border:1px solid var(--purple-b);color:var(--purple-light);font-weight:600;}
  .tt-period.free{background:var(--glass);color:var(--muted);}
  .tt-period.break{background:rgba(251,191,36,0.08);border:1px solid rgba(251,191,36,0.15);color:var(--amber-light);}

  /* PSYCHOMOTOR */
  .psycho-table{width:100%;border-collapse:collapse;}
  .psycho-table th{font-size:0.68rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);padding:0 8px 10px;text-align:center;font-weight:500;}
  .psycho-table th:first-child{text-align:left;}
  .psycho-table td{padding:9px 8px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.82rem;text-align:center;}
  .psycho-table td:first-child{text-align:left;font-weight:500;white-space:nowrap;}
  .psycho-select{padding:5px 6px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:7px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.78rem;outline:none;cursor:pointer;}
  .psycho-select option{background:var(--charcoal-2);}

  /* LOCKED OVERLAY */
  .locked-overlay{background:rgba(26,22,38,0.85);border:1px solid rgba(248,113,113,0.2);border-radius:18px;padding:48px 32px;text-align:center;backdrop-filter:blur(4px);}
  .locked-overlay .lock-icon{font-size:3rem;margin-bottom:16px;}
  .locked-overlay h3{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:10px;color:var(--white);}
  .locked-overlay p{font-size:0.83rem;color:var(--muted);line-height:1.7;max-width:420px;margin:0 auto;}

  /* NOTICE */
  .notice-item{display:flex;gap:10px;padding:12px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;margin-bottom:8px;}
  .notice-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:6px;}
  .notice-dot.urgent{background:var(--red);}
  .notice-dot.normal{background:var(--purple-light);}
  .notice-dot.info{background:var(--blue);}

  .field{margin-bottom:14px;}
  .field label{display:block;font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
  .field input,.field select,.field textarea{width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.88rem;outline:none;transition:all 0.3s;}
  .field input:focus,.field select:focus{border-color:var(--purple);background:rgba(124,82,232,0.06);}
  .field select option{background:var(--charcoal-2);}

  .menu-toggle{display:none;position:fixed;top:14px;left:14px;z-index:100;background:var(--purple);border:none;border-radius:10px;padding:7px 11px;cursor:pointer;font-size:1rem;color:white;}
  .dash-footer{padding:18px 32px;border-top:1px solid rgba(255,255,255,0.06);font-size:0.72rem;color:var(--muted);text-align:center;}

  @media(max-width:1000px){.stat-row{grid-template-columns:repeat(2,1fr)}.two-col{grid-template-columns:1fr}}
  @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.menu-toggle{display:block}.topbar{padding:12px 16px 12px 56px}.content{padding:18px}}
  @media(max-width:480px){.stat-row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>

<script src="supabase.js"></script>

<button class="menu-toggle" onclick="toggleSidebar()">â˜°</button>

<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo">
    <div class="s-logo-icon">ğŸ‘©â€ğŸ«</div>
    <div class="s-logo-text">Adrem Model Academy<span>Staff Portal</span></div>
  </div>

  <!-- Class Teacher badge in sidebar -->
  <div id="ct-sidebar-badge" style="display:none;" class="ct-badge">
    <strong id="ct-badge-text">âœ… Class Teacher</strong>
    <span id="ct-badge-class"></span>
  </div>

  <div class="nav-section">
    <div class="nav-label">Overview</div>
    <button class="nav-item active" onclick="showSection('dashboard',this)"><span class="ni">ğŸ“Š</span> Dashboard</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">Academics</div>
    <button class="nav-item" onclick="showSection('scores',this)"><span class="ni">âœï¸</span> Enter Scores</button>
    <button class="nav-item" onclick="showSection('attendance',this)"><span class="ni">âœ…</span> Attendance</button>
    <!-- Psychomotor: locked if not class teacher -->
    <button class="nav-item" id="psycho-nav-btn" onclick="handlePsychoNav(this)"><span class="ni">ğŸ§ </span> Psychomotor <span id="psycho-lock-icon" style="margin-left:auto;font-size:0.75rem;">ğŸ”’</span></button>
  </div>
  <div class="nav-section">
    <div class="nav-label">My Class</div>
    <button class="nav-item" onclick="showSection('students',this)"><span class="ni">ğŸ‘¥</span> My Students</button>
    <button class="nav-item" onclick="showSection('timetable',this)"><span class="ni">ğŸ—“ï¸</span> My Timetable</button>
  </div>
  <div class="nav-section">
    <div class="nav-label">Account</div>
    <button class="nav-item" onclick="showSection('profile',this)"><span class="ni">ğŸ‘¤</span> My Profile</button>
    <button class="nav-item" onclick="showSection('password',this)"><span class="ni">ğŸ”’</span> Change Password</button>
  </div>
  <div class="sidebar-bottom">
    <button class="logout-btn" onclick="DB.logout()">ğŸšª Log Out</button>
  </div>
</aside>

<div class="main">
  <div class="topbar">
    <div class="topbar-left">
      <h2 id="page-title">Staff Dashboard</h2>
      <p>2024/2025 Session â€” First Term</p>
    </div>
    <div class="topbar-right">
      <div class="staff-badge" id="topbar-badge">ğŸ‘©â€ğŸ« Staff</div>
      <div class="staff-avatar" id="staff-avatar">FO</div>
    </div>
  </div>

  <div class="content">

    <!-- â•â• DASHBOARD â•â• -->
    <div id="section-dashboard">
      <!-- Profile Card -->
      <div class="section-card-full">
        <div style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
          <div style="width:64px;height:64px;background:linear-gradient(135deg,var(--purple),var(--purple-deep));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:700;color:white;flex-shrink:0;" id="profile-avatar-big">FO</div>
          <div style="flex:1;">
            <div style="font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;" id="profile-name">Mrs. Funke Okonkwo</div>
            <div style="font-size:0.78rem;color:var(--muted);margin-top:3px;" id="profile-meta">Mathematics Â· Joined September 2019</div>
            <div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;" id="profile-badges"></div>
          </div>
        </div>
      </div>

      <!-- Stats -->
      <div class="stat-row">
        <div class="stat-card purple"><div class="sc-icon">ğŸ‘¥</div><div class="sc-val">32</div><div class="sc-lbl">Total Students</div></div>
        <div class="stat-card green"><div class="sc-icon">âœ…</div><div class="sc-val">42</div><div class="sc-lbl">Scores Entered</div></div>
        <div class="stat-card amber"><div class="sc-icon">â³</div><div class="sc-val">16</div><div class="sc-lbl">Scores Pending</div></div>
        <div class="stat-card blue"><div class="sc-icon">ğŸ“Š</div><div class="sc-val">94%</div><div class="sc-lbl">Avg Attendance</div></div>
      </div>

      <!-- Class Teacher section (only shows if class teacher) -->
      <div id="ct-section" style="display:none;">
        <div class="section-card-full" style="background:rgba(74,222,128,0.06);border-color:rgba(74,222,128,0.2);">
          <div class="sc-header"><h3>ğŸ« My Class Overview</h3><span id="ct-class-label"></span></div>
          <div class="stat-row">
            <div class="stat-card green"><div class="sc-icon">ğŸ‘©â€ğŸ“</div><div class="sc-val">32</div><div class="sc-lbl">Total Pupils</div></div>
            <div class="stat-card purple"><div class="sc-icon">ğŸ“Š</div><div class="sc-val">72%</div><div class="sc-lbl">Class Average</div></div>
            <div class="stat-card amber"><div class="sc-icon">ğŸ†</div><div class="sc-val">5</div><div class="sc-lbl">Top Performers</div></div>
            <div class="stat-card red"><div class="sc-icon">ğŸ¤</div><div class="sc-val">4</div><div class="sc-lbl">Need Support</div></div>
          </div>
        </div>
      </div>

      <!-- Subjects + Top students -->
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“š My Subjects</h3></div>
          <div style="display:flex;flex-direction:column;gap:10px;">
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;display:flex;align-items:center;justify-content:space-between;">
              <div><div style="font-size:0.85rem;font-weight:600;">Mathematics</div><div style="font-size:0.72rem;color:var(--muted);">JSS 2A Â· 32 students</div></div>
              <span class="badge badge-green">âœ… Scores Entered</span>
            </div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;display:flex;align-items:center;justify-content:space-between;">
              <div><div style="font-size:0.85rem;font-weight:600;">Further Mathematics</div><div style="font-size:0.72rem;color:var(--muted);">SS 2A Â· 20 students</div></div>
              <span class="badge badge-amber">â³ CA Only</span>
            </div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;display:flex;align-items:center;justify-content:space-between;">
              <div><div style="font-size:0.85rem;font-weight:600;">Mathematics</div><div style="font-size:0.72rem;color:var(--muted);">JSS 2B Â· 30 students</div></div>
              <span class="badge badge-amber">â³ Not Yet Entered</span>
            </div>
          </div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ† Top Students â€” JSS 2A</h3></div>
          <div style="display:flex;flex-direction:column;gap:8px;">
            <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--glass);border-radius:10px;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--green-bg);border:1px solid var(--green-b);display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--green);">1</div>
              <div style="flex:1;font-size:0.83rem;font-weight:500;">Adeyemi Aisha</div>
              <div style="font-family:'Playfair Display',serif;color:var(--green);font-weight:700;">88%</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--glass);border-radius:10px;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--green-bg);border:1px solid var(--green-b);display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--green);">2</div>
              <div style="flex:1;font-size:0.83rem;font-weight:500;">Babatunde Olamide</div>
              <div style="font-family:'Playfair Display',serif;color:var(--green);font-weight:700;">84%</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--glass);border-radius:10px;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--amber-bg);border:1px solid var(--amber-b);display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--amber);">3</div>
              <div style="flex:1;font-size:0.83rem;font-weight:500;">Chukwu Faith</div>
              <div style="font-family:'Playfair Display',serif;color:var(--amber);font-weight:700;">76%</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--glass);border-radius:10px;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--amber-bg);border:1px solid var(--amber-b);display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--amber);">4</div>
              <div style="flex:1;font-size:0.83rem;font-weight:500;">Dada Nifemi</div>
              <div style="font-family:'Playfair Display',serif;color:var(--amber);font-weight:700;">72%</div>
            </div>
            <div style="display:flex;align-items:center;gap:10px;padding:9px 12px;background:var(--glass);border-radius:10px;">
              <div style="width:24px;height:24px;border-radius:50%;background:var(--amber-bg);border:1px solid var(--amber-b);display:flex;align-items:center;justify-content:center;font-size:0.72rem;font-weight:700;color:var(--amber);">5</div>
              <div style="flex:1;font-size:0.83rem;font-weight:500;">Eze Kingsley</div>
              <div style="font-family:'Playfair Display',serif;color:var(--amber);font-weight:700;">68%</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Notices -->
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ“¢ School Notices</h3><span>From Admin</span></div>
        <div id="notices-container">
          <div style="color:var(--muted);font-size:0.83rem;padding:8px 0;">Loading notices...</div>
        </div>
      </div>
    </div>

    <!-- â•â• ENTER SCORES â•â• -->
    <div id="section-scores" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header">
          <h3>âœï¸ Enter Scores</h3>
          <div style="display:flex;gap:8px;flex-wrap:wrap;">
            <select id="subject-selector" style="padding:7px 12px;background:var(--glass);border:1px solid var(--glass-b);border-radius:9px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.82rem;outline:none;" onchange="onSubjectChange()"></select>
            <button id="save-scores-btn" class="btn btn-purple" onclick="saveAllScores()">ğŸ’¾ Save All Scores</button>
          </div>
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead><tr><th>Student Name</th><th>Reg Number</th><th>CA (max 30)</th><th>Exam (max 70)</th><th>Total</th><th>Grade</th><th>Status</th></tr></thead>
            <tbody id="score-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• ATTENDANCE â•â• -->
    <div id="section-attendance" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header">
          <h3>âœ… Mark Attendance</h3>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap;">
            <span id="att-date" style="font-size:0.78rem;color:var(--muted);"></span>
            <span id="att-present-count" class="badge badge-green">Present: 0</span>
            <span id="att-absent-count" class="badge badge-red">Absent: 0</span>
          </div>
        </div>
        <div style="background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;padding:10px 14px;margin-bottom:16px;font-size:0.78rem;color:var(--muted);">
          Click a student card to toggle between Present âœ… and Absent âŒ
        </div>
        <div class="att-grid" id="att-grid"></div>
        <div style="margin-top:18px;">
          <button id="save-att-btn" class="btn btn-purple" onclick="saveAttendance()">ğŸ’¾ Save Attendance</button>
        </div>
      </div>
    </div>

    <!-- â•â• PSYCHOMOTOR â€” CLASS TEACHER ONLY â•â• -->
    <div id="section-psychomotor" style="display:none;">

      <!-- LOCKED STATE (shown if NOT class teacher) -->
      <div id="psycho-locked" style="display:none;">
        <div class="locked-overlay">
          <div class="lock-icon">ğŸ”’</div>
          <h3>Class Teachers Only</h3>
          <p>The Psychomotor & Affective Assessment section is exclusively for <strong>designated Class Teachers</strong>. This section allows you to grade your students on behaviour, conduct, and extracurricular participation.</p>
          <p style="margin-top:12px;">If you believe this is an error, please contact the School Admin to verify your class teacher assignment.</p>
        </div>
      </div>

      <!-- UNLOCKED STATE (shown if IS class teacher) -->
      <div id="psycho-unlocked" style="display:none;">
        <div class="section-card-full">
          <div class="sc-header">
            <div>
              <h3>ğŸ§  Psychomotor & Affective Assessment</h3>
              <div style="font-size:0.75rem;color:var(--muted);margin-top:4px;" id="psycho-class-label"></div>
            </div>
            <div style="display:flex;gap:8px;flex-wrap:wrap;">
              <span id="psycho-submit-badge" class="badge badge-amber">â³ Not Yet Submitted</span>
              <button id="save-psycho-btn" class="btn btn-purple" onclick="savePsychomotor()">ğŸ’¾ Save Draft</button>
              <button id="submit-psycho-btn" class="btn btn-green" onclick="submitPsychomotor()">ğŸ“¤ Submit to Admin</button>
            </div>
          </div>

          <div style="background:rgba(124,82,232,0.08);border:1px solid rgba(124,82,232,0.2);border-radius:12px;padding:14px 16px;margin-bottom:16px;font-size:0.82rem;color:var(--muted);line-height:1.7;">
            ğŸ“‹ <strong style="color:var(--purple-light);">Instructions:</strong> Grade each student on the traits below. Use 5 = Excellent down to 1 = Poor. Once you click <em>Submit to Admin</em>, these grades will be sent for Admin approval and will appear on each student's printed result sheet. You can save a draft at any time without submitting.
          </div>

          <div style="font-size:0.75rem;margin-bottom:14px;display:flex;gap:16px;flex-wrap:wrap;">
            <span style="color:var(--green);">5 = Excellent</span>
            <span style="color:var(--blue);">4 = Very Good</span>
            <span style="color:var(--amber);">3 = Good</span>
            <span style="color:var(--rose-light);">2 = Fair</span>
            <span style="color:var(--red);">1 = Poor</span>
          </div>

          <div style="overflow-x:auto;">
            <table class="psycho-table">
              <thead>
                <tr>
                  <th style="min-width:140px;text-align:left;">Student Name</th>
                  <th>Punctuality</th>
                  <th>Attentiveness</th>
                  <th>Neatness</th>
                  <th>Politeness</th>
                  <th>Honesty</th>
                  <th>Sports/<br>Games</th>
                  <th>Clubs/<br>Societies</th>
                  <th>Creativity</th>
                  <th>Leadership</th>
                  <th>Overall<br>Conduct</th>
                </tr>
              </thead>
              <tbody id="psycho-tbody"></tbody>
            </table>
          </div>

          <div style="margin-top:14px;padding:12px 14px;background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.18);border-radius:10px;font-size:0.78rem;color:var(--muted);">
            âš ï¸ Once submitted, Admin will review and approve your grades. After approval, grades are locked and appear on student result sheets. If corrections are needed after submission, contact the Admin.
          </div>
        </div>
      </div>

    </div>

    <!-- â•â• MY STUDENTS â•â• -->
    <div id="section-students" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ‘¥ My Students</h3><span id="students-class-label"></span></div>
        <div style="overflow-x:auto;">
          <table class="data-table">
            <thead><tr><th>Student Name</th><th>Reg Number</th><th>Class</th><th>Overall Avg</th><th>Status</th></tr></thead>
            <tbody id="students-tbody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• TIMETABLE â•â• -->
    <div id="section-timetable" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>ğŸ—“ï¸ My Weekly Timetable</h3><span>2024/2025 Â· First Term</span></div>
        <div style="overflow-x:auto;">
          <table class="tt-table">
            <thead>
              <tr>
                <th>Time</th><th>Monday</th><th>Tuesday</th><th>Wednesday</th><th>Thursday</th><th>Friday</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;white-space:nowrap;">7:30â€“8:00</td>
                <td colspan="5"><div class="tt-period break">Assembly</div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">8:00â€“8:40</td>
                <td><div class="tt-period active">Maths<br><small>JSS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2B</small></div></td>
                <td><div class="tt-period active">F.Maths<br><small>SS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">8:40â€“9:20</td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">F.Maths<br><small>SS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2A</small></div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">9:20â€“10:00</td>
                <td><div class="tt-period active">Maths<br><small>JSS 2B</small></div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2A</small></div></td>
                <td><div class="tt-period active">F.Maths<br><small>SS 2A</small></div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2B</small></div></td>
                <td><div class="tt-period free">Free</div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">10:00â€“10:20</td>
                <td colspan="5"><div class="tt-period break">Short Break</div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">10:20â€“11:00</td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2B</small></div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">F.Maths<br><small>SS 2A</small></div></td>
              </tr>
              <tr>
                <td style="color:var(--muted);font-size:0.72rem;">11:00â€“11:40</td>
                <td><div class="tt-period active">F.Maths<br><small>SS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period free">Free</div></td>
                <td><div class="tt-period active">Maths<br><small>JSS 2A</small></div></td>
                <td><div class="tt-period free">Free</div></td>
              </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- â•â• PROFILE â•â• -->
    <div id="section-profile" style="display:none;">
      <div class="two-col">
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ‘¤ Personal Information</h3></div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Full Name</div>
              <div id="pf-name" style="font-size:0.88rem;font-weight:500;">Mrs. Funke Okonkwo</div>
            </div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Phone Number (Login ID)</div>
              <div id="pf-phone" style="font-size:0.88rem;font-weight:500;">08012345678</div>
            </div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Qualification</div>
              <div id="pf-qual" style="font-size:0.88rem;font-weight:500;">B.Ed Mathematics</div>
            </div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Date Joined</div>
              <div id="pf-join" style="font-size:0.88rem;font-weight:500;">September 2019</div>
            </div>
          </div>
        </div>
        <div class="section-card">
          <div class="sc-header"><h3>ğŸ“‹ Role Information</h3></div>
          <div style="display:flex;flex-direction:column;gap:12px;">
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Subjects Teaching</div>
              <div id="pf-subjects" style="font-size:0.88rem;font-weight:500;">Mathematics, Further Mathematics</div>
            </div>
            <div id="pf-ct-box" style="padding:12px 14px;border-radius:10px;"></div>
            <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;">
              <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Role</div>
              <div style="font-size:0.88rem;font-weight:500;">Teaching Staff</div>
            </div>
          </div>
          <div style="margin-top:14px;padding:12px 14px;background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.18);border-radius:10px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
            âš ï¸ To update your name, phone, or class teacher assignment, contact the School Admin. You can only change your password yourself.
          </div>
        </div>
      </div>
    </div>

    <!-- â•â• CHANGE PASSWORD â•â• -->
    <div id="section-password" style="display:none;">
      <div class="section-card" style="max-width:480px;">
        <div class="sc-header"><h3>ğŸ”’ Change Password</h3></div>
        <div class="field"><label>Current Password</label><input type="password" id="pw-current" placeholder="Enter current password"></div>
        <div class="field"><label>New Password</label><input type="password" id="pw-new" placeholder="Enter new password"></div>
        <div class="field"><label>Confirm New Password</label><input type="password" id="pw-confirm" placeholder="Repeat new password"></div>
        <div id="pw-msg" style="padding:10px 14px;border-radius:8px;font-size:0.78rem;margin-bottom:12px;display:none;"></div>
        <div style="background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;padding:12px 14px;margin-bottom:14px;font-size:0.78rem;color:var(--muted);line-height:1.7;">
          ğŸ’¡ Default password is your surname. Choose a strong password and keep it safe.
        </div>
        <button class="btn btn-purple" style="width:100%;" onclick="changePassword()">ğŸ”’ Update Password</button>
      </div>
    </div>

  </div>
  <div class="dash-footer">Â© 2026 Adrem Model Academy Staff Portal â€” Apomu, Osun State</div>
</div>

<div id="toast" style="position:fixed;bottom:28px;right:28px;background:#231d33;border:1px solid rgba(124,82,232,0.3);border-radius:12px;padding:12px 18px;font-size:0.83rem;color:var(--white);z-index:500;opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;max-width:300px;"></div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STAFF DASHBOARD â€” Full Supabase Backend Integration
//  All data reads and writes go through supabase.js (DB object)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

let STAFF = null;        // logged-in staff member (from session)
let SETTINGS = {};       // school settings (term, session)
let STUDENTS = [];       // students in the currently selected class
let ALL_MY_CLASSES = []; // all classes this staff member teaches (for score dropdown)
let CURRENT_CLASS = '';  // class currently selected in the score entry dropdown
let SCORES = [];         // current scores for selected subject/class
let ATT_STATE = [];      // attendance toggle state [ true=present, false=absent ]
let PSYCHO_DATA = {};    // { studentId: { punctuality:3, ... } }

const PSYCHO_TRAITS = [
  { key:'punctuality',  label:'Punctuality'     },
  { key:'attentiveness',label:'Attentiveness'   },
  { key:'neatness',     label:'Neatness'        },
  { key:'politeness',   label:'Politeness'      },
  { key:'honesty',      label:'Honesty'         },
  { key:'sports',       label:'Sports/Games'    },
  { key:'clubs',        label:'Clubs/Societies' },
  { key:'creativity',   label:'Creativity'      },
  { key:'leadership',   label:'Leadership'      },
  { key:'conduct',      label:'Overall Conduct' },
];

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// Grade helpers â€” DB.gradeFor() picks JSS or SS scale based on class name
function gradeFromTotal(t, className){
  return DB.gradeFor(className || CURRENT_CLASS || '', t);
}
function gradeColor(t){ return t>=70?'var(--green)':t>=40?'var(--amber)':'var(--red)'; }
function gradeClass(t, className){
  return DB.gradeClassFor(className || CURRENT_CLASS || '', t);
}
function showToast(msg,ok){
  const t=document.getElementById('toast');
  t.textContent = (ok===false ? 'âŒ ' : 'âœ… ') + msg;
  t.style.opacity='1'; t.style.transform='translateY(0)';
  setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateY(10px)'; }, 3500);
}
function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); }

// â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const allSections = ['dashboard','scores','attendance','psychomotor','students','timetable','profile','password'];
const titles = {
  dashboard:'Staff Dashboard', scores:'Enter Scores', attendance:'Mark Attendance',
  psychomotor:'Psychomotor & Affective Assessment', students:'My Students',
  timetable:'My Timetable', profile:'My Profile', password:'Change Password'
};
function showSection(name, el){
  allSections.forEach(s=>{ const e=document.getElementById('section-'+s); if(e) e.style.display=s===name?'block':'none'; });
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
  document.getElementById('page-title').textContent = titles[name]||name;
}
function handlePsychoNav(el){
  showSection('psychomotor', el);
  if(!STAFF || !STAFF.isClassTeacher){
    document.getElementById('psycho-locked').style.display='block';
    document.getElementById('psycho-unlocked').style.display='none';
    showToast('âš ï¸ This section is for Class Teachers only', false);
  } else {
    document.getElementById('psycho-locked').style.display='none';
    document.getElementById('psycho-unlocked').style.display='block';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT â€” runs on page load
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function init(){
  // 1. Allow both 'staff' AND 'admin' (admin can view/edit via staff dashboard)
  STAFF = DB.requireAuth(['staff', 'admin']);
  if(!STAFF) return;

  // Cross-tab logout support
  DB.listenForLogout();

  // 2. Load school settings
  SETTINGS = await DB.getSettings();
  const termLabel = (SETTINGS.term||'First Term') + ' ' + (SETTINGS.session||'2024/2025') + ' Session';

  // 3. Build ALL_MY_CLASSES list â€” used for the score-entry class dropdown
  // teaching_classes column: comma-separated list of classes this staff teaches
  // Falls back to assigned_class if teaching_classes not set
  if (STAFF.teachingClasses) {
    ALL_MY_CLASSES = STAFF.teachingClasses.split(',').map(c => c.trim()).filter(Boolean);
  } else if (STAFF.assignedClass) {
    ALL_MY_CLASSES = [STAFF.assignedClass];
  } else {
    ALL_MY_CLASSES = [];
  }
  CURRENT_CLASS = ALL_MY_CLASSES[0] || '';

  // 4. Populate UI from session data
  const staffInits = DB.initials(STAFF.name);
  document.getElementById('staff-avatar').textContent = staffInits;
  document.getElementById('profile-avatar-big').textContent = staffInits;
  document.getElementById('profile-name').textContent = STAFF.name;
  document.getElementById('profile-meta').textContent = (STAFF.subjects||'Teaching Staff') + ' Â· Joined ' + (STAFF.joinDate||'â€”');
  document.getElementById('topbar-badge').textContent = 'ğŸ‘©â€ğŸ« ' + (STAFF.isClassTeacher ? 'Class Teacher' : 'Staff');
  document.querySelector('.topbar-left p').textContent = termLabel;

  document.getElementById('pf-name').textContent = STAFF.name;
  document.getElementById('pf-phone').textContent = STAFF.phone || 'â€”';
  document.getElementById('pf-qual').textContent = STAFF.qualification || 'â€”';
  document.getElementById('pf-subjects').textContent = STAFF.subjects || 'â€”';
  document.getElementById('pf-join').textContent = STAFF.joinDate || 'â€”';

  const badgesEl = document.getElementById('profile-badges');
  badgesEl.innerHTML = `<span class="badge badge-purple">ğŸ‘©â€ğŸ« Staff</span>`;

  if(STAFF.isClassTeacher && STAFF.assignedClass){
    badgesEl.innerHTML += `<span class="badge badge-green">âœ… Class Teacher â€” ${STAFF.assignedClass}</span>`;
    document.getElementById('pf-ct-box').innerHTML = `
      <div style="background:var(--green-bg);border:1px solid var(--green-b);border-radius:10px;padding:12px 14px;">
        <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Class Teacher</div>
        <div style="font-size:0.88rem;font-weight:600;color:var(--green);">âœ… ${STAFF.assignedClass} â€” Assigned by Admin</div>
      </div>`;
    document.getElementById('ct-sidebar-badge').style.display = 'block';
    document.getElementById('ct-badge-text').textContent = 'âœ… Class Teacher';
    document.getElementById('ct-badge-class').textContent = STAFF.assignedClass;
    document.getElementById('ct-section').style.display = 'block';
    document.getElementById('ct-class-label').textContent = STAFF.assignedClass;
    document.getElementById('psycho-lock-icon').textContent = 'ğŸ”“';
  } else {
    document.getElementById('pf-ct-box').innerHTML = `
      <div style="background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;padding:12px 14px;">
        <div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">Class Teacher</div>
        <div style="font-size:0.88rem;color:var(--muted);">Not assigned</div>
      </div>`;
  }

  // 5. Build subject + class selectors
  buildSubjectSelector();

  // 6. Load all dashboard data
  await loadDashboardData();
}

// â”€â”€ Load all data needed for the dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadDashboardData(){
  try {
    // Load students for the currently selected class (CURRENT_CLASS)
    if(CURRENT_CLASS){
      STUDENTS = await DB.getClassStudents(CURRENT_CLASS);
    } else {
      STUDENTS = [];
    }

    // Attendance + psychomotor only apply to the class teacher's assigned class
    if(STAFF.isClassTeacher && STAFF.assignedClass){
      const today = DB.today();
      const existingAtt = await DB.getClassAttendanceByDate(STAFF.assignedClass, today);
      // Build ATT_STATE against the assignedClass students
      const attStudents = STAFF.assignedClass === CURRENT_CLASS
        ? STUDENTS
        : await DB.getClassStudents(STAFF.assignedClass);
      ATT_STATE = attStudents.map(s=>{
        const rec = existingAtt.find(a=>a.student_id===s.id);
        return rec ? rec.status === 'present' : true;
      });

      // Load existing psychomotor data
      const psychoRows = await DB.getClassPsychomotor(
        STAFF.assignedClass, SETTINGS.term, SETTINGS.session
      );
      PSYCHO_DATA = {};
      // Coerce all trait values to Number to fix pre-selection bug
      psychoRows.forEach(row=>{
        const cleaned = { ...row };
        ['punctuality','attentiveness','neatness','politeness','honesty',
         'sports','clubs','creativity','leadership','conduct'].forEach(k=>{
          if (cleaned[k] !== undefined) cleaned[k] = Number(cleaned[k]);
        });
        PSYCHO_DATA[row.student_id] = cleaned;
      });

      const submitted = psychoRows.find(r=>r.status==='submitted'||r.status==='approved');
      if(submitted){
        const badge = document.getElementById('psycho-submit-badge');
        if(submitted.status==='approved'){
          badge.className='badge badge-green'; badge.textContent='âœ… Approved by Admin';
        } else {
          badge.className='badge badge-blue'; badge.textContent='ğŸ“¤ Submitted â€” Awaiting Approval';
        }
      }

      const clsLabel = STAFF.assignedClass + ' Â· ' + STUDENTS.length + ' students';
      document.getElementById('students-class-label').textContent = clsLabel;
      document.getElementById('psycho-class-label').textContent = 'Class: ' + clsLabel;
      document.getElementById('ct-class-label').textContent = clsLabel;
    } else {
      ATT_STATE = [];
      document.getElementById('students-class-label').textContent = CURRENT_CLASS
        ? CURRENT_CLASS + ' Â· ' + STUDENTS.length + ' students'
        : 'Not assigned to a class';
    }

    // Load scores for the current selection, then render everything
    await loadScoresForCurrentSelection();

    renderScoreTable();
    renderAttendance();
    renderPsychomotor();
    await renderStudents();   // awaited so it doesn't race with other DB calls
    await loadNotices();
    updateDashboardStats();

  } catch(err){
    console.error('Error loading dashboard data:', err);
    showToast('Could not load data. Please refresh.', false);
  }
}

// â”€â”€ Dashboard Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateDashboardStats(){
  // Count how many scores have been entered this term for this staff member's subjects
  try {
    if(STAFF.assignedClass){
      const allScores = await DB.getAllClassScores(STAFF.assignedClass, SETTINGS.term, SETTINGS.session);
      const subjects = (STAFF.subjects||'').split(',').map(s=>s.trim()).filter(Boolean);
      const expectedTotal = STUDENTS.length * subjects.length;
      const entered = allScores.length;
      const pending = Math.max(0, expectedTotal - entered);

      document.querySelector('.stat-card.purple .sc-val').textContent = STUDENTS.length;
      document.querySelector('.stat-card.green .sc-val').textContent = entered;
      document.querySelector('.stat-card.amber .sc-val').textContent = pending;

      // Class average from scores
      if(allScores.length){
        const avgs = {};
        allScores.forEach(sc=>{
          if(!avgs[sc.student_id]) avgs[sc.student_id] = [];
          avgs[sc.student_id].push((sc.ca_score||0)+(sc.exam_score||0));
        });
        const classAvg = (Object.values(avgs).map(a=>a.reduce((x,y)=>x+y,0)/a.length).reduce((x,y)=>x+y,0)/Object.keys(avgs).length).toFixed(0);
        document.querySelector('.stat-card.blue .sc-val').textContent = classAvg+'%';

        // Class overview card stats
        const topPerformers = Object.values(avgs).filter(a=>a.reduce((x,y)=>x+y,0)/a.length>=70).length;
        const needSupport = Object.values(avgs).filter(a=>a.reduce((x,y)=>x+y,0)/a.length<50).length;
        const ctCards = document.querySelectorAll('#ct-section .sc-val');
        if(ctCards[0]) ctCards[0].textContent = STUDENTS.length;
        if(ctCards[1]) ctCards[1].textContent = classAvg+'%';
        if(ctCards[2]) ctCards[2].textContent = topPerformers;
        if(ctCards[3]) ctCards[3].textContent = needSupport;
      }
    }
  } catch(e){ /* non-critical */ }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCORES SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Build the subject selector AND class selector for score entry.
// Teachers who teach multiple classes see a class dropdown that reloads
// the score table when changed. Each option value is "Subject|ClassName".
function buildSubjectSelector(){
  const sel = document.getElementById('subject-selector');
  if(!sel) return;
  const subjects = (STAFF.subjects||'').split(',').map(s=>s.trim()).filter(Boolean);

  if(!subjects.length || !ALL_MY_CLASSES.length){
    sel.innerHTML = '<option value="">No subjects/classes assigned â€” contact Admin</option>';
    return;
  }

  // Build one option per subject Ã— class combination
  // For a teacher with one class, this is just a list of subjects.
  // For a teacher with multiple classes, each subject appears once per class.
  const options = [];
  subjects.forEach(subj => {
    ALL_MY_CLASSES.forEach(cls => {
      options.push(`<option value="${subj}|${cls}">${subj} â€” ${cls}</option>`);
    });
  });
  sel.innerHTML = options.join('');

  // Set CURRENT_CLASS to the class in the currently selected option
  if(sel.value){
    CURRENT_CLASS = sel.value.split('|')[1] || ALL_MY_CLASSES[0] || '';
  }
}

// Load scores from Supabase for the currently selected subject/class.
// Also updates CURRENT_CLASS and reloads STUDENTS if the class changed.
async function loadScoresForCurrentSelection(){
  const sel = document.getElementById('subject-selector');
  if(!sel || !sel.value) return;
  const [subject, className] = sel.value.split('|');

  // If the class changed, reload students for the new class
  if(className && className !== CURRENT_CLASS){
    CURRENT_CLASS = className;
    STUDENTS = await DB.getClassStudents(className);
  }

  try {
    SCORES = await DB.getClassScores(className, subject, SETTINGS.term, SETTINGS.session);
  } catch(e){
    SCORES = [];
  }
}

// Render the score entry table with real student data
function renderScoreTable(){
  const tbody = document.getElementById('score-tbody');
  if(!tbody) return;

  if(!STUDENTS.length){
    tbody.innerHTML = `<tr><td colspan="7" style="padding:20px;color:var(--muted);text-align:center;">No students found for ${CURRENT_CLASS || 'your class'}. Contact admin to assign students.</td></tr>`;
    return;
  }

  tbody.innerHTML = STUDENTS.map(student=>{
    const existing = SCORES.find(sc=>sc.student_id===student.id);
    const ca   = existing ? (existing.ca_score   ?? '') : '';
    const exam = existing ? (existing.exam_score ?? '') : '';
    const total = (ca !== '' && exam !== '') ? Number(ca)+Number(exam) : null;
    const grade = total !== null ? gradeFromTotal(total, CURRENT_CLASS) : 'â€”';
    const gc    = total !== null ? gradeColor(total) : 'var(--muted)';
    const statusBadge = existing
      ? `<span class="badge badge-green">âœ… Saved</span>`
      : `<span class="badge badge-amber">â³ Not entered</span>`;

    return `<tr>
      <td style="font-weight:500;">${student.name}</td>
      <td style="color:var(--muted);font-size:0.78rem;">${student.reg}</td>
      <td><input class="score-input" type="number" min="0" max="30" value="${ca}"
           data-student-id="${student.id}" data-type="ca"
           oninput="liveUpdateRow(this)"></td>
      <td><input class="score-input" type="number" min="0" max="70" value="${exam}"
           data-student-id="${student.id}" data-type="exam"
           oninput="liveUpdateRow(this)"></td>
      <td id="total-${student.id}" style="font-weight:700;">${total !== null ? total : 'â€”'}</td>
      <td id="grade-${student.id}" style="color:${gc};font-weight:700;">${grade}</td>
      <td id="status-${student.id}">${statusBadge}</td>
    </tr>`;
  }).join('');
}

// Live-update total + grade as user types (no DB call)
function liveUpdateRow(input){
  const studentId = input.dataset.studentId;
  const row = input.closest('tr');
  const caInput   = row.querySelector('[data-type="ca"]');
  const examInput = row.querySelector('[data-type="exam"]');
  const ca   = Number(caInput.value)   || 0;
  const exam = Number(examInput.value) || 0;
  const total = ca + exam;
  const totalEl  = document.getElementById('total-' + studentId);
  const gradeEl  = document.getElementById('grade-' + studentId);
  const statusEl = document.getElementById('status-' + studentId);
  if(totalEl) totalEl.textContent = total;
  if(gradeEl){
    gradeEl.textContent  = gradeFromTotal(total, CURRENT_CLASS);
    gradeEl.style.color  = gradeColor(total);
  }
  if(statusEl) statusEl.innerHTML = `<span class="badge badge-amber">â³ Unsaved</span>`;
}

// Save All Scores button â€” writes everything to Supabase
async function saveAllScores(){
  const sel = document.getElementById('subject-selector');
  if(!sel || !sel.value){ showToast('Please select a subject first.', false); return; }
  const [subject, className] = sel.value.split('|');

  const rows = document.querySelectorAll('#score-tbody tr');
  const scoreRows = [];

  rows.forEach(row=>{
    const caInput = row.querySelector('[data-type="ca"]');
    const examInput = row.querySelector('[data-type="exam"]');
    if(!caInput || !examInput) return;
    const studentId = caInput.dataset.studentId;
    const ca = Number(caInput.value)||0;
    const exam = Number(examInput.value)||0;
    // Validate
    if(ca < 0 || ca > 30){ caInput.style.borderColor='var(--red)'; return; }
    if(exam < 0 || exam > 70){ examInput.style.borderColor='var(--red)'; return; }
    caInput.style.borderColor='';
    examInput.style.borderColor='';
    scoreRows.push({
      student_id: studentId,
      subject: subject,
      class_name: className,
      ca_score: ca,
      exam_score: exam,
      term: SETTINGS.term || 'First Term',
      session: SETTINGS.session || '2024/2025',
    });
  });

  if(!scoreRows.length){ showToast('No valid scores to save.', false); return; }

  // Disable button during save
  const btn = document.getElementById('save-scores-btn');
  if(btn){ btn.disabled=true; btn.textContent='Saving...'; }

  try {
    await DB.saveScoresBulk(scoreRows);
    // Reload scores to update status badges
    SCORES = await DB.getClassScores(className, subject, SETTINGS.term, SETTINGS.session);
    renderScoreTable();
    await updateDashboardStats();
    showToast('All scores saved successfully!');
    await DB.logActivity('Scores saved', `${subject} â€” ${className} by ${STAFF.name}`, STAFF.id);
  } catch(err){
    console.error(err);
    showToast('Error saving scores: ' + err.message, false);
  } finally {
    if(btn){ btn.disabled=false; btn.textContent='ğŸ’¾ Save All Scores'; }
  }
}

// When subject/class selector changes â€” reload students & scores, then re-render
async function onSubjectChange(){
  await loadScoresForCurrentSelection();
  renderScoreTable();
  // If the class changed, also refresh the student list tab
  await renderStudents();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTENDANCE SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderAttendance(){
  const grid = document.getElementById('att-grid');
  const dateEl = document.getElementById('att-date');

  // Show today's date
  const today = new Date();
  const dateStr = today.toLocaleDateString('en-NG',{weekday:'short',day:'numeric',month:'short',year:'numeric'});
  if(dateEl) dateEl.textContent = dateStr;

  if(!STUDENTS.length){
    grid.innerHTML = `<div style="color:var(--muted);font-size:0.83rem;padding:12px 0;">No students found for your class. Contact admin.</div>`;
    return;
  }

  // Ensure ATT_STATE has right length
  while(ATT_STATE.length < STUDENTS.length) ATT_STATE.push(true);

  grid.innerHTML = STUDENTS.map((s,i)=>`
    <div class="att-card ${ATT_STATE[i]?'':'absent'}" onclick="toggleAtt(${i})" id="att-card-${i}">
      <h4>${s.name}</h4>
      <span style="color:var(--muted);font-size:0.72rem;">${s.reg}</span>
      <div class="att-status">${ATT_STATE[i]?'âœ… Present':'âŒ Absent'}</div>
    </div>`).join('');

  updateAttCount();
}

function toggleAtt(i){
  ATT_STATE[i] = !ATT_STATE[i];
  const card = document.getElementById('att-card-'+i);
  card.classList.toggle('absent');
  card.querySelector('.att-status').textContent = ATT_STATE[i] ? 'âœ… Present' : 'âŒ Absent';
  updateAttCount();
}

function updateAttCount(){
  const p = ATT_STATE.filter(Boolean).length;
  document.getElementById('att-present-count').textContent = `Present: ${p}`;
  document.getElementById('att-absent-count').textContent = `Absent: ${ATT_STATE.length-p}`;
}

// Save Attendance button â€” writes to Supabase
async function saveAttendance(){
  if(!STAFF.isClassTeacher || !STAFF.assignedClass){
    showToast('Only class teachers can save attendance.', false); return;
  }
  if(!STUDENTS.length){
    showToast('No students to save attendance for.', false); return;
  }

  const today = DB.today();
  const records = STUDENTS.map((s,i)=>({
    student_id: s.id,
    class_name: STAFF.assignedClass,
    date: today,
    status: ATT_STATE[i] ? 'present' : 'absent',
    term: SETTINGS.term || 'First Term',
    session: SETTINGS.session || '2024/2025',
  }));

  const btn = document.getElementById('save-att-btn');
  if(btn){ btn.disabled=true; btn.textContent='Saving...'; }

  try {
    await DB.saveAttendanceBulk(records);
    showToast('Attendance saved for today!');
    await DB.logActivity('Attendance saved', `${STAFF.assignedClass} on ${today} by ${STAFF.name}`, STAFF.id);
  } catch(err){
    console.error(err);
    showToast('Error saving attendance: ' + err.message, false);
  } finally {
    if(btn){ btn.disabled=false; btn.textContent='ğŸ’¾ Save Attendance'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PSYCHOMOTOR SECTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

function renderPsychomotor(){
  const tbody = document.getElementById('psycho-tbody');
  if(!tbody || !STAFF.isClassTeacher) return;

  if(!STUDENTS.length){
    tbody.innerHTML = `<tr><td colspan="${PSYCHO_TRAITS.length+1}" style="padding:20px;color:var(--muted);">No students found for your class.</td></tr>`;
    return;
  }

  tbody.innerHTML = STUDENTS.map(student=>{
    const existing = PSYCHO_DATA[student.id] || {};
    const selects = PSYCHO_TRAITS.map(trait=>{
      const val = existing[trait.key] || 3;
      return `<td><select class="psycho-select" data-student-id="${student.id}" data-trait="${trait.key}">
        <option value="5" ${val===5?'selected':''}>5</option>
        <option value="4" ${val===4?'selected':''}>4</option>
        <option value="3" ${val===3?'selected':''}>3</option>
        <option value="2" ${val===2?'selected':''}>2</option>
        <option value="1" ${val===1?'selected':''}>1</option>
      </select></td>`;
    }).join('');
    return `<tr><td style="font-weight:500;white-space:nowrap;">${student.name}</td>${selects}</tr>`;
  }).join('');
}

// Collect psychomotor data from the table
function collectPsychoRows(){
  return STUDENTS.map(student=>{
    const row = {};
    PSYCHO_TRAITS.forEach(trait=>{
      const sel = document.querySelector(`[data-student-id="${student.id}"][data-trait="${trait.key}"]`);
      row[trait.key] = sel ? Number(sel.value) : 3;
    });
    return {
      student_id: student.id,
      class_name: STAFF.assignedClass,
      staff_id: STAFF.id,
      term: SETTINGS.term || 'First Term',
      session: SETTINGS.session || '2024/2025',
      ...row
    };
  });
}

// Save Draft â€” saves to DB with status='draft'
async function savePsychomotor(){
  if(!STAFF.isClassTeacher){ showToast('Class teachers only.', false); return; }
  const rows = collectPsychoRows();
  const btn = document.getElementById('save-psycho-btn');
  if(btn){ btn.disabled=true; btn.textContent='Saving...'; }
  try {
    await DB.savePsychomotorBulk(rows, 'draft');
    showToast('Draft saved! Not yet submitted to Admin.');
    await DB.logActivity('Psychomotor draft saved', STAFF.assignedClass+' by '+STAFF.name, STAFF.id);
  } catch(err){
    showToast('Error saving draft: '+err.message, false);
  } finally {
    if(btn){ btn.disabled=false; btn.textContent='ğŸ’¾ Save Draft'; }
  }
}

// Submit to Admin â€” saves with status='submitted'
async function submitPsychomotor(){
  if(!STAFF.isClassTeacher){ showToast('Class teachers only.', false); return; }
  const rows = collectPsychoRows();
  const btn = document.getElementById('submit-psycho-btn');
  if(btn){ btn.disabled=true; btn.textContent='Submitting...'; }
  try {
    await DB.savePsychomotorBulk(rows, 'submitted');
    const badge = document.getElementById('psycho-submit-badge');
    badge.className = 'badge badge-blue';
    badge.textContent = 'ğŸ“¤ Submitted â€” Awaiting Approval';
    showToast('Psychomotor submitted! Admin will review and approve.');
    await DB.logActivity('Psychomotor submitted', STAFF.assignedClass+' by '+STAFF.name, STAFF.id);
  } catch(err){
    showToast('Error submitting: '+err.message, false);
  } finally {
    if(btn){ btn.disabled=false; btn.textContent='ğŸ“¤ Submit to Admin'; }
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MY STUDENTS TABLE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function renderStudents(){
  const tbody = document.getElementById('students-tbody');
  if(!tbody) return;

  if(!STUDENTS.length){
    tbody.innerHTML = `<tr><td colspan="5" style="padding:20px;color:var(--muted);">No students assigned to your class yet.</td></tr>`;
    return;
  }

  try {
    // Get all scores to compute averages
    const allScores = await DB.getAllClassScores(STAFF.assignedClass, SETTINGS.term, SETTINGS.session);

    tbody.innerHTML = STUDENTS.map(student=>{
      const studentScores = allScores.filter(sc=>sc.student_id===student.id);
      let avg = 'â€”';
      let avgNum = null;
      if(studentScores.length){
        const totals = studentScores.map(sc=>(sc.ca_score||0)+(sc.exam_score||0));
        avgNum = totals.reduce((a,b)=>a+b,0)/totals.length;
        avg = avgNum.toFixed(1)+'%';
      }
      const ac = avgNum!==null ? gradeColor(avgNum) : 'color:var(--muted)';
      const statusBadge = avgNum===null ? '<span class="badge badge-amber">â³ No Scores</span>'
        : avgNum>=70 ? '<span class="badge badge-green">On Track</span>'
        : avgNum>=50 ? '<span class="badge badge-amber">Average</span>'
        : '<span class="badge badge-red">Needs Support</span>';

      return `<tr>
        <td style="font-weight:500;">${student.name}</td>
        <td style="color:var(--muted);font-size:0.78rem;">${student.reg}</td>
        <td><span class="badge badge-purple">${STAFF.assignedClass||'â€”'}</span></td>
        <td style="${ac};font-weight:700;">${avg}</td>
        <td>${statusBadge}</td>
      </tr>`;
    }).join('');
  } catch(err){
    tbody.innerHTML = `<tr><td colspan="5" style="padding:16px;color:var(--muted);">Could not load student scores.</td></tr>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  NOTICES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function loadNotices(){
  try {
    const notices = await DB.getNotices(4);
    const el = document.getElementById('notices-container');
    if(!el) return;
    if(!notices.length){
      el.innerHTML = `<div style="color:var(--muted);font-size:0.83rem;">No notices at this time.</div>`;
      return;
    }
    const colors = { urgent:'urgent', normal:'normal', info:'info' };
    el.innerHTML = notices.map(n=>`
      <div class="notice-item">
        <div class="notice-dot ${colors[n.priority||'normal']}"></div>
        <div>
          <strong style="font-size:0.83rem;">${n.title}</strong>
          <div style="font-size:0.75rem;color:var(--muted);">${n.message||''}</div>
        </div>
      </div>`).join('');
  } catch(e){
    const el = document.getElementById('notices-container');
    if(el) el.innerHTML = `<div style="color:var(--muted);font-size:0.82rem;">Could not load notices.</div>`;
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CHANGE PASSWORD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

async function changePassword(){
  const current = document.getElementById('pw-current').value.trim();
  const newPw   = document.getElementById('pw-new').value.trim();
  const confirm = document.getElementById('pw-confirm').value.trim();
  const msgEl   = document.getElementById('pw-msg');

  const show = (msg, ok)=>{
    msgEl.textContent = msg;
    msgEl.style.background = ok ? 'var(--green-bg)' : 'var(--red-bg)';
    msgEl.style.color = ok ? 'var(--green)' : 'var(--red)';
    msgEl.style.border = '1px solid '+(ok ? 'var(--green-b)' : 'var(--red-b)');
    msgEl.style.display = 'block';
  };

  if(!current||!newPw||!confirm){ show('Please fill all fields.', false); return; }
  if(newPw!==confirm){ show('New passwords do not match.', false); return; }
  if(newPw.length<4){ show('Password must be at least 4 characters.', false); return; }

  try {
    const check = await DB.select('staff', { id: STAFF.id, password: current });
    if(!check.length){ show('Current password is incorrect.', false); return; }
    await DB.update('staff', { password: newPw }, { id: STAFF.id });
    show('âœ… Password changed successfully!', true);
    document.getElementById('pw-current').value = '';
    document.getElementById('pw-new').value = '';
    document.getElementById('pw-confirm').value = '';
  } catch(e){
    show('Error updating password. Try again.', false);
  }
}

// â”€â”€ Bfcache logout fix â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('pageshow', function(e){
  if(e.persisted){
    const user = sessionStorage.getItem('adrem_user');
    if(!user) window.location.href = 'staff-login.html';
  }
});

window.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
