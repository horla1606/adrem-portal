<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Login â€” Adrem Model Academy Portal</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<style>
  :root {
    --charcoal:#1a1626; --charcoal-2:#231d33; --muted:#9c8fa3; --white:#ffffff;
    --rose:#e8527a; --rose-deep:#c73660; --rose-light:#f7a8bf;
    --rose-bg:rgba(232,82,122,0.1); --rose-b:rgba(232,82,122,0.25);
    --purple:#7c52e8; --purple-deep:#5236c7; --purple-light:#b8a4f7;
    --purple-bg:rgba(124,82,232,0.1); --purple-b:rgba(124,82,232,0.25);
    --amber:#fbbf24; --amber-deep:#d97706; --amber-light:#fde68a;
    --amber-bg:rgba(251,191,36,0.1); --amber-b:rgba(251,191,36,0.25);
    --green:#4ade80; --green-bg:rgba(74,222,128,0.1); --green-b:rgba(74,222,128,0.25);
    --red:#f87171; --red-bg:rgba(248,113,113,0.12); --red-b:rgba(248,113,113,0.3);
  }
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:20px;position:relative;overflow:hidden;}
  body::before{content:'';position:fixed;top:-20%;left:-10%;width:600px;height:600px;background:radial-gradient(circle,rgba(232,82,122,0.12),transparent 70%);pointer-events:none;z-index:0;}
  body::after{content:'';position:fixed;bottom:-20%;right:-10%;width:500px;height:500px;background:radial-gradient(circle,rgba(124,82,232,0.1),transparent 70%);pointer-events:none;z-index:0;}
  .login-wrap{position:relative;z-index:1;display:grid;grid-template-columns:1fr 1fr;width:100%;max-width:920px;min-height:560px;border-radius:26px;overflow:hidden;box-shadow:0 32px 80px rgba(0,0,0,0.5);}
  .left-panel{padding:48px 40px;display:flex;flex-direction:column;justify-content:space-between;transition:background 0.4s,border 0.4s;}
  .left-panel.student{background:linear-gradient(145deg,rgba(232,82,122,0.22),rgba(199,54,96,0.1));border-right:1px solid var(--rose-b);}
  .left-panel.staff{background:linear-gradient(145deg,rgba(124,82,232,0.22),rgba(82,54,199,0.1));border-right:1px solid var(--purple-b);}
  .left-panel.admin{background:linear-gradient(145deg,rgba(251,191,36,0.18),rgba(217,119,6,0.08));border-right:1px solid var(--amber-b);}
  .school-logo{display:flex;align-items:center;gap:14px;margin-bottom:40px;}
  .logo-box{width:48px;height:48px;border-radius:14px;display:flex;align-items:center;justify-content:center;font-size:1.4rem;flex-shrink:0;transition:background 0.4s;}
  .logo-box.student{background:linear-gradient(135deg,var(--rose),var(--rose-deep));}
  .logo-box.staff{background:linear-gradient(135deg,var(--purple),var(--purple-deep));}
  .logo-box.admin{background:linear-gradient(135deg,var(--amber),var(--amber-deep));}
  .school-name{font-family:'Playfair Display',serif;font-size:0.88rem;font-weight:700;line-height:1.4;}
  .school-name span{display:block;font-family:'DM Sans',sans-serif;font-size:0.65rem;font-weight:400;letter-spacing:2px;text-transform:uppercase;opacity:0.6;margin-top:2px;}
  .left-main{flex:1;display:flex;flex-direction:column;justify-content:center;}
  .left-title{font-family:'Playfair Display',serif;font-size:1.7rem;font-weight:700;line-height:1.3;margin-bottom:12px;}
  .left-title.student{color:var(--rose-light);}
  .left-title.staff{color:var(--purple-light);}
  .left-title.admin{color:var(--amber-light);}
  .left-sub{font-size:0.83rem;color:var(--muted);line-height:1.7;margin-bottom:28px;}
  .info-cards{display:flex;flex-direction:column;gap:8px;}
  .info-card{display:flex;align-items:flex-start;gap:10px;padding:10px 14px;background:rgba(255,255,255,0.04);border-radius:12px;border:1px solid rgba(255,255,255,0.07);}
  .ic-icon{font-size:1rem;flex-shrink:0;margin-top:1px;}
  .ic-text{font-size:0.78rem;color:var(--muted);line-height:1.5;}
  .ic-text strong{color:var(--white);display:block;margin-bottom:1px;}
  .right-panel{background:var(--charcoal-2);padding:40px 36px;display:flex;flex-direction:column;}
  .tabs{display:flex;gap:4px;background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07);border-radius:14px;padding:4px;margin-bottom:28px;}
  .tab{flex:1;padding:8px 6px;border:none;background:none;color:var(--muted);font-family:'DM Sans',sans-serif;font-size:0.78rem;font-weight:500;border-radius:10px;cursor:pointer;transition:all 0.25s;text-align:center;}
  .tab:hover{color:var(--white);}
  .tab.active-student{background:var(--rose-bg);color:var(--rose-light);border:1px solid var(--rose-b);}
  .tab.active-staff{background:var(--purple-bg);color:var(--purple-light);border:1px solid var(--purple-b);}
  .tab.active-admin{background:var(--amber-bg);color:var(--amber-light);border:1px solid var(--amber-b);}
  .form-title{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;margin-bottom:4px;}
  .form-sub{font-size:0.78rem;color:var(--muted);margin-bottom:20px;}
  .field{margin-bottom:14px;}
  .field label{display:block;font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.2px;margin-bottom:6px;font-weight:500;}
  .field input{width:100%;padding:11px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:11px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.88rem;outline:none;transition:border 0.3s;}
  .field input:focus{background:rgba(255,255,255,0.09);}
  .field input.student:focus{border-color:var(--rose);}
  .field input.staff:focus{border-color:var(--purple);}
  .field input.admin:focus{border-color:var(--amber);}
  .field input::placeholder{color:rgba(156,143,163,0.6);}
  .pw-wrap{position:relative;}
  .pw-toggle{position:absolute;right:12px;top:50%;transform:translateY(-50%);background:none;border:none;color:var(--muted);cursor:pointer;font-size:0.85rem;padding:4px;}
  .hint-box{padding:10px 14px;border-radius:10px;font-size:0.75rem;color:var(--muted);line-height:1.6;margin-bottom:16px;}
  .hint-box.student{background:var(--rose-bg);border:1px solid var(--rose-b);}
  .hint-box.staff{background:var(--purple-bg);border:1px solid var(--purple-b);}
  .hint-box.admin{background:var(--amber-bg);border:1px solid var(--amber-b);}
  .remember-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;}
  .remember-row label{display:flex;align-items:center;gap:8px;font-size:0.78rem;color:var(--muted);cursor:pointer;}
  .forgot-link{font-size:0.75rem;color:var(--muted);cursor:pointer;text-decoration:underline;background:none;border:none;font-family:'DM Sans',sans-serif;}
  .forgot-link:hover{color:var(--white);}
  .sign-in-btn{width:100%;padding:12px;border:none;border-radius:12px;font-family:'DM Sans',sans-serif;font-size:0.9rem;font-weight:700;cursor:pointer;transition:all 0.3s;display:flex;align-items:center;justify-content:center;gap:8px;}
  .sign-in-btn.student{background:linear-gradient(135deg,var(--rose),var(--rose-deep));color:white;box-shadow:0 6px 20px rgba(232,82,122,0.4);}
  .sign-in-btn.staff{background:linear-gradient(135deg,var(--purple),var(--purple-deep));color:white;box-shadow:0 6px 20px rgba(124,82,232,0.4);}
  .sign-in-btn.admin{background:linear-gradient(135deg,var(--amber),var(--amber-deep));color:#1a1626;box-shadow:0 6px 20px rgba(251,191,36,0.4);}
  .sign-in-btn:hover{transform:translateY(-2px);filter:brightness(1.08);}
  .sign-in-btn:disabled{opacity:0.7;cursor:not-allowed;transform:none;}
  .error-box{padding:10px 14px;background:var(--red-bg);border:1px solid var(--red-b);border-radius:10px;font-size:0.78rem;color:var(--red);margin-bottom:12px;display:none;line-height:1.5;}
  .error-box.show{display:block;}
  .success-box{padding:10px 14px;background:var(--green-bg);border:1px solid var(--green-b);border-radius:10px;font-size:0.78rem;color:var(--green);margin-bottom:12px;display:none;line-height:1.5;}
  .success-box.show{display:block;}
  .spinner{width:16px;height:16px;border:2px solid rgba(255,255,255,0.3);border-top-color:white;border-radius:50%;animation:spin 0.7s linear infinite;display:none;}
  @keyframes spin{to{transform:rotate(360deg)}}
  .security-warn{padding:10px 14px;background:rgba(248,113,113,0.08);border:1px solid rgba(248,113,113,0.2);border-radius:10px;font-size:0.75rem;color:rgba(248,113,113,0.9);margin-bottom:14px;line-height:1.6;display:none;}
  .modal{position:fixed;inset:0;z-index:200;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,0.7);backdrop-filter:blur(6px);padding:20px;}
  .modal.show{display:flex;}
  .modal-card{background:#231d33;border:1px solid rgba(255,255,255,0.12);border-radius:22px;padding:32px;width:100%;max-width:440px;position:relative;animation:popIn 0.3s ease both;}
  @keyframes popIn{from{opacity:0;transform:scale(0.92)}to{opacity:1;transform:scale(1)}}
  .modal-close{position:absolute;top:14px;right:18px;background:none;border:none;color:var(--muted);font-size:1.2rem;cursor:pointer;}
  .modal-title{font-family:'Playfair Display',serif;font-size:1.1rem;margin-bottom:6px;}
  .modal-sub{font-size:0.8rem;color:var(--muted);margin-bottom:20px;line-height:1.6;}
  .step{display:flex;gap:10px;padding:10px 12px;background:rgba(255,255,255,0.04);border-radius:10px;margin-bottom:8px;font-size:0.8rem;color:var(--muted);line-height:1.5;}
  .step-num{width:20px;height:20px;border-radius:50%;background:var(--rose-bg);border:1px solid var(--rose-b);display:flex;align-items:center;justify-content:center;font-size:0.65rem;font-weight:700;color:var(--rose-light);flex-shrink:0;}
  @media(max-width:700px){.login-wrap{grid-template-columns:1fr;max-width:440px;}.left-panel{display:none;}}
</style>
</head>
<body>

<div class="login-wrap">
  <!-- LEFT PANEL -->
  <div class="left-panel student" id="left-panel">
    <div class="school-logo">
      <div class="logo-box student" id="logo-box">ğŸ’</div>
      <div class="school-name">Adrem Model Academy <span>Student &amp; Staff Portal</span></div>
    </div>
    <div class="left-main">
      <div class="left-title student" id="left-title">Welcome Back, Student</div>
      <div class="left-sub" id="left-sub">Access your results, track your performance, and stay informed about school activities.</div>
      <div class="info-cards" id="info-cards">
        <div class="info-card"><div class="ic-icon">ğŸ”</div><div class="ic-text"><strong>Login ID</strong>Your Registration Number</div></div>
        <div class="info-card"><div class="ic-icon">ğŸ”‘</div><div class="ic-text"><strong>Default Password</strong>Your Surname (first time)</div></div>
        <div class="info-card"><div class="ic-icon">ğŸ“±</div><div class="ic-text"><strong>Forgot Password?</strong>Ask your Class Teacher or Admin</div></div>
      </div>
    </div>
    <div style="font-size:0.68rem;color:var(--muted);text-align:center;">Â© 2025 Adrem Model Academy Â· Apomu, Osun State</div>
  </div>

  <!-- RIGHT PANEL -->
  <div class="right-panel">
    <div class="tabs">
      <button class="tab active-student" id="tab-student" onclick="switchTab('student')">ğŸ’ Student</button>
      <button class="tab" id="tab-staff"   onclick="switchTab('staff')">ğŸ‘©â€ğŸ« Staff</button>
      <button class="tab" id="tab-admin"   onclick="switchTab('admin')">ğŸ” Admin</button>
    </div>

    <div class="form-title" id="form-title">Student Login</div>
    <div class="form-sub"   id="form-sub">Enter your registration number and password</div>
    <div class="security-warn" id="security-warn">ğŸ”’ Authorised personnel only. All access attempts are logged.</div>
    <div class="error-box"   id="error-box"></div>
    <div class="success-box" id="success-box"></div>

    <!-- STUDENT FORM -->
    <div id="form-student">
      <div class="field">
        <label>Registration Number</label>
        <input type="text" id="s-reg" class="student" placeholder="e.g. AMA/2025/042">
      </div>
      <div class="field">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="s-pw" class="student" placeholder="Default: your surname">
          <button class="pw-toggle" onclick="togglePw('s-pw',this)" type="button">ğŸ‘ï¸</button>
        </div>
      </div>
      <div class="hint-box student">ğŸ’¡ Default password is your <strong>Surname</strong>. E.g. name is Adeyemi Aisha â†’ password is <strong>Adeyemi</strong>.</div>
    </div>

    <!-- STAFF FORM -->
    <div id="form-staff" style="display:none;">
      <div class="field">
        <label>Phone Number</label>
        <input type="text" id="t-phone" class="staff" placeholder="e.g. 08012345678">
      </div>
      <div class="field">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="t-pw" class="staff" placeholder="Default: your surname">
          <button class="pw-toggle" onclick="togglePw('t-pw',this)" type="button">ğŸ‘ï¸</button>
        </div>
      </div>
      <div class="hint-box staff">ğŸ’¡ Default password is your <strong>Surname</strong>. E.g. Mrs. Okonkwo â†’ password is <strong>Okonkwo</strong>.</div>
    </div>

    <!-- ADMIN FORM -->
    <div id="form-admin" style="display:none;">
      <div class="field">
        <label>Admin Email</label>
        <input type="email" id="a-email" class="admin" placeholder="admin@adremacademy.edu.ng">
      </div>
      <div class="field">
        <label>Password</label>
        <div class="pw-wrap">
          <input type="password" id="a-pw" class="admin" placeholder="Enter admin password">
          <button class="pw-toggle" onclick="togglePw('a-pw',this)" type="button">ğŸ‘ï¸</button>
        </div>
      </div>
      <div class="hint-box admin">ğŸ”’ Authorised personnel only. Contact your database administrator if locked out.</div>
    </div>

    <div class="remember-row">
      <label><input type="checkbox" id="remember-me" style="accent-color:var(--rose);">&nbsp;Remember me</label>
      <button class="forgot-link" onclick="openForgot()">Forgot password?</button>
    </div>

    <button class="sign-in-btn student" id="sign-in-btn" onclick="handleLogin()">
      <span id="btn-text">Sign In as Student</span>
      <div class="spinner" id="btn-spinner"></div>
    </button>

    <div style="margin-top:16px;text-align:center;font-size:0.72rem;color:var(--muted);">
      <a href="index.html" style="color:var(--muted);text-decoration:none;">â† Back to Home</a>
    </div>
  </div>
</div>

<!-- FORGOT PASSWORD MODAL -->
<div class="modal" id="forgot-modal">
  <div class="modal-card">
    <button class="modal-close" onclick="closeForgot()">âœ•</button>
    <div class="modal-title" id="forgot-title">ğŸ”‘ Forgot Password</div>
    <div class="modal-sub" id="forgot-sub">Follow these steps to reset your password:</div>
    <div id="forgot-steps"></div>
  </div>
</div>

<script>
// ================================================================
//  staff-login.html  v3.0  â€”  Adrem Model Academy
//
//  FULLY STANDALONE â€” does NOT load supabase.js.
//  Previous versions crashed because supabase.js declares:
//    const SUPABASE_URL = ...
//    const SUPABASE_KEY = ...
//  and this file was re-declaring them as const, causing a
//  SyntaxError that silently killed ALL JavaScript on the page.
//  Fix: use var (not const) for credentials here, and fetch
//  Supabase directly â€” no dependency on supabase.js at all.
// ================================================================

// â”€â”€ Credentials (var, not const â€” avoids duplicate-declaration crash) â”€â”€
var _SB_URL = 'https://ktiunkthfdjllfivnamz.supabase.co';
var _SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt0aXVua3RoZmRqbGxmaXZuYW16Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3NjMzMDUsImV4cCI6MjA4NzMzOTMwNX0.vmxUuqWKMFpIQgU9s_bEYMFIQN5_QQckpIE1iusrY-8';

// â”€â”€ Supabase query helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sbFetch(table, filters) {
  var url = _SB_URL + '/rest/v1/' + table + '?select=*';
  Object.keys(filters).forEach(function(k){
    url += '&' + k + '=eq.' + encodeURIComponent(filters[k]);
  });
  var res = await fetch(url, {
    headers: {
      'apikey':        _SB_KEY,
      'Authorization': 'Bearer ' + _SB_KEY,
      'Content-Type':  'application/json'
    }
  });
  if (!res.ok) {
    var e = await res.json().catch(function(){ return {}; });
    throw new Error(e.message || 'Database error â€” check your connection.');
  }
  return res.json();
}

// â”€â”€ Active tab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var activeTab = 'student';

// â”€â”€ Tab definitions â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var TABS = {
  student: {
    icon:'ğŸ’', title:'Welcome Back, Student',
    sub:'Access your results, track your performance, and stay up to date.',
    cards:[
      {i:'ğŸ”',s:'Login ID',t:'Your Registration Number'},
      {i:'ğŸ”‘',s:'Default Password',t:'Your Surname (first time)'},
      {i:'ğŸ“±',s:'Forgot Password?',t:'Ask your Class Teacher or Admin'}
    ],
    formTitle:'Student Login', formSub:'Enter your registration number and password',
    btn:'Sign In as Student'
  },
  staff: {
    icon:'ğŸ‘©â€ğŸ«', title:'Staff Portal',
    sub:'Manage classes, enter scores, mark attendance, submit psychomotor assessments.',
    cards:[
      {i:'ğŸ“',s:'Login ID',t:'Your Registered Phone Number'},
      {i:'ğŸ”‘',s:'Default Password',t:'Your Surname (first time)'},
      {i:'ğŸ“‹',s:'Class Teachers',t:'Access psychomotor grading'}
    ],
    formTitle:'Staff Login', formSub:'Enter your phone number and password',
    btn:'Sign In as Staff'
  },
  admin: {
    icon:'ğŸ”', title:'Admin Control Room',
    sub:'Full portal administration â€” students, staff, results, and settings.',
    cards:[
      {i:'ğŸ“§',s:'Login ID',t:'Admin Email Address'},
      {i:'ğŸ”’',s:'Security',t:'Authorised personnel only'},
      {i:'ğŸ“Š',s:'Full Access',t:'All portal data and controls'}
    ],
    formTitle:'Admin Login', formSub:'Secure access â€” authorised personnel only',
    btn:'Enter Control Room'
  }
};

// â”€â”€ switchTab â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(tab) {
  activeTab = tab;
  var cfg = TABS[tab];

  // Tabs
  ['student','staff','admin'].forEach(function(t) {
    document.getElementById('form-' + t).style.display = (t === tab) ? 'block' : 'none';
    document.getElementById('tab-'  + t).className     = (t === tab) ? 'tab active-' + t : 'tab';
  });

  // Left panel
  document.getElementById('left-panel').className    = 'left-panel '   + tab;
  document.getElementById('logo-box').className      = 'logo-box '     + tab;
  document.getElementById('left-title').className    = 'left-title '   + tab;
  document.getElementById('sign-in-btn').className   = 'sign-in-btn '  + tab;
  document.getElementById('security-warn').style.display = (tab === 'admin') ? 'block' : 'none';

  // Left panel content
  document.getElementById('logo-box').textContent   = cfg.icon;
  document.getElementById('left-title').textContent = cfg.title;
  document.getElementById('left-sub').textContent   = cfg.sub;
  document.getElementById('info-cards').innerHTML   = cfg.cards.map(function(c){
    return '<div class="info-card"><div class="ic-icon">' + c.i + '</div>'
         + '<div class="ic-text"><strong>' + c.s + '</strong>' + c.t + '</div></div>';
  }).join('');

  // Right panel labels
  document.getElementById('form-title').textContent = cfg.formTitle;
  document.getElementById('form-sub').textContent   = cfg.formSub;
  document.getElementById('btn-text').textContent   = cfg.btn;

  clearMsgs();
}

// â”€â”€ handleLogin â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function handleLogin() {
  clearMsgs();
  var btn     = document.getElementById('sign-in-btn');
  var spinner = document.getElementById('btn-spinner');
  var btnText = document.getElementById('btn-text');
  btn.disabled = true;
  spinner.style.display = 'block';
  btnText.textContent = 'Signing in...';
  try {
    var remember = document.getElementById('remember-me').checked;
    if      (activeTab === 'student') { await doStudent(remember); }
    else if (activeTab === 'staff')   { await doStaff(remember); }
    else                              { await doAdmin(remember); }
  } catch(err) {
    showErr(err.message || 'Something went wrong. Check your connection and try again.');
  } finally {
    btn.disabled = false;
    spinner.style.display = 'none';
    btnText.textContent = TABS[activeTab].btn;
  }
}

// â”€â”€ Student login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doStudent(remember) {
  var reg = document.getElementById('s-reg').value.trim();
  var pw  = document.getElementById('s-pw').value.trim();
  if (!reg) { showErr('Please enter your registration number.'); return; }
  if (!pw)  { showErr('Please enter your password.'); return; }
  var rows = await sbFetch('students', { reg: reg, password: pw });
  if (!rows.length) throw new Error('Incorrect registration number or password. Default password is your Surname.');
  var s = rows[0];
  if (s.is_active === false) throw new Error('Account deactivated. Contact your class teacher or Admin.');
  saveSession({ role:'student', id:s.id, name:s.name, reg:s.reg, class:s.class, phone:s.phone||'' }, remember);
  showOk('Welcome, ' + s.name + '! Redirecting...');
  setTimeout(function(){ window.location.href = 'student-dashboard.html'; }, 1200);
}

// â”€â”€ Staff login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doStaff(remember) {
  var phone = document.getElementById('t-phone').value.trim();
  var pw    = document.getElementById('t-pw').value.trim();
  if (!phone) { showErr('Please enter your phone number.'); return; }
  if (!pw)    { showErr('Please enter your password.'); return; }
  var rows = await sbFetch('staff', { phone: phone, password: pw });
  if (!rows.length) throw new Error('Incorrect phone number or password. Default password is your Surname.');
  var s = rows[0];
  if (s.is_active === false) throw new Error('Account deactivated. Contact Admin.');
  if (s.role === 'admin') throw new Error('Admin accounts must use the Admin tab and log in with email.');
  saveSession({
    role:'staff', id:s.id, name:s.name, phone:s.phone, email:s.email||'',
    subjects:s.subjects||'', isClassTeacher:!!s.is_class_teacher,
    assignedClass:s.assigned_class||'', teachingClasses:s.teaching_classes||s.assigned_class||''
  }, remember);
  showOk('Welcome, ' + s.name + '! Redirecting...');
  setTimeout(function(){ window.location.href = 'staff-dashboard.html'; }, 1200);
}

// â”€â”€ Admin login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function doAdmin(remember) {
  var email = document.getElementById('a-email').value.trim();
  var pw    = document.getElementById('a-pw').value.trim();
  if (!email) { showErr('Please enter your admin email.'); return; }
  if (!pw)    { showErr('Please enter your password.'); return; }

  // Step 1: find row by email only â€” diagnose missing column / wrong email
  var byEmail;
  try {
    byEmail = await sbFetch('staff', { email: email });
  } catch(colErr) {
    // email column may be missing â€” check if any admin row exists at all
    var admins = [];
    try { admins = await sbFetch('staff', { role: 'admin' }); } catch(e2) {}
    if (admins.length && Object.keys(admins[0]).indexOf('email') === -1) {
      throw new Error('The "email" column is missing from your staff table. Run the migration SQL in Supabase first. Admin found: ' + admins[0].name);
    }
    throw new Error('Database error: ' + colErr.message);
  }

  if (!byEmail.length) {
    // Email not in DB â€” show what email IS stored on the admin row
    var admins = [];
    try { admins = await sbFetch('staff', { role: 'admin' }); } catch(e) {}
    if (!admins.length) {
      throw new Error('No admin account found. Add a staff row with role="admin" and email="' + email + '" in your Supabase dashboard.');
    }
    var storedEmail = admins[0].email || '(column exists but is empty)';
    throw new Error('Email not matched. You typed: "' + email + '" but stored email is: "' + storedEmail + '". Fix the email in your Supabase staff table.');
  }

  var s = byEmail[0];

  // Step 2: check password â€” show stored vs typed if wrong
  if (s.password !== pw) {
    throw new Error('Email correct but wrong password. You typed: "' + pw + '" â€” stored password is: "' + s.password + '". Update it in Supabase or use the correct password.');
  }

  // Step 3: check role
  if (s.role !== 'admin') {
    throw new Error('Account found but role is "' + s.role + '", not "admin". Update role to "admin" in Supabase staff table.');
  }

  // Step 4: check active flag
  if (s.is_active === false) throw new Error('Admin account is deactivated. Set is_active=true in Supabase.');

  saveSession({ role:'admin', id:s.id, name:s.name, phone:s.phone||'', email:s.email }, remember);
  showOk('Access granted. Welcome, ' + s.name + '! Loading control room...');
  setTimeout(function(){ window.location.href = 'admin-dashboard.html'; }, 1200);
}

// â”€â”€ Session â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function saveSession(user, remember) {
  var d = JSON.stringify(user);
  sessionStorage.setItem('adrem_user', d);
  if (remember) { localStorage.setItem('adrem_user', d); }
  else          { localStorage.removeItem('adrem_user'); }
}
function loadSession() {
  try {
    var r = localStorage.getItem('adrem_user') || sessionStorage.getItem('adrem_user');
    return r ? JSON.parse(r) : null;
  } catch { return null; }
}

// â”€â”€ Messages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showErr(msg) {
  var e = document.getElementById('error-box');
  var s = document.getElementById('success-box');
  e.textContent = 'âŒ ' + msg; e.classList.add('show');
  s.classList.remove('show');
}
function showOk(msg) {
  var e = document.getElementById('error-box');
  var s = document.getElementById('success-box');
  s.textContent = 'âœ… ' + msg; s.classList.add('show');
  e.classList.remove('show');
}
function clearMsgs() {
  document.getElementById('error-box').classList.remove('show');
  document.getElementById('success-box').classList.remove('show');
}

// â”€â”€ Password toggle â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function togglePw(id, btn) {
  var inp = document.getElementById(id);
  if (inp.type === 'password') { inp.type = 'text';     btn.textContent = 'ğŸ™ˆ'; }
  else                         { inp.type = 'password'; btn.textContent = 'ğŸ‘ï¸'; }
}

// â”€â”€ Forgot password modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var FORGOT = {
  student:{title:'ğŸ”‘ Forgot â€” Student',sub:'Steps to reset your password:',steps:[
    {n:'1',t:'<strong>Contact your Class Teacher</strong> with your Registration Number.'},
    {n:'2',t:'Class Teacher will ask <strong>Admin</strong> to reset your password.'},
    {n:'3',t:'Admin resets it back to your <strong>Surname</strong>.'},
    {n:'4',t:'Login with your Surname, then <strong>change your password</strong> in your dashboard.'}
  ]},
  staff:{title:'ğŸ”‘ Forgot â€” Staff',sub:'Steps to reset your password:',steps:[
    {n:'1',t:'<strong>Contact the School Admin</strong> directly.'},
    {n:'2',t:'Admin verifies you by your <strong>registered phone number</strong>.'},
    {n:'3',t:'Admin resets your password to your <strong>Surname</strong>.'},
    {n:'4',t:'Login and <strong>change your password</strong> immediately.'}
  ]},
  admin:{title:'ğŸ”‘ Forgot â€” Admin',sub:'Admin reset requires external verification:',steps:[
    {n:'1',t:'<strong>Contact whoever set up the Supabase database.</strong>'},
    {n:'2',t:'Provide school name and admin email for <strong>identity verification</strong>.'},
    {n:'3',t:'New credentials issued via <strong>trusted channel</strong>.'},
    {n:'4',t:'Login with new credentials and <strong>change password immediately</strong>.'}
  ]}
};
function openForgot() {
  var c = FORGOT[activeTab];
  document.getElementById('forgot-title').textContent = c.title;
  document.getElementById('forgot-sub').textContent   = c.sub;
  document.getElementById('forgot-steps').innerHTML   = c.steps.map(function(s){
    return '<div class="step"><div class="step-num">' + s.n + '</div><div>' + s.t + '</div></div>';
  }).join('');
  document.getElementById('forgot-modal').classList.add('show');
}
function closeForgot() { document.getElementById('forgot-modal').classList.remove('show'); }
document.getElementById('forgot-modal').addEventListener('click', function(e){ if(e.target===this) closeForgot(); });

// â”€â”€ Enter key submits â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.addEventListener('keydown', function(e){ if(e.key === 'Enter') handleLogin(); });

// â”€â”€ BOOT (runs immediately â€” DOM is ready since script is at end of body) â”€â”€
(function(){
  // Redirect if already logged in
  var user = loadSession();
  if (user && user.role) {
    var map = { student:'student-dashboard.html', staff:'staff-dashboard.html', admin:'admin-dashboard.html' };
    if (map[user.role]) { window.location.href = map[user.role]; return; }
  }
  // Auto-switch tab from ?tab= URL parameter
  var tab = new URLSearchParams(window.location.search).get('tab');
  if (tab && ['student','staff','admin'].indexOf(tab) !== -1) {
    switchTab(tab);
  }
})();
</script>
</body>
</html>
