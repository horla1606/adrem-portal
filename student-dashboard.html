<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Student Dashboard ‚Äî Adrem Model Academy</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;0,700;1,400&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="supabase.js"></script>
<style>
  :root{--rose:#e8527a;--rose-deep:#c73660;--rose-light:#f7a8bf;--rose-bg:rgba(232,82,122,0.1);--rose-b:rgba(232,82,122,0.25);--amber:#fbbf24;--amber-deep:#d97706;--amber-light:#fde68a;--amber-bg:rgba(251,191,36,0.1);--amber-b:rgba(251,191,36,0.25);--purple:#7c52e8;--purple-light:#b8a4f7;--purple-bg:rgba(124,82,232,0.1);--purple-b:rgba(124,82,232,0.25);--charcoal:#1a1626;--charcoal-2:#231d33;--muted:#9c8fa3;--white:#ffffff;--glass:rgba(255,255,255,0.06);--glass-b:rgba(255,255,255,0.11);--green:#4ade80;--green-bg:rgba(74,222,128,0.1);--green-b:rgba(74,222,128,0.25);--red:#f87171;--red-bg:rgba(248,113,113,0.1);--red-b:rgba(248,113,113,0.25);--blue:#60a5fa;--blue-bg:rgba(96,165,250,0.1);--blue-b:rgba(96,165,250,0.25);}
  *,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
  body{font-family:'DM Sans',sans-serif;background:var(--charcoal);color:var(--white);min-height:100vh;display:flex;}
  .sidebar{width:250px;min-width:250px;background:var(--charcoal-2);border-right:1px solid rgba(255,255,255,0.06);display:flex;flex-direction:column;padding:24px 0;position:fixed;top:0;left:0;bottom:0;z-index:50;transition:transform 0.3s;overflow-y:auto;}
  .sidebar-logo{display:flex;align-items:center;gap:12px;padding:0 20px 24px;border-bottom:1px solid rgba(255,255,255,0.06);margin-bottom:20px;}
  .s-logo-icon{width:40px;height:40px;background:linear-gradient(135deg,var(--rose),var(--rose-deep));border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;flex-shrink:0;}
  .s-logo-text{font-family:'Playfair Display',serif;font-size:0.82rem;font-weight:700;line-height:1.3;}
  .s-logo-text span{display:block;font-family:'DM Sans',sans-serif;font-size:0.62rem;color:var(--rose-light);letter-spacing:1.5px;text-transform:uppercase;font-weight:400;}
  .nav-section{padding:0 12px;margin-bottom:6px;}
  .nav-label{font-size:0.62rem;color:var(--muted);text-transform:uppercase;letter-spacing:2px;padding:0 10px;margin-bottom:5px;}
  .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;font-weight:500;transition:all 0.2s;cursor:pointer;border:none;background:none;width:100%;text-align:left;}
  .nav-item:hover{background:rgba(255,255,255,0.05);color:var(--white);}
  .nav-item.active{background:var(--rose-bg);color:var(--rose-light);}
  .nav-item .ni{font-size:0.95rem;width:18px;text-align:center;}
  .sidebar-bottom{margin-top:auto;padding:16px 12px 0;border-top:1px solid rgba(255,255,255,0.06);}
  .logout-btn{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:10px;color:var(--muted);font-size:0.85rem;transition:all 0.2s;cursor:pointer;border:none;background:none;width:100%;}
  .logout-btn:hover{color:var(--red);background:var(--red-bg);}
  .main{margin-left:250px;flex:1;display:flex;flex-direction:column;min-height:100vh;}
  .topbar{position:sticky;top:0;z-index:40;background:rgba(26,22,38,0.97);backdrop-filter:blur(16px);border-bottom:1px solid rgba(255,255,255,0.06);padding:14px 32px;display:flex;align-items:center;justify-content:space-between;}
  .topbar-left h2{font-family:'Playfair Display',serif;font-size:1.15rem;font-weight:700;}
  .topbar-left p{font-size:0.75rem;color:var(--muted);margin-top:2px;}
  .topbar-right{display:flex;align-items:center;gap:10px;}
  .student-badge{background:var(--rose-bg);border:1px solid var(--rose-b);border-radius:50px;padding:5px 14px;font-size:0.75rem;color:var(--rose-light);}
  .student-avatar{width:36px;height:36px;background:linear-gradient(135deg,var(--rose),var(--rose-deep));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:0.82rem;font-weight:700;color:white;}
  .content{padding:28px 32px;flex:1;}
  .stat-row{display:grid;grid-template-columns:repeat(4,1fr);gap:14px;margin-bottom:24px;}
  .stat-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:16px;padding:18px;transition:all 0.3s;}
  .stat-card:hover{transform:translateY(-3px);}
  .stat-card .sc-icon{font-size:1.4rem;margin-bottom:10px;}
  .stat-card .sc-val{font-family:'Playfair Display',serif;font-size:1.5rem;font-weight:700;margin-bottom:3px;}
  .stat-card .sc-lbl{font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;}
  .stat-card.rose{border-color:var(--rose-b);background:var(--rose-bg);}.stat-card.rose .sc-val{color:var(--rose-light);}
  .stat-card.amber{border-color:var(--amber-b);background:var(--amber-bg);}.stat-card.amber .sc-val{color:var(--amber);}
  .stat-card.green{border-color:var(--green-b);background:var(--green-bg);}.stat-card.green .sc-val{color:var(--green);}
  .stat-card.blue{border-color:var(--blue-b);background:var(--blue-bg);}.stat-card.blue .sc-val{color:var(--blue);}
  .two-col{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-bottom:20px;}
  .section-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;}
  .section-card-full{background:var(--glass);border:1px solid var(--glass-b);border-radius:18px;padding:22px;margin-bottom:20px;}
  .sc-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:18px;flex-wrap:wrap;gap:10px;}
  .sc-header h3{font-family:'Playfair Display',serif;font-size:0.95rem;font-weight:700;}
  .sc-header span{font-size:0.72rem;color:var(--muted);}
  .btn{padding:8px 18px;border:none;border-radius:10px;font-family:'DM Sans',sans-serif;font-size:0.82rem;font-weight:600;cursor:pointer;transition:all 0.3s;}
  .btn:hover{transform:translateY(-2px);filter:brightness(1.1);}
  .btn-rose{background:linear-gradient(135deg,var(--rose),var(--rose-deep));color:white;box-shadow:0 4px 14px rgba(232,82,122,0.35);}
  .badge{display:inline-block;padding:3px 10px;border-radius:50px;font-size:0.7rem;font-weight:600;}
  .badge-green{background:var(--green-bg);color:var(--green);border:1px solid var(--green-b);}
  .badge-rose{background:var(--rose-bg);color:var(--rose-light);border:1px solid var(--rose-b);}
  .badge-purple{background:var(--purple-bg);color:var(--purple-light);border:1px solid var(--purple-b);}
  .perf-item{margin-bottom:12px;}
  .perf-top{display:flex;justify-content:space-between;margin-bottom:5px;font-size:0.8rem;}
  .perf-track{width:100%;height:8px;background:rgba(255,255,255,0.06);border-radius:4px;overflow:hidden;}
  .perf-fill{height:100%;border-radius:4px;transition:width 1s ease;}
  .perf-fill.rose{background:linear-gradient(90deg,var(--rose),var(--rose-deep));}
  .perf-fill.green{background:linear-gradient(90deg,#4ade80,#22c55e);}
  .perf-fill.amber{background:linear-gradient(90deg,var(--amber),var(--amber-deep));}
  .perf-fill.red{background:linear-gradient(90deg,var(--red),#ef4444);}
  .result-table{width:100%;border-collapse:collapse;}
  .result-table th{font-size:0.7rem;text-transform:uppercase;letter-spacing:1px;color:var(--muted);text-align:left;padding:0 12px 10px;font-weight:500;}
  .result-table td{padding:12px;border-top:1px solid rgba(255,255,255,0.05);font-size:0.83rem;vertical-align:middle;}
  .result-table tr:hover td{background:rgba(255,255,255,0.03);}
  .psycho-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;margin-bottom:16px;}
  .psycho-card{background:var(--glass);border:1px solid var(--glass-b);border-radius:12px;padding:14px;text-align:center;}
  .psycho-card .pt-name{font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:0.8px;margin-bottom:8px;}
  .psycho-card .pt-stars{font-size:1rem;margin-bottom:4px;}
  .psycho-card .pt-label{font-size:0.72rem;font-weight:600;}
  .notice-item{display:flex;gap:10px;padding:12px 14px;background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06);border-radius:12px;margin-bottom:8px;}
  .loading-pulse{background:rgba(255,255,255,0.06);border-radius:8px;animation:pulse 1.4s infinite;}
  @keyframes pulse{0%,100%{opacity:1}50%{opacity:0.4}}
  .field{margin-bottom:14px;}
  .field label{display:block;font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;}
  .field input{width:100%;padding:10px 14px;background:rgba(255,255,255,0.06);border:1px solid rgba(255,255,255,0.1);border-radius:10px;color:var(--white);font-family:'DM Sans',sans-serif;font-size:0.88rem;outline:none;transition:all 0.3s;}
  .field input:focus{border-color:var(--rose);}
  .menu-toggle{display:none;position:fixed;top:14px;left:14px;z-index:100;background:var(--rose);border:none;border-radius:10px;padding:7px 11px;cursor:pointer;font-size:1rem;color:white;}
  .dash-footer{padding:18px 32px;border-top:1px solid rgba(255,255,255,0.06);font-size:0.72rem;color:var(--muted);text-align:center;}
  @media print{body{background:white!important;color:#1a1626!important;display:block;}.sidebar,.topbar,.menu-toggle,.no-print,.btn{display:none!important;}.main{margin-left:0!important;}.content{padding:0!important;}.print-header{display:block!important;}.section-card,.section-card-full{background:white!important;border:1px solid #ddd!important;}*{box-shadow:none!important;}}
  @media(max-width:1000px){.stat-row{grid-template-columns:repeat(2,1fr)}.two-col{grid-template-columns:1fr}}
  @media(max-width:768px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0)}.main{margin-left:0}.menu-toggle{display:block}.topbar{padding:12px 16px 12px 56px}.content{padding:18px}}
  @media(max-width:480px){.stat-row{grid-template-columns:1fr 1fr}}
</style>
</head>
<body>
<button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo"><div class="s-logo-icon">üéí</div><div class="s-logo-text">Adrem Model Academy<span>Student Portal</span></div></div>
  <div class="nav-section"><div class="nav-label">Main</div><button class="nav-item active" onclick="showSection('dashboard',this)"><span class="ni">üè†</span> Home</button></div>
  <div class="nav-section"><div class="nav-label">Academics</div>
    <button class="nav-item" onclick="showSection('result',this)"><span class="ni">üìÑ</span> My Result</button>
    <button class="nav-item" onclick="showSection('performance',this)"><span class="ni">üìä</span> Performance</button>
    <button class="nav-item" onclick="showSection('psychomotor',this)"><span class="ni">üß†</span> Psychomotor</button>
    <button class="nav-item" onclick="showSection('attendance',this)"><span class="ni">‚úÖ</span> Attendance</button>
  </div>
  <div class="nav-section"><div class="nav-label">Account</div>
    <button class="nav-item" onclick="showSection('profile',this)"><span class="ni">üë§</span> My Profile</button>
    <button class="nav-item" onclick="showSection('password',this)"><span class="ni">üîí</span> Change Password</button>
  </div>
  <div class="sidebar-bottom"><button class="logout-btn" onclick="DB.logout()">üö™ Log Out</button></div>
</aside>
<div class="main">
  <div class="topbar">
    <div class="topbar-left"><h2 id="page-title">Student Dashboard</h2><p id="topbar-sub">Loading...</p></div>
    <div class="topbar-right"><div class="student-badge" id="topbar-badge">üéí Student</div><div class="student-avatar" id="topbar-avatar">?</div></div>
  </div>
  <div class="content">

    <!-- HOME -->
    <div id="section-dashboard">
      <div class="section-card-full" style="background:linear-gradient(135deg,rgba(232,82,122,0.15),rgba(124,82,232,0.1));border-color:var(--rose-b);margin-bottom:20px;">
        <div style="display:flex;align-items:center;gap:18px;flex-wrap:wrap;">
          <div style="width:64px;height:64px;background:linear-gradient(135deg,var(--rose),var(--rose-deep));border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:1.5rem;font-weight:700;color:white;flex-shrink:0;" id="welcome-avatar">?</div>
          <div style="flex:1;"><div style="font-family:'Playfair Display',serif;font-size:1.2rem;font-weight:700;" id="welcome-name">Loading...</div><div style="font-size:0.78rem;color:var(--muted);margin-top:3px;" id="welcome-meta"></div><div style="margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;" id="welcome-badges"></div></div>
          <div style="text-align:center;"><div style="font-family:'Playfair Display',serif;font-size:2.2rem;font-weight:700;color:var(--green);" id="welcome-avg">‚Äî</div><div style="font-size:0.72rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;">Overall Average</div></div>
        </div>
      </div>
      <div class="stat-row">
        <div class="stat-card rose"><div class="sc-icon">üìä</div><div class="sc-val" id="stat-avg">‚Äî</div><div class="sc-lbl">Overall Average</div></div>
        <div class="stat-card green"><div class="sc-icon">üìö</div><div class="sc-val" id="stat-subj">‚Äî</div><div class="sc-lbl">Subjects</div></div>
        <div class="stat-card amber"><div class="sc-icon">‚úÖ</div><div class="sc-val" id="stat-att">‚Äî</div><div class="sc-lbl">Attendance</div></div>
        <div class="stat-card blue"><div class="sc-icon">üèÖ</div><div class="sc-val" id="stat-passed">‚Äî</div><div class="sc-lbl">Subjects Passed</div></div>
      </div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(155px,1fr));gap:12px;margin-bottom:24px;">
        <button onclick="showSection('result',null)" style="background:var(--rose-bg);border:1px solid var(--rose-b);border-radius:14px;padding:18px;cursor:pointer;transition:all 0.3s;text-align:left;color:var(--white);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''"><div style="font-size:1.4rem;margin-bottom:8px;">üìÑ</div><div style="font-size:0.85rem;font-weight:600;color:var(--rose-light);">My Result</div><div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">View full report card</div></button>
        <button onclick="showSection('performance',null)" style="background:var(--purple-bg);border:1px solid var(--purple-b);border-radius:14px;padding:18px;cursor:pointer;transition:all 0.3s;text-align:left;color:var(--white);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''"><div style="font-size:1.4rem;margin-bottom:8px;">üìä</div><div style="font-size:0.85rem;font-weight:600;color:var(--purple-light);">Performance</div><div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Charts &amp; analysis</div></button>
        <button onclick="showSection('psychomotor',null)" style="background:var(--amber-bg);border:1px solid var(--amber-b);border-radius:14px;padding:18px;cursor:pointer;transition:all 0.3s;text-align:left;color:var(--white);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''"><div style="font-size:1.4rem;margin-bottom:8px;">üß†</div><div style="font-size:0.85rem;font-weight:600;color:var(--amber-light);">Psychomotor</div><div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Conduct &amp; activities</div></button>
        <button onclick="showSection('attendance',null)" style="background:var(--green-bg);border:1px solid var(--green-b);border-radius:14px;padding:18px;cursor:pointer;transition:all 0.3s;text-align:left;color:var(--white);" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''"><div style="font-size:1.4rem;margin-bottom:8px;">‚úÖ</div><div style="font-size:0.85rem;font-weight:600;color:var(--green);">Attendance</div><div style="font-size:0.72rem;color:var(--muted);margin-top:3px;">Your record</div></button>
      </div>
      <div class="two-col">
        <div class="section-card"><div class="sc-header"><h3>üìö Subject Snapshot</h3><span id="snap-term"></span></div><div id="subject-snapshot"><div class="loading-pulse" style="height:120px;"></div></div></div>
        <div class="section-card"><div class="sc-header"><h3>üì¢ School Notices</h3></div><div id="notices-list"><div class="loading-pulse" style="height:120px;"></div></div></div>
      </div>
    </div>

    <!-- RESULT -->
    <div id="section-result" style="display:none;">
      <div class="print-header" style="display:none;text-align:center;margin-bottom:20px;padding-bottom:14px;border-bottom:2px solid #e8527a;">
        <h2 style="font-family:'Playfair Display',serif;font-size:1.3rem;color:#1a1626;">Adrem Model Academy</h2>
        <p style="color:#6b7280;font-size:0.82rem;">Apomu, Osun State ¬∑ Tel: +234 701 518 2166</p>
        <h3 id="print-term-title" style="font-family:'Playfair Display',serif;margin-top:10px;color:#c73660;font-size:1rem;">STUDENT RESULT SHEET</h3>
      </div>
      <div class="section-card-full">
        <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
          <div><div style="font-family:'Playfair Display',serif;font-size:1.1rem;font-weight:700;" id="result-student-name">‚Äî</div><div style="font-size:0.78rem;color:var(--muted);margin-top:3px;" id="result-student-meta">‚Äî</div></div>
          <div class="no-print"><button class="btn btn-rose" onclick="window.print()">üñ®Ô∏è Print Result</button></div>
        </div>
      </div>
      <div class="section-card-full">
        <div class="sc-header"><h3 id="result-table-title">üìÑ Academic Result</h3><span>A=Excellent(70+) ¬∑ P=Pass(40‚Äì69) ¬∑ F=Fail(0‚Äì39)</span></div>
        <div id="result-not-published" style="display:none;padding:32px;text-align:center;color:var(--muted);"><div style="font-size:2.5rem;margin-bottom:14px;">‚è≥</div><div>Results have not been published yet. Please check back later.</div></div>
        <div id="result-table-wrap" style="overflow-x:auto;">
          <table class="result-table"><thead><tr><th>Subject</th><th>CA (30)</th><th>Exam (70)</th><th>Total</th><th>Grade</th><th>Remark</th></tr></thead><tbody id="result-tbody"><tr><td colspan="6"><div class="loading-pulse" style="height:120px;margin:8px 0;"></div></td></tr></tbody><tfoot id="result-tfoot"></tfoot></table>
        </div>
      </div>
      <div class="section-card-full" id="result-psycho-section"><div class="sc-header"><h3>üß† Psychomotor & Affective Assessment</h3><span>Approved by Admin</span></div><div class="psycho-grid" id="result-psycho-grid"></div></div>
      <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;" id="result-summary-cards"></div>
    </div>

    <!-- PERFORMANCE -->
    <div id="section-performance" style="display:none;">
      <div class="two-col">
        <div class="section-card"><div class="sc-header"><h3>üìä CA vs Exam</h3></div><div id="perf-ca-exam"><div class="loading-pulse" style="height:200px;"></div></div></div>
        <div class="section-card"><div class="sc-header"><h3>üìà Subject Rankings</h3></div><div id="perf-rankings"></div></div>
      </div>
      <div class="two-col">
        <div class="section-card"><div class="sc-header"><h3>üí™ Strengths</h3><span>Above 75%</span></div><div id="perf-strong"></div></div>
        <div class="section-card"><div class="sc-header"><h3>‚ö†Ô∏è Needs Improvement</h3><span>Below 60%</span></div><div id="perf-weak"></div></div>
      </div>
      <div class="section-card-full"><div class="sc-header"><h3>üí° Personalised Advice</h3></div><div id="perf-advice"></div></div>
    </div>

    <!-- PSYCHOMOTOR -->
    <div id="section-psychomotor" style="display:none;">
      <div class="section-card-full">
        <div class="sc-header"><h3>üß† Psychomotor & Affective Assessment</h3><span>Graded by Class Teacher ¬∑ Approved by Admin</span></div>
        <div style="background:rgba(232,82,122,0.07);border:1px solid rgba(232,82,122,0.18);border-radius:12px;padding:14px 16px;margin-bottom:18px;font-size:0.82rem;color:var(--muted);line-height:1.7;">These grades reflect your <strong style="color:var(--white);">behaviour, participation, and character</strong> as assessed by your Class Teacher.</div>
        <div class="psycho-grid" id="psycho-student-grid"><div class="loading-pulse" style="height:160px;"></div></div>
        <div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;font-size:0.78rem;color:var(--muted);line-height:1.8;margin-top:8px;"><strong style="color:var(--rose-light);display:block;margin-bottom:6px;">Rating Scale</strong><span style="color:var(--green);">5=Excellent</span> ¬∑ <span style="color:var(--blue);">4=Very Good</span> ¬∑ <span style="color:var(--amber);">3=Good</span> ¬∑ <span style="color:var(--rose-light);">2=Fair</span> ¬∑ <span style="color:var(--red);">1=Poor</span></div>
      </div>
    </div>

    <!-- ATTENDANCE -->
    <div id="section-attendance" style="display:none;">
      <div class="stat-row">
        <div class="stat-card green"><div class="sc-icon">‚úÖ</div><div class="sc-val" id="att-present">‚Äî</div><div class="sc-lbl">Days Present</div></div>
        <div class="stat-card" style="border-color:var(--red-b);background:var(--red-bg);"><div class="sc-icon">‚ùå</div><div class="sc-val" id="att-absent" style="color:var(--red);">‚Äî</div><div class="sc-lbl">Days Absent</div></div>
        <div class="stat-card rose"><div class="sc-icon">üìä</div><div class="sc-val" id="att-rate">‚Äî</div><div class="sc-lbl">Attendance Rate</div></div>
        <div class="stat-card blue"><div class="sc-icon">üìÖ</div><div class="sc-val" id="att-total">‚Äî</div><div class="sc-lbl">Total Days</div></div>
      </div>
      <div class="section-card-full"><div class="sc-header"><h3>üìÖ Attendance Record</h3><span id="att-term-label"></span></div><div id="att-calendar" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(88px,1fr));gap:8px;"><div class="loading-pulse" style="height:100px;grid-column:1/-1;"></div></div></div>
    </div>

    <!-- PROFILE -->
    <div id="section-profile" style="display:none;">
      <div class="two-col">
        <div class="section-card"><div class="sc-header"><h3>üë§ Personal Information</h3></div><div style="display:flex;flex-direction:column;gap:12px;" id="profile-fields"><div class="loading-pulse" style="height:160px;"></div></div></div>
        <div class="section-card"><div class="sc-header"><h3>üìä Quick Stats</h3></div><div style="display:flex;flex-direction:column;gap:12px;" id="profile-stats"><div class="loading-pulse" style="height:160px;"></div></div><div style="margin-top:14px;padding:12px;background:rgba(251,191,36,0.07);border:1px solid rgba(251,191,36,0.18);border-radius:10px;font-size:0.78rem;color:var(--muted);">‚ö†Ô∏è To update personal details, contact the School Admin or your Class Teacher.</div></div>
      </div>
    </div>

    <!-- PASSWORD -->
    <div id="section-password" style="display:none;">
      <div class="section-card" style="max-width:480px;">
        <div class="sc-header"><h3>üîí Change Password</h3></div>
        <div style="background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;padding:12px 14px;margin-bottom:16px;font-size:0.78rem;color:var(--muted);line-height:1.7;">üí° Your default password is your <strong style="color:var(--white);">Surname</strong>.</div>
        <div class="field"><label>Current Password</label><input type="password" id="pw-current" placeholder="Current password"></div>
        <div class="field"><label>New Password</label><input type="password" id="pw-new" placeholder="New password"></div>
        <div class="field"><label>Confirm New Password</label><input type="password" id="pw-confirm" placeholder="Repeat new password"></div>
        <div id="pw-msg" style="padding:10px 14px;border-radius:8px;font-size:0.78rem;margin-bottom:12px;display:none;"></div>
        <button class="btn btn-rose" style="width:100%;" onclick="changePassword()">üîí Update Password</button>
      </div>
    </div>

  </div>
  <div class="dash-footer">¬© 2026 Adrem Model Academy Student Portal ‚Äî Apomu, Osun State</div>
</div>
<div id="toast" style="position:fixed;bottom:28px;right:28px;background:#231d33;border:1px solid rgba(232,82,122,0.3);border-radius:12px;padding:12px 18px;font-size:0.83rem;color:var(--white);z-index:500;opacity:0;transform:translateY(10px);transition:all 0.3s;pointer-events:none;max-width:300px;"></div>

<script>
let USER=null,SCORES=[],SETTINGS={},PSYCHO=null,ATTENDANCE=[];

function jssGrade(t){return t>=70?'A':t>=40?'P':'F';}
function jssRemark(t){return t>=70?'Excellent':t>=40?'Pass':'Fail';}
function gradeColor(t){return t>=70?'var(--green)':t>=40?'var(--amber)':'var(--red)';}
function ratingLabel(r){return r===5?'Excellent':r===4?'Very Good':r===3?'Good':r===2?'Fair':'Poor';}
function ratingColor(r){return r===5?'var(--green)':r===4?'var(--blue)':r===3?'var(--amber)':r===2?'var(--rose-light)':'var(--red)';}
function stars(r){return'‚òÖ'.repeat(r)+'‚òÜ'.repeat(5-r);}
function initials(name){return name.split(' ').map(w=>w[0]).join('').substring(0,2).toUpperCase();}
function pInfo(label,val,color){return`<div style="padding:12px 14px;background:var(--glass);border:1px solid var(--glass-b);border-radius:10px;"><div style="font-size:0.68rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:4px;">${label}</div><div style="font-size:0.88rem;font-weight:500;color:${color||'var(--white)'};">${val}</div></div>`;}
function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');}
function showToast(msg,type){const t=document.getElementById('toast');t.textContent=(type==='error'?'‚ùå ':'‚úÖ ')+msg;t.style.opacity='1';t.style.transform='translateY(0)';setTimeout(()=>{t.style.opacity='0';t.style.transform='translateY(10px)';},3200);}

const allSecs=['dashboard','result','performance','psychomotor','attendance','profile','password'];
const titles={dashboard:'Student Dashboard',result:'My Result',performance:'My Performance',psychomotor:'Psychomotor Assessment',attendance:'My Attendance',profile:'My Profile',password:'Change Password'};
function showSection(name,el){
  allSecs.forEach(s=>{const e=document.getElementById('section-'+s);if(e)e.style.display=s===name?'block':'none';});
  document.querySelectorAll('.nav-item').forEach(n=>n.classList.remove('active'));
  if(el)el.classList.add('active');
  else document.querySelectorAll('.nav-item').forEach(n=>{if(n.getAttribute('onclick')&&n.getAttribute('onclick').includes("'"+name+"'"))n.classList.add('active');});
  document.getElementById('page-title').textContent=titles[name]||name;
}

async function init(){
  USER=DB.requireAuth('student');
  if(!USER)return;
  const inits=initials(USER.name);
  document.getElementById('topbar-avatar').textContent=inits;
  document.getElementById('topbar-badge').textContent='üéí '+(USER.class||'Student');
  document.getElementById('welcome-avatar').textContent=inits;
  document.getElementById('welcome-name').textContent=USER.name;
  try{
    const[settings,scores,psychoRes,attendance]=await Promise.all([
      DB.getSettings(),
      DB.select('scores',{student_id:USER.id}),
      DB.selectRaw('psychomotor','student_id=eq.'+USER.id+'&status=eq.approved'),
      DB.select('attendance',{student_id:USER.id},'*','date.asc'),
    ]);
    SETTINGS=settings;SCORES=scores;PSYCHO=psychoRes[0]||null;ATTENDANCE=attendance;
    const termLabel=(SETTINGS.term||'First Term')+' '+(SETTINGS.session||'2024/2025');
    document.getElementById('topbar-sub').textContent=termLabel;
    document.getElementById('snap-term').textContent=SETTINGS.term||'First Term';
    document.getElementById('att-term-label').textContent=termLabel;
    document.getElementById('print-term-title').textContent='STUDENT RESULT SHEET ‚Äî '+termLabel.toUpperCase();
    document.getElementById('result-table-title').textContent='üìÑ Academic Result ‚Äî '+termLabel;
    document.getElementById('welcome-meta').textContent=USER.reg+' ¬∑ '+USER.class+' ¬∑ '+termLabel;
    document.getElementById('welcome-badges').innerHTML=`<span class="badge badge-rose">üéí ${USER.class}</span><span class="badge badge-green">üìä ${SETTINGS.term||'First Term'}</span>`;
    const totals=SCORES.map(s=>(s.ca_score||0)+(s.exam_score||0));
    const avg=totals.length?(totals.reduce((a,b)=>a+b,0)/totals.length).toFixed(1):null;
    const passed=SCORES.filter(s=>(s.ca_score||0)+(s.exam_score||0)>=40).length;
    const presentDays=ATTENDANCE.filter(a=>a.status==='present').length;
    const attRate=ATTENDANCE.length?Math.round(presentDays/ATTENDANCE.length*100)+'%':'‚Äî';
    document.getElementById('welcome-avg').textContent=avg?avg+'%':'‚Äî';
    document.getElementById('stat-avg').textContent=avg?avg+'%':'‚Äî';
    document.getElementById('stat-subj').textContent=SCORES.length;
    document.getElementById('stat-att').textContent=attRate;
    document.getElementById('stat-passed').textContent=passed+'/'+SCORES.length;
    renderSubjectSnapshot();renderAttendance();renderResult();renderPerformance();renderPsychomotorSections();renderProfile();loadNotices();
  }catch(err){console.error(err);showToast('Error loading data. Please refresh.','error');}
}

function renderSubjectSnapshot(){
  const el=document.getElementById('subject-snapshot');
  if(!SCORES.length){el.innerHTML='<div style="color:var(--muted);font-size:0.83rem;padding:12px 0;">No scores entered yet for this term.</div>';return;}
  const sorted=[...SCORES].sort((a,b)=>((b.ca_score||0)+(b.exam_score||0))-((a.ca_score||0)+(a.exam_score||0))).slice(0,5);
  el.innerHTML=sorted.map(s=>{const total=(s.ca_score||0)+(s.exam_score||0);const fc=total>=70?'green':total>=40?'amber':'red';return`<div class="perf-item"><div class="perf-top"><span>${s.subject}</span><strong style="color:${gradeColor(total)}">${total}%</strong></div><div class="perf-track"><div class="perf-fill ${fc}" style="width:${total}%"></div></div></div>`;}).join('');
}

function renderResult(){
  const tbody=document.getElementById('result-tbody');const tfoot=document.getElementById('result-tfoot');
  if(!SETTINGS.results_published){document.getElementById('result-not-published').style.display='block';document.getElementById('result-table-wrap').style.display='none';document.getElementById('result-psycho-section').style.display='none';document.getElementById('result-summary-cards').innerHTML='';return;}
  document.getElementById('result-student-name').textContent=USER.name;
  document.getElementById('result-student-meta').textContent='Reg: '+USER.reg+' ¬∑ Class: '+USER.class+' ¬∑ '+(SETTINGS.term||'')+' '+(SETTINGS.session||'');
  if(!SCORES.length){tbody.innerHTML='<tr><td colspan="6" style="color:var(--muted);padding:20px;">No scores found.</td></tr>';return;}
  let tCA=0,tExam=0;
  tbody.innerHTML=SCORES.map(s=>{const ca=s.ca_score||0,ex=s.exam_score||0,total=ca+ex;tCA+=ca;tExam+=ex;return`<tr><td style="font-weight:500;">${s.subject}</td><td style="text-align:center;">${ca}<span style="color:var(--muted);font-size:0.72rem;">/30</span></td><td style="text-align:center;">${ex}<span style="color:var(--muted);font-size:0.72rem;">/70</span></td><td style="text-align:center;font-weight:700;">${total}</td><td style="text-align:center;font-weight:700;color:${gradeColor(total)};">${jssGrade(total)}</td><td style="color:${gradeColor(total)};font-size:0.82rem;">${jssRemark(total)}</td></tr>`;}).join('');
  const gt=tCA+tExam;const avg=(gt/SCORES.length).toFixed(1);
  tfoot.innerHTML=`<tr style="background:rgba(232,82,122,0.08);"><td style="font-weight:700;border-top:2px solid rgba(232,82,122,0.3);">TOTAL/AVERAGE</td><td style="text-align:center;font-weight:700;border-top:2px solid rgba(232,82,122,0.3);">${tCA}</td><td style="text-align:center;font-weight:700;border-top:2px solid rgba(232,82,122,0.3);">${tExam}</td><td style="text-align:center;font-weight:700;color:var(--rose-light);border-top:2px solid rgba(232,82,122,0.3);">${gt}</td><td style="text-align:center;font-weight:700;color:var(--green);border-top:2px solid rgba(232,82,122,0.3);">${jssGrade(parseFloat(avg))}</td><td style="font-weight:700;color:var(--rose-light);border-top:2px solid rgba(232,82,122,0.3);">Avg: ${avg}%</td></tr>`;
  renderPsychomotorGrid('result-psycho-grid');
  const passed=SCORES.filter(s=>(s.ca_score||0)+(s.exam_score||0)>=40).length;
  document.getElementById('result-summary-cards').innerHTML=`<div style="background:var(--rose-bg);border:1px solid var(--rose-b);border-radius:14px;padding:16px;text-align:center;"><div style="font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Overall Average</div><div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--rose-light);">${avg}%</div></div><div style="background:var(--amber-bg);border:1px solid var(--amber-b);border-radius:14px;padding:16px;text-align:center;"><div style="font-size:0.7rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;">Subjects Passed</div><div style="font-family:'Playfair Display',serif;font-size:1.8rem;font-weight:700;color:var(--amber);">${passed}/${SCORES.length}</div></div>`;
}

function renderPsychomotorGrid(targetId){
  const el=document.getElementById(targetId);if(!el)return;
  const traits=['punctuality','attentiveness','neatness','politeness','honesty','sports','clubs','creativity','leadership','conduct'];
  const labels={punctuality:'Punctuality',attentiveness:'Attentiveness',neatness:'Neatness',politeness:'Politeness',honesty:'Honesty',sports:'Sports/Games',clubs:'Clubs/Societies',creativity:'Creativity',leadership:'Leadership',conduct:'Overall Conduct'};
  if(!PSYCHO){el.innerHTML='<div style="color:var(--muted);font-size:0.83rem;grid-column:1/-1;padding:12px 0;">Psychomotor assessment not yet available. Check back after Admin approves.</div>';return;}
  el.innerHTML=traits.map(t=>{const r=PSYCHO[t]||3;return`<div class="psycho-card"><div class="pt-name">${labels[t]}</div><div class="pt-stars" style="color:${ratingColor(r)};">${stars(r)}</div><div class="pt-label" style="color:${ratingColor(r)};">${ratingLabel(r)}</div></div>`;}).join('');
}

function renderPsychomotorSections(){renderPsychomotorGrid('psycho-student-grid');}

function renderPerformance(){
  if(!SCORES.length){document.getElementById('perf-ca-exam').innerHTML='<div style="color:var(--muted);font-size:0.83rem;">No scores available yet.</div>';return;}
  document.getElementById('perf-ca-exam').innerHTML=SCORES.map(s=>{const caP=((s.ca_score||0)/30*100).toFixed(0);const exP=((s.exam_score||0)/70*100).toFixed(0);return`<div style="margin-bottom:12px;"><div style="display:flex;justify-content:space-between;font-size:0.78rem;margin-bottom:4px;"><span>${s.subject}</span><span style="color:var(--muted);">CA:${s.ca_score||0} / Exam:${s.exam_score||0}</span></div><div style="display:flex;height:8px;border-radius:4px;overflow:hidden;gap:1px;"><div style="width:${caP/2}%;background:linear-gradient(90deg,var(--purple),rgba(124,82,232,0.7));border-radius:4px 0 0 4px;"></div><div style="width:${exP/2}%;background:linear-gradient(90deg,var(--rose),rgba(232,82,122,0.7));border-radius:0 4px 4px 0;"></div></div></div>`;}).join('');
  const sorted=[...SCORES].sort((a,b)=>((b.ca_score||0)+(b.exam_score||0))-((a.ca_score||0)+(a.exam_score||0)));
  document.getElementById('perf-rankings').innerHTML=sorted.map((s,i)=>{const total=(s.ca_score||0)+(s.exam_score||0);const fc=total>=70?'green':total>=40?'amber':'red';return`<div class="perf-item"><div class="perf-top"><span>${i+1}. ${s.subject}</span><strong style="color:${gradeColor(total)}">${total}%</strong></div><div class="perf-track"><div class="perf-fill ${fc}" style="width:${total}%"></div></div></div>`;}).join('');
  let sH='',wH='';
  SCORES.forEach(s=>{const total=(s.ca_score||0)+(s.exam_score||0);const fc=total>=70?'green':'red';const bar=`<div class="perf-item"><div class="perf-top"><span>${s.subject}</span><strong style="color:${gradeColor(total)}">${total}%</strong></div><div class="perf-track"><div class="perf-fill ${fc}" style="width:${total}%"></div></div></div>`;if(total>=75)sH+=bar;else if(total<60)wH+=bar;});
  document.getElementById('perf-strong').innerHTML=sH||'<div style="color:var(--muted);font-size:0.82rem;">Aim for above 75% in each subject!</div>';
  document.getElementById('perf-weak').innerHTML=wH||'<div style="color:var(--green);font-size:0.82rem;">No subjects below 60% ‚Äî well done!</div>';
  const avgAll=(SCORES.reduce((a,s)=>a+(s.ca_score||0)+(s.exam_score||0),0)/SCORES.length).toFixed(1);
  const weak=SCORES.filter(s=>(s.ca_score||0)+(s.exam_score||0)<60).map(s=>s.subject);
  document.getElementById('perf-advice').innerHTML=`<div style="display:flex;flex-direction:column;gap:10px;"><div style="padding:14px 16px;background:${parseFloat(avgAll)>=70?'var(--green-bg)':'var(--amber-bg)'};border:1px solid ${parseFloat(avgAll)>=70?'var(--green-b)':'var(--amber-b)'};border-radius:12px;font-size:0.83rem;line-height:1.7;">${parseFloat(avgAll)>=70?'üèÜ <strong style="color:var(--green)">Excellent!</strong> Your average of '+avgAll+'% shows strong dedication.':'üìö <strong style="color:var(--amber)">Good effort!</strong> Average is '+avgAll+'%. Keep studying consistently.'}</div>${weak.length?`<div style="padding:14px 16px;background:var(--amber-bg);border:1px solid var(--amber-b);border-radius:12px;font-size:0.83rem;line-height:1.7;">‚ö†Ô∏è <strong style="color:var(--amber)">Focus areas:</strong> Give extra attention to <strong>${weak.join(', ')}</strong>.</div>`:''}`;
}

function renderAttendance(){
  const present=ATTENDANCE.filter(a=>a.status==='present').length;
  const absent=ATTENDANCE.filter(a=>a.status==='absent').length;
  const total=ATTENDANCE.length;
  document.getElementById('att-present').textContent=present||'‚Äî';
  document.getElementById('att-absent').textContent=absent||'‚Äî';
  document.getElementById('att-rate').textContent=total?Math.round(present/total*100)+'%':'‚Äî';
  document.getElementById('att-total').textContent=total||'‚Äî';
  if(!total){document.getElementById('att-calendar').innerHTML='<div style="color:var(--muted);font-size:0.83rem;grid-column:1/-1;">No attendance records found yet.</div>';return;}
  const days=['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  document.getElementById('att-calendar').innerHTML=ATTENDANCE.map(a=>{const d=new Date(a.date);const ip=a.status==='present';return`<div style="padding:8px;border-radius:8px;text-align:center;background:${ip?'rgba(74,222,128,0.1)':'rgba(248,113,113,0.1)'};border:1px solid ${ip?'rgba(74,222,128,0.25)':'rgba(248,113,113,0.25)'};font-size:0.7rem;"><div style="color:${ip?'var(--green)':'var(--red)'};font-weight:600;">${ip?'‚úÖ':'‚ùå'}</div><div style="color:var(--muted);margin-top:2px;">${d.getDate()}/${d.getMonth()+1}</div><div style="color:var(--muted);font-size:0.65rem;">${days[d.getDay()]}</div></div>`;}).join('');
}

function renderProfile(){
  document.getElementById('profile-fields').innerHTML=pInfo('Full Name',USER.name)+pInfo('Registration Number',USER.reg,'var(--rose-light)')+pInfo('Class',USER.class+' ¬∑ '+(SETTINGS.session||''))+pInfo('Current Term',SETTINGS.term||'‚Äî');
  const totals=SCORES.map(s=>(s.ca_score||0)+(s.exam_score||0));
  const avg=totals.length?(totals.reduce((a,b)=>a+b,0)/totals.length).toFixed(1)+'%':'‚Äî';
  const attRate=ATTENDANCE.length?Math.round(ATTENDANCE.filter(a=>a.status==='present').length/ATTENDANCE.length*100)+'%':'‚Äî';
  document.getElementById('profile-stats').innerHTML=pInfo('Overall Average',avg,'var(--rose-light)')+pInfo('Attendance',attRate,'var(--blue)')+pInfo('Subjects Enrolled',SCORES.length+' subjects','var(--amber)');
}

async function loadNotices(){
  try{
    const notices=await DB.selectRaw('notices','order=created_at.desc&limit=4');
    const el=document.getElementById('notices-list');
    if(!notices.length){el.innerHTML='<div style="color:var(--muted);font-size:0.83rem;">No notices at this time.</div>';return;}
    const colors={urgent:'var(--red)',normal:'var(--rose-light)',info:'var(--blue)'};
    el.innerHTML=notices.map(n=>`<div class="notice-item"><div style="width:8px;height:8px;border-radius:50%;background:${colors[n.priority||'normal']};flex-shrink:0;margin-top:6px;"></div><div><strong style="font-size:0.83rem;">${n.title}</strong><div style="font-size:0.75rem;color:var(--muted);">${n.message||''}</div></div></div>`).join('');
  }catch(e){document.getElementById('notices-list').innerHTML='<div style="color:var(--muted);font-size:0.82rem;">Could not load notices.</div>';}
}

async function changePassword(){
  const current=document.getElementById('pw-current').value.trim();
  const newPw=document.getElementById('pw-new').value.trim();
  const confirm=document.getElementById('pw-confirm').value.trim();
  const msgEl=document.getElementById('pw-msg');
  const show=(msg,ok)=>{msgEl.textContent=msg;msgEl.style.background=ok?'var(--green-bg)':'var(--red-bg)';msgEl.style.color=ok?'var(--green)':'var(--red)';msgEl.style.border='1px solid '+(ok?'var(--green-b)':'var(--red-b)');msgEl.style.display='block';};
  if(!current||!newPw||!confirm){show('Please fill all fields.',false);return;}
  if(newPw!==confirm){show('New passwords do not match.',false);return;}
  if(newPw.length<4){show('Password must be at least 4 characters.',false);return;}
  try{
    const check=await DB.select('students',{id:USER.id,password:current});
    if(!check.length){show('Current password is incorrect.',false);return;}
    await DB.update('students',{password:newPw},{id:USER.id});
    show('‚úÖ Password changed successfully!',true);
    document.getElementById('pw-current').value='';document.getElementById('pw-new').value='';document.getElementById('pw-confirm').value='';
  }catch(e){show('Error updating. Try again.',false);}
}

window.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>
